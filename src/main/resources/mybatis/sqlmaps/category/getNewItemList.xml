<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.x62life.mo.dao.category.CategoryDao">
<!--    'System        : m.62life.com-->
<!--    'Program       :-->
<!--    'Title         : 자연이랑모바일 - 상품 페이지 단위로 가져오기-->
<!--    'File          : get_new_list_m.asp-->
<!--    'Program Type  : asp-->
<!--    'Analyst       :-->
<!--    'Author        : hwkim-->
<!--    'Date Started  : 20161118-->
<!--    'Last Modified :-->
<!--    'Called By     :-->
<!--    'Parameters    :-->
<!--    'Purpose       :-->
<!--    'Version       :-->
<!--    '-->
<!--    'Modified   Author  V/M     Reason For Modification-->
<!--    '20161118   hwkim   0.9     처음 작성-->
<!--    '20170202   hwkim   0.9.1   업체 직배송 상품 담기 적용-->
<!--    '20170213   hwkim   0.9.2   옵션 상품 표시 제외 처리-->
<!--    '20170329   hwkim   0.9.3   할인 가격 표시 변경-->
<!--    '20170420   hwkim   0.9.4   당일발송 주문 담기 처리 추가. / thedaysyn-->
<!--    '20170613   hwkim   0.9.5   당일발송 주문 담기 처리 제외 (1차범위)-->
<!--    '20180114   hwkim   0.9.6   상품표시 레이아웃 개선-->
<!--    '20180621   hyeok   -&#45;&#45;     표시대상 상품 조건에 세트유형(20) 추가-->
<!--    '20180803   hwkim   0.9.7   상품등급 라벨 표시, 할인율 사각형스티커 변경 등-->
<!--    '20200324   sykim   0.9.8   상품정보 단일화(gd_master & od_reservegoods > gd_master) 적용.-->
    <select id="getNewItemListPaging" parameterType="java.util.Map" resultType="java.util.Map">
        /* getNewItemListPaging 페이징 */
        SELECT CEILING( CAST(COUNT(1) AS FLOAT)/ #{intPagePerItem} ) maxPage
             , COUNT(gdcd) CNT
        FROM (
                 SELECT g.gdcd
                 FROM gd_master g
                   LEFT JOIN gd_item i
                          ON i.gdcd = g.gdcd
                   LEFT JOIN cd_master t
                          ON t.cdtype = '09'
                         AND t.cdcode = i.typecd
                   LEFT JOIN od_reservegoods r
                          ON g.gdcd = r.gdcd
                                              AND r.useyn = 'Y'
                                             <![CDATA[
                                              AND DATEDIFF(D,CONVERT(DATETIME,r.od_from,120),GETDATE()) >= 0
                                              AND DATEDIFF(D,GETDATE(),CONVERT(DATETIME,r.od_to,120)) >= 0
                                             ]]>
                  WHERE 1=1
                    AND g.useyn = 'Y'
                    AND (g.reserveyn = 'N' OR (g.reserveyn = 'Y' AND r.gdcd IS NOT NULL))
                    AND (g.divcd = '30' OR ( g.divcd='20'
                                             AND g.deliverydtyn = 'N'
                                             AND g.gdcd NOT IN ('A3','A4','A7','A8','B2','B3','C3','G9','H6','H9','P9','R6','R9','T1','T2','T3','Z02','Z21','Z22','Z25','Z26','Z94')
                                           )
                        )
                    AND g.newyn = 'Y'
                    AND (g.reserveyn = 'N' OR (g.reserveyn = 'Y' AND r.gdcd IS NOT NULL))
             ) x
    </select>

    <select id="getNewItemListStatistics" parameterType="java.util.Map" resultType="gdMasterEx">
        /* getNewItemListStatistics 지표 추출*/
        SELECT *
        FROM (
                 SELECT FLOOR((ROW_NUMBER() OVER ( ORDER BY newyn, ISNULL(updt, indt) DESC ) - 1) / #{intPagePerItem} + 1) AS page
                      , x.*
                 FROM (
                          SELECT g.gdcd
                               , g.gdname
                               , g.unit
                               , g.price1
                               , g.gdimg
                               , g.mgdimg1
                               , g.divcd
                               , g.div1
                               , g.indt
                               , g.updt
                               , g.shortdesc
                               , dbo.getProductPrice(#{strMEMGRPCD}, #{strGroupSalePolicy}, g.gdcd) saleprice
                               , ISNULL(g.soldoutyn,'N') soldoutyn, ISNULL(s.gdcnt,99999) gdcnt
                               , ISNULL(g.newyn,'N') newyn, ISNULL(g.qtysaleyn,'N') qtysaleyn
                               , g.recommendyn
                               , i.origin
                               , i.producer
                               , i.address
                               , ISNULL(t.cdname,'미지정') AS gradedesc
                               , g.thedaysyn
                               , CASE g.dispatchtype WHEN 'I' THEN '11' WHEN 'O' THEN '15' END odtype
                               , ISNULL(g.deliverydtyn,'N') deliverydtyn
                               , ISNULL(g.reserveyn,'N') reserveyn
                          FROM gd_master g
                            LEFT JOIN gd_item i ON i.gdcd = g.gdcd
                            LEFT JOIN cd_master t ON t.cdtype = '09'
                                                 AND t.cdcode = i.typecd
                            LEFT JOIN gd_cnt s ON g.gdcd = s.gdcd
                            LEFT JOIN od_reservegoods r ON g.gdcd = r.gdcd
                                                       AND r.useyn = 'Y'
                                                       <![CDATA[
                                                       AND DATEDIFF(D,CONVERT(DATETIME,r.od_from,120),GETDATE()) >= 0
                                                       AND DATEDIFF(D,GETDATE(),CONVERT(DATETIME,r.od_to,120)) >= 0
                                                       ]]>
                           WHERE 1=1
                             AND g.useyn = 'Y'
                             AND (g.divcd = '30' OR ( g.divcd='20'
                                                      AND g.deliverydtyn = 'N'
                                                      AND g.gdcd NOT IN ('A3','A4','A7','A8','B2','B3','C3','G9','H6','H9','P9','R6','R9','T1','T2','T3','Z02','Z21','Z22','Z25','Z26','Z94')
                                                    )
                                 )
                             AND g.newyn = 'Y'
                             AND (g.reserveyn = 'N' OR (g.reserveyn = 'Y' AND r.gdcd IS NOT NULL))
                      ) x
             ) AS pl
         WHERE cPage = #{intPage}
        ORDER BY ISNULL(updt, indt) DESC
    </select>
</mapper>