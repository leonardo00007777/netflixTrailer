<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="organicList_m">
<!--    'System        : m.62life.com-->
<!--    'Program       :-->
<!--    'Title         : 친환경관(전문관) 페이지(모바일)-->
<!--    'File          : organic_list_m.asp-->
<!--    'Program Type  : asp-->
<!--    'Analyst       :-->
<!--    'Author        : hyeok-->
<!--    'Date Started  : 20200309-->
<!--    'Last Modified :-->
<!--    'Called By     :-->
<!--    'Parameters    :-->
<!--    'Purpose       :-->
<!--    'Version       :-->
<!--    '-->
<!--    'Modified   Author  V/M     Reason For Modification-->

<!--    '20200309   hyeok   0.9     처음작성-->
    <select id="eventNormal">
        /* eventNormal 기획전 일반*/
        SELECT * FROM (
                          SELECT 'QUICK' odtype
                               , '11' ordertype
                               , g.gdcd
                               , g.gdname
                               , g.unit
                               , g.price1
                               , g.gdimg
                               , g.mgdimg1
                               , g.divcd
                               , g.div1
                               , g.exdiv1
                               , g.indt
                               , g.updt
                               , g.shortdesc
                               , ISNULL(z.gdcnt,99999) stock_num
                               , CASE WHEN ISNULL(g.soldoutyn,'N')='N'  THEN 'N' ELSE g.soldoutyn END soldoutyn
                               , CASE WHEN ISNULL(g.deliverydtyn,'')='' THEN 'N' ELSE g.deliverydtyn END deliverydtyn
                               , ISNULL(g.newyn,'N') newyn
                               , ISNULL(g.qtysaleyn,'N') qtysaleyn
                               , dbo.getMasterPrice(g.gdcd) saleprice
                               <if test="strMEMGRPCD != '' and strGroupSalePolicy != 'N'">
                                   , dbo.getProductPrice(#{strMEMGRPCD}, #{strGroupSalePolicy}, g.gdcd) groupsaleprice
                               </if>
                               , c.catdesc cdname
                               , g.plandate
                               , g.thedaysyn
                               , '' odtype2
                               , ISNULL(t6.cdname,'미정') AS gradedesc, '-' alltimesale
                               , CASE WHEN i.typecd IN ('10','20') THEN '1'
                                      WHEN i.typecd IN ('16','61') THEN '2'
                                      WHEN i.typecd IN ('18') THEN '3'
                                 END typecd
                               , g.priceyn
                          FROM gd_master g
                            LEFT JOIN exmenu c ON c.cat1 = g.exdiv1
                                              AND c.useyn = 'Y'
                            LEFT JOIN gd_cnt z ON z.gdcd = g.gdcd
                            LEFT JOIN gd_item i ON i.gdcd = g.gdcd
                            LEFT JOIN cd_master t6 ON t6.cdtype = '09'
                                                  AND t6.cdcode = i.typecd
                           WHERE 1 = 1
                             AND g.useyn = 'Y'
                             AND (divcd = '30' OR (divcd = '20'
                                                   AND deliverydtyn = 'N'
                                                   AND g.gdcd NOT IN ('A3','A4','A7','A8','B2','B3','C3','G9','H6','H9','P9','R6','R9','T1','T2','T3','Z02','Z21','Z22','Z25','Z26','Z94')
                                                  )
                                  )
                             AND (i.typecd IN ('10','20') AND g.exdiv1 IN ('01','02','04') OR
                                                              i.typecd IN ('16','61') AND g.exdiv1 IN ('10') OR
                                                              i.typecd IN ('18')
                                  )
                           <if test="listingMode == 'OPT'">
                               AND ISNULL(g.optionp,'N') = 'N'
                           </if>
                          UNION ALL
                          SELECT 'RESERVE' odtype
                               , '12' ordertype
                               , r.gdcd
                               , r.gdnm gdname
                               , r.unit
                               , g.price1
                               , g.gdimg
                               , g.mgdimg1
                               , g.divcd
                               , g.div1
                               , g.exdiv1
                               , r.indt
                               , r.updt
                               , g.shortdesc
                               , ISNULL(gc.gdcnt,99999) stock_num
                               , CASE WHEN ISNULL(soldoutyn,'N')='N' THEN 'N' ELSE soldoutyn END soldoutyn
                               , CASE WHEN ISNULL(g.deliverydtyn,'')='' THEN 'N' ELSE g.deliverydtyn END deliverydtyn
                               , ISNULL(g.newyn,'N') newyn
                               , 'N' qtysaleyn
                               , dbo.getMasterPrice(r.gdcd) saleprice
                               <if test="strMEMGRPCD != '' and strGroupSalePolicy != 'N'">
                                 , dbo.getProductPrice(#{strMEMGRPCD}, #{strGroupSalePolicy}, g.gdcd) groupsaleprice
                               </if>
                               , c.catdesc cdname
                               , g.plandate
                               , g.thedaysyn
                               , r.type odtype2
                               , ISNULL(t6.cdname,'미정') AS gradedesc
                               , r.alltimesale
                               , CASE WHEN i.typecd IN ('10','20') THEN '1'
                                      WHEN i.typecd IN ('16','61') THEN '2'
                                      WHEN i.typecd IN ('18') THEN '3'
                                 END typecd
                               , g.priceyn
                          FROM od_reservegoods r
                            JOIN gd_master g ON r.gdcd = g.gdcd
                            LEFT JOIN exmenu c ON c.cat1 = g.exdiv1
                                              AND c.useyn = 'Y'
                            LEFT JOIN gd_cnt gc ON gc.gdcd = r.gdcd
                            LEFT JOIN gd_item i ON i.gdcd = g.gdcd
                            LEFT JOIN cd_master t6 ON t6.cdtype = '09'
                                                  AND t6.cdcode = i.typecd
                           WHERE 1 = 1
                             AND r.useyn = 'Y'
                             <![CDATA[
                             AND r.od_from <= CONVERT(VARCHAR,GETDATE(),23)
                             AND r.od_to >= CONVERT(VARCHAR,GETDATE(),23)
                             ]]>
                             AND (i.typecd IN ('10','20') AND g.exdiv1 IN ('01','02','04') OR i.typecd IN ('16','61')
                                                                                          AND g.exdiv1 IN ('10')
                                                                                           OR i.typecd IN ('18')
                                )
                          <if test="listingMode == 'OPT'">
                              AND ISNULL(g.optionp,'N') = 'N'
                          </if>
        ) a
          LEFT JOIN (SELECT gdcd bgdcd, SUM(gdcnt) bestcnt FROM od_goods WHERE indt >= CONVERT(DATETIME, #{DATE} - 1, 21) GROUP BY gdcd) b ON a.gdcd = b.bgdcd
         WHERE 1 = 1
         <if test="exceptProduct != ''">
             AND a.gdcd NOT IN (#{exceptProduct})
         </if>
         <if test='strMEMGRPCD == "" OR strMEMGRPCD.indexOf("219") lte 0'>
             AND a.gdcd NOT IN (#{isensExceptProduct})
         </if>
         <if test='strMEMGRPCD == "" OR userDefinedTarget.indexOf(strMEMGRPCD) lte 0'>
             AND a.gdcd NOT IN (SELECT slgdcd FROM specialsellingl where slidx=468)
         </if>
         <if test='strMEMGRPCD == "" OR userDefinedTarget2.indexOf(strMEMGRPCD) lte 0'>
            AND a.gdcd NOT IN (SELECT slgdcd FROM specialsellingl where slidx=699)
         </if>
         <if test="customFilterProduct != ''">
             AND a.gdcd NOT IN (#{customFilterProduct})
         </if>
        ORDER BY a.typecd
               , a.exdiv1 DESC
               , a.gdcd
    </select>
</mapper>