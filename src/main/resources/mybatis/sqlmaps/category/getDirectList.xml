<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.x62life.mo.dao.category.CategoryDao">
<!--    'System        : m.62life.com-->
<!--    'Program       :-->
<!--    'Title         : 자연이랑모바일 - 상품 페이지 단위로 가져오기-->
<!--    'File          : get_direct_list_m.asp-->
<!--    'Program Type  : asp-->
<!--    'Analyst       :-->
<!--    'Author        : hwkim-->
<!--    'Date Started  : 20161118-->
<!--    'Last Modified :-->
<!--    'Called By     :-->
<!--    'Parameters    :-->
<!--    'Purpose       :-->
<!--    'Version       :-->
<!--    '-->
<!--    'Modified   Author  V/M     Reason For Modification-->

<!--    '20161116   hwkim   0.9     처음 작성-->
<!--    '20170102   hwkim   0.9.1   명절상품 제외 기준 동일하게 처리. / 명절상품은 별도(기획전 등) 게시-->
<!--    '20170329   hwkim   0.9.3   할인 가격 표시 변경-->
<!--    '20170420   hwkim   0.9.4   당일발송 주문 담기 처리 추가. / thedaysyn-->
<!--    '20170613   hwkim   0.9.5   당일발송 주문 담기 처리 제외 (1차범위)-->
<!--    '20180114   hwkim   0.9.6   상품표시 레이아웃 개선-->
<!--    '20180803   hwkim   0.9.7   상품등급 라벨 표시, 할인율 사각형스티커 변경 등-->

   <select id="getDirectListPaging" parameterType="java.util.Map" resultType="java.util.Map">
       /* getDirectListPaging 상품 페이징*/
       SELECT CEILING( CAST(COUNT(1) AS FLOAT)/#{intPagePerItem} ) MAXPAGE
            , COUNT(r.gdcd) CNT
       FROM od_reservegoods r
         JOIN gd_master g
           ON g.gdcd = r.gdcd
         JOIN cd_master c
           ON c.cdtype = '20'
          AND c.cdcode = r.divcd1
         LEFT JOIN gd_item i
                ON i.gdcd = r.gdcd
         LEFT JOIN cd_master t
                ON t.cdtype = '09'
               AND t.cdcode = i.typecd
         LEFT JOIN submenu m
                ON m.category = r.divcd1
               AND sub_category LIKE '%'+ g.div2 + '%'
        WHERE 1 = 1
          AND r.useyn='Y'
          <![CDATA[
          AND r.od_from <= CONVERT(CHAR(10), GETDATE(), 121)
          AND r.od_to >= CONVERT(CHAR(10), GETDATE(), 121)
          ]]>
          AND r.type = #{odtype2}
        <if test="customFilterProduct != null and customFilterProduct != '' ">
            <foreach collection="customFilterProduct" item="customFilterProduct">
               AND a.gdcd NOT IN (#{customFilterProduct})
            </foreach>
        </if>
   </select>

    <select id="getDirectListHeader" parameterType="java.util.Map" resultType="com.x62life.mo.model.order.OdReserveGoodsEx">
        /* getDirectListHeader 사용자 정의 필터링 상품 헤더*/
        SELECT '12' odtype
             , * FROM (
                       SELECT FLOOR( (ROW_NUMBER() OVER ( ORDER BY r.divcd1, m.smenucd, r.gdcd ) - 1 ) / #{intPagePerItem} + 1) AS page
                            , r.gdcd
                            , r.gdnm
                            , r.unit
                            , g.priceyn
                            , r.gd_expalin
                            , g.newyn
                            , g.recommendyn
                            , g.qtysaleyn
                            , g.price1
                            , dbo.getMasterPrice(g.gdcd) saleprice
                            , dbo.getProductPrice(#{strMEMGRPCD}, #{strGroupSalePolicy}, g.gdcd) groupsaleprice
                            , dbo.getIsGroupSaleGoods(#{strMEMGRPCD}, #{strGroupSalePolicy }, g.gdcd) isgroupsale
                            , g.gdimg
                            , g.mgdimg1
                            , r.divcd
                            , r.divcd1
                            , c.cdcode
                            , c.cdname
                            , CASE WHEN ISNULL(g.deliverydtyn,'')='' THEN 'N' ELSE g.deliverydtyn END deliverydtyn
                            , CASE WHEN ISNULL(g.soldoutyn,'')='' THEN 'N' ELSE g.soldoutyn END soldoutyn
                            , ISNULL( gc.gdcnt ,99999) gdcnt
                            , i.origin
                            , i.producer
                            , i.address
                            , ISNULL(t.cdname,'미지정') AS gradedesc
                            , m.smenucd
                            , m.smenudesc
                            , r.od_from
                            , r.od_to
                            , r.dlv_from
                            , r.dlv_to
                            , g.thedaysyn
                            , g.shortdesc
                       FROM od_reservegoods r
                         JOIN gd_master g ON g.gdcd = r.gdcd
                         JOIN cd_master c ON c.cdtype = '20'
                                         AND c.cdcode = r.divcd1
                         LEFT JOIN gd_item i ON i.gdcd = r.gdcd
                         LEFT JOIN cd_master t ON t.cdtype = '09'
                                              AND t.cdcode = i.typecd
                         LEFT JOIN submenu m ON m.category = r.divcd1
                                            AND sub_category LIKE '%'+ g.div2 + '%'
                         LEFT JOIN gd_cnt gc ON gc.gdcd = r.gdcd
                        WHERE 1 = 1
                          AND r.useyn='Y'
                          <![CDATA[
                          AND r.od_from <= CONVERT(CHAR(10), GETDATE(), 121)
                          AND r.od_to >= CONVERT(CHAR(10), GETDATE(), 121)
                          ]]>
                          AND r.type = #{odtype2}
                        <if test="customFilterProduct != null and customFilterProduct != '' ">
                           <foreach collection="customFilterProduct" item="customFilterProduct">
                              AND a.gdcd NOT IN (#{customFilterProduct})
                           </foreach>
                        </if>
                       ) AS pl
                    WHERE page = #{intPage}
    </select>
</mapper>