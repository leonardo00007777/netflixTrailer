<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.x62life.mo.dao.category.CategoryDao">
<!--    'System        : m.62life.com-->
<!--    'Program       :-->
<!--    'Title         : 자연이랑모바일 - 상품 페이지 단위로 가져오기-->
<!--    'File          : get_direct_list_m.asp-->
<!--    'Program Type  : asp-->
<!--    'Analyst       :-->
<!--    'Author        : hwkim-->
<!--    'Date Started  : 20161118-->
<!--    'Last Modified :-->
<!--    'Called By     :-->
<!--    'Parameters    :-->
<!--    'Purpose       :-->
<!--    'Version       :-->
<!--    '-->
<!--    'Modified   Author  V/M     Reason For Modification-->
<!--    '20161116   hwkim   0.9     처음 작성-->
<!--    '20170102   hwkim   0.9.1   명절상품 제외 기준 동일하게 처리. / 명절상품은 별도(기획전 등) 게시-->
<!--    '20170329   hwkim   0.9.3   할인 가격 표시 변경-->
<!--    '20170420   hwkim   0.9.4   당일발송 주문 담기 처리 추가. / thedaysyn-->
<!--    '20170613   hwkim   0.9.5   당일발송 주문 담기 처리 제외 (1차범위)-->
<!--    '20180114   hwkim   0.9.6   상품표시 레이아웃 개선-->
<!--    '20180803   hwkim   0.9.7   상품등급 라벨 표시, 할인율 사각형스티커 변경 등-->
<!--    '사용자 정의 필터링 상품 - 첫구매(2019)이벤트 상품, 5월휴면고객특가-->
<!--    CUSTOM_FILTER_PRODUCT = "'43042719','91073305','05020034','99701120','1010000011','1010000031'"-->

    <select id="defProdOneProd">
        /* defProdOneProd 기본 단품 할인, 추천 상품*/
        SELECT a.exdiv1
             , d.catdesc
             , COUNT(gdcd) AS gdcnt
        FROM (
                 SELECT g.gdcd
                      , g.exdiv1
                 FROM gd_master g
                   LEFT JOIN od_reservegoods r ON g.gdcd = r.gdcd
                                              AND r.useyn = 'Y'
                                              <![CDATA[
                                              AND DATEDIFF(D,CONVERT(DATETIME,r.od_from,120),GETDATE()) >= 0
                                              AND DATEDIFF(D,GETDATE(),CONVERT(DATETIME,r.od_to,120)) >= 0
                                              ]]>
                  WHERE 1=1
                    AND (g.reserveyn = 'N' OR (g.reserveyn = 'Y' AND r.gdcd IS NOT NULL))
                    AND g.useyn = 'Y'
                    AND g.divcd = '30'
                    AND g.saleflag IN ('P','S')
                  <if test='strMEMGRPCD == "" or strMEMGRPCD == null or strMEMGRPCD.indexOf(SK_EC) lte 0 '>
                      AND r.gdcd NOT IN (SELECT slgdcd FROM specialsellingl WHERE slidx = 161)
                  </if>
                  <if test='strMEMGRPCD == "" or strMEMGRPCD == null or strMEMGRPCD.indexOf(SK_CHEMICALS) lte 0 '>
                      AND r.gdcd NOT IN (SELECT slgdcd FROM specialsellingl WHERE slidx = 160)
                  </if>
                  <if test='strMEMGRPCD = "" or strMEMGRPCD == null or strMEMGRPCD.indexOf(CNTHOTH) lte 0'>
                      AND r.gdcd NOT IN (SELECT slgdcd FROM specialsellingl WHERE slidx = 162)
                  </if>
             ) a
          JOIN cd_master c
            ON c.cdtype = '20'
           AND c.cdcode = a.div1
          JOIN exmenu d
            ON d.cat1 = a.exdiv1
         WHERE 1 = 1
         <if test="customFilterProduct != null and customFilterProduct != '' ">
            <foreach collection="customFilterProduct" item="customFilterProduct">
             AND a.gdcd NOT IN (#{customFilterProduct})
            </foreach>
         </if>
        GROUP BY a.exdiv1, d.catdesc
        ORDER BY a.exdiv1
    </select>
    <!--    'System        : m.62life.com-->
    <!--    'Program       :-->
    <!--    'Title         : 자연이랑모바일 - 상품 페이지 단위로 가져오기-->
    <!--    'File          : get_discount_list2_m.asp-->
    <!--    'Program Type  : asp-->
    <!--    'Analyst       :-->
    <!--    'Author        : hwkim-->
    <!--    'Date Started  : 20161116-->
    <!--    'Last Modified :-->
    <!--    'Called By     :-->
    <!--    'Parameters    :-->
    <!--    'Purpose       :-->
    <!--    'Version       :-->
    <!--    '-->
    <!--    'Modified   Author  V/M     Reason For Modification-->
    <!--    '20161116   hwkim   0.9     처음 작성-->
    <!--    '20170713   hwkim   0.9.1   카테고리 추가-->
    <!--    '20180621   hyeok   -&#45;&#45;     표시대상 상품 조건에 세트유형(20) 추가-->
    <!--    '20180803   hwkim   0.9.2   상품등급 라벨 표시, 할인율 사각형스티커 변경 등-->
    <!--    '사용자 정의 필터링 상품 - 첫구매(2019)이벤트 상품, 5월휴면고객특가-->
    <!--    CUSTOM_FILTER_PRODUCT = "'43042719','91073305','05020034','99701120','1010000011','1010000013','1010000031'"-->
    <select id="discountListAddSetProdPaging" parameterType="java.util.Map" resultType="java.util.Map">
        SELECT CEILING( CAST(COUNT(1) AS FLOAT)/ #{intPagePerItem}) maxPage
             , COUNT(a.gdcd) CNT
        FROM (
               SELECT g.gdcd
               FROM gd_master g
                 LEFT JOIN od_reservegoods r
                        ON g.gdcd = r.gdcd
                       AND r.useyn = 'Y'
                       <![CDATA[
                       AND DATEDIFF(D,CONVERT(DATETIME,r.od_from,120),GETDATE()) >= 0
                       AND DATEDIFF(D,GETDATE(),CONVERT(DATETIME,r.od_to,120)) >= 0
                       ]]>
                WHERE 1=1
                  AND g.useyn = 'Y'
                  AND g.divcd = '30'
                  AND (g.divcd = '30' OR ( g.divcd = '20'
                                           AND g.deliverydtyn = 'N'
                                           AND g.gdcd NOT IN ('A3','A4','A7','A8','B2','B3','C3','G9','H6','H9','P9','R6','R9','T1','T2','T3','Z02','Z21','Z22','Z25','Z26','Z94')
                                         )
                      )
                  AND g.saleflag IN ('P','S')
                  AND (g.reserveyn = 'N' OR (g.reserveyn = 'Y' AND r.gdcd IS NOT NULL))
                  <if test="div1 != ''">
                     AND g.exdiv1 = #[div1}
                  </if>
                  <if test="strMEMGRPCD == '' or strMEMGRPCD.indexOf(SK_EC) lte 0 ">
                     AND r.gdcd NOT IN (SELECT slgdcd FROM specialsellingl WHERE slidx = 161)
                  </if>
                  <if test="strMEMGRPCD == '' or strMEMGRPCD.indexOf(SK_CHEMICALS) lte 0 ">
                     AND r.gdcd NOT IN (SELECT slgdcd FROM specialsellingl WHERE slidx = 160)
                  </if>
                  <if test="strMEMGRPCD = '' or strMEMGRPCD.indexOf(CNTHOTH) lte 0">
                     AND r.gdcd NOT IN (SELECT slgdcd FROM specialsellingl WHERE slidx = 162)
                  </if>
               ) a
         WHERE 1 = 1
         <if test="customFilterProduct != null and customFilterProduct != '' ">
            <foreach collection="customFilterProduct" item="customFilterProduct">
                AND a.gdcd NOT IN (#{customFilterProduct})
            </foreach>
         </if>
    </select>

    <select id="discountProdListAddSetProd" parameterType="java.util.Map" resultType="com.x62life.mo.model.product.GdMasterEx">
        SELECT *
        FROM (
               SELECT FLOOR((ROW_NUMBER() OVER (ORDER BY 1-(a.saleprice/a.price1) DESC)-1)/ #{intPagePerItem} + 1) AS cPage
                    , a.odtype
                    , a.gdcd
                    , a.gdname
                    , a.unit
                    , a.price1
                    , a.gdimg
                    , a.divcd
                    , a.div1
                    , a.indt
                    , a.updt
                    , a.shortdesc
                    , a.saleprice
                    , a.soldoutyn
                    , a.gdcnt
                    , a.newyn
                    , a.qtysaleyn
                    , a.deliverydtyn
                    , a.origin
                    , a.producer
                    , a.address
                    , a.gradedesc
                    , a.odtype2
                    , a.thedaysyn
                    , a.reserveyn
               FROM (
                      SELECT g.gdcd
                           , g.gdname
                           , g.unit
                           , g.price1
                           , g.gdimg
                           , g.divcd
                           , g.div1
                           , g.indt
                           , g.updt
                           , g.shortdesc
                           , dbo.getProductPrice(#{strMEMGRPCD}, #{strGroupSalePolicy}, g.gdcd) saleprice
                           , ISNULL(g.soldoutyn,'N') soldoutyn
                           , ISNULL(s.gdcnt,99999) gdcnt
                           , ISNULL(g.newyn,'N') newyn
                           , ISNULL(g.qtysaleyn,'N') qtysaleyn
                           , ISNULL(g.deliverydtyn,'N') deliverydtyn
                           , i.origin
                           , i.producer
                           , i.address
                           , ISNULL(t.cdname,'미지정') AS gradedesc
                           , '01' odtype2
                           , g.thedaysyn
                           , CASE g.dispatchtype WHEN 'I' THEN '11'
                                                 WHEN 'O' THEN '15'
                             END odtype
                          , ISNULL(g.reserveyn,'N') reserveyn
                      FROM gd_master g
                        LEFT JOIN gd_item i
                               ON i.gdcd = g.gdcd
                        LEFT JOIN cd_master t
                               ON t.cdtype = #{typeFarm}
                              AND t.cdcode = i.typecd
                        LEFT JOIN gd_cnt s
                               ON g.gdcd = s.gdcd
                        LEFT JOIN od_reservegoods r
                               ON g.gdcd = r.gdcd
                              AND r.useyn = 'Y'
                              <![CDATA[
                              AND DATEDIFF(D,CONVERT(DATETIME,r.od_from,120),GETDATE()) >= 0
                              AND DATEDIFF(D,GETDATE(),CONVERT(DATETIME,r.od_to,120)) >= 0
                              ]]>
                       WHERE 1=1
                         AND g.useyn = 'Y'
                         AND g.divcd = '30'
                         AND (g.divcd = '30' OR ( g.divcd='20'
                                                  AND g.deliverydtyn = 'N'
                                                  AND g.gdcd NOT IN ('A3','A4','A7','A8','B2','B3','C3','G9','H6','H9','P9','R6','R9','T1','T2','T3','Z02','Z21','Z22','Z25','Z26','Z94')
                                                )
                             )
                         AND g.saleflag IN ('P','S')
                         AND (g.reserveyn = 'N' OR (g.reserveyn = 'Y' AND r.gdcd IS NOT NULL))
                       <if test="div1 != ''">
                         AND g.exdiv1 = #[div1}
                       </if>
                       <if test="strMEMGRPCD == '' or strMEMGRPCD.indexOf(SK_EC) lte 0 ">
                         AND r.gdcd NOT IN (SELECT slgdcd FROM specialsellingl WHERE slidx = 161)
                       </if>
                       <if test="strMEMGRPCD == '' or strMEMGRPCD.indexOf(SK_CHEMICALS) lte 0 ">
                         AND r.gdcd NOT IN (SELECT slgdcd FROM specialsellingl WHERE slidx = 160)
                       </if>
                       <if test="strMEMGRPCD = '' or strMEMGRPCD.indexOf(CNTHOTH) lte 0">
                         AND r.gdcd NOT IN (SELECT slgdcd FROM specialsellingl WHERE slidx = 162)
                       </if>
                      ) a
                WHERE 1 = 1
                <if test="customFilterProduct != null and customFilterProduct != '' ">
                   <foreach collection="customFilterProduct" item="customFilterProduct">
                         AND a.gdcd NOT IN (#{customFilterProduct})
                   </foreach>
                </if>
             )AS pl
         WHERE cPage = #{intPage}
    </select>

</mapper>