<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.x62life.mo.dao.category.CategoryDao">
<!--    '/*****************************************************************************-->
<!--    'System        : m.62life.com-->
<!--    'Program       :-->
<!--    'Title         : 자연이랑모바일 - 할인, 추천 상품-->
<!--    'File          : weekhot_m.asp-->
<!--    'Program Type  : asp-->
<!--    'Analyst       :-->
<!--    'Author        : hwkim-->
<!--    'Date Started  : 20140324-->
<!--    'Last Modified :-->
<!--    'Called By     :-->
<!--    'Parameters    :-->
<!--    'Purpose       :-->
<!--    'Version       :-->
<!--    '-->
<!--    'Modified   Author  V/M     Reason For Modification-->
<!--    '20170619   hwkim   0.9     처음 작성-->
<!--    '20170713   hwkim   0.9.1   카테고리 추가-->
<!--    '20200324   sykim   0.9.2   상품정보 단일화(gd_master & od_reservegoods > gd_master) 적용.&ndash;&gt;-->
    <select id="specialExhibitionProdCnt" parameterType="java.util.Map" resultType="int">
         /*기획전 일반*/
        SELECT COUNT(1) rscnt 
          FROM gd_master a
            LEFT JOIN od_reservegoods r
                   ON a.gdcd = r.gdcd
                  AND r.useyn = 'Y'
                  <![CDATA[
                  AND DATEDIFF(D,CONVERT(DATETIME,r.od_from,120),GETDATE()) >= 0
                  AND DATEDIFF(D,GETDATE(),CONVERT(DATETIME,r.od_to,120)) >= 0
                   ]]>
           WHERE 1 = 1
             AND a.useyn = 'Y'
             AND (a.reserveyn = 'N' OR (a.reserveyn = 'Y' AND r.gdcd IS NOT NULL))
             AND (a.divcd = '30' OR (a.divcd = '20'
                                     AND a.deliverydtyn = 'N'
                                     AND a.gdcd NOT IN ('A3','A4','A7','A8','B2','B3','C3','G9','H6','H9','P9','R6','R9','T1','T2','T3','Z02','Z21','Z22','Z25','Z26','Z94')
                                    )
                ) 
            AND a.saleflag IN ('P','S')
        <if test="customFilterProduct != null and customFilterProduct != '' ">
            AND a.gdcd NOT IN
            <foreach collection="customFilterProduct" item="customFilterProduct" open="(" separator="," close=")">
                 #{customFilterProduct}
            </foreach>
        </if>
    </select>
    
    <select id="specialExhibitionProdList" parameterType="java.util.Map" resultType="gdMasterEx">
        /*기획전 일반*/
        SELECT * 
           FROM (
                 SELECT a.gdcd
                      , a.gdname
                      , a.unit
                      , a.price1
                      , a.gdimg
                      , a.divcd
                      , a.div1
                      , a.indt
                      , a.updt
                      , a.shortdesc 
                      , ISNULL(z.gdcnt,99999) stock_num 
                      , ISNULL(a.soldoutyn,'N') soldoutyn 
                      , ISNULL(a.newyn,'N') newyn
                      , ISNULL(a.qtysaleyn,'N') qtysaleyn 
                      , dbo.getMasterPrice(a.gdcd) saleprice 
                      , dbo.getProductPrice(#{strMEMGRPCD},#{strGroupSalePolicy},g.gdcd) groupsaleprice 
                      , dbo.getIsGroupSaleGoods(#{strMEMGRPCD},#{strGroupSalePolicy},g.gdcd) isgroupsale 
                      , a.plandate 
                      , a.thedaysyn 
                      , ISNULL(t6.cdname,'미정') AS typename
                      , '-' alltimesale
                      , CASE a.dispatchtype WHEN 'I' THEN '11' WHEN 'O' THEN '15' END odtype 
                      , ISNULL(a.deliverydtyn,'N') deliverydtyn 
                      , ISNULL(a.reserveyn,'N') reserveyn 
                   FROM gd_master a 
                        LEFT JOIN gd_cnt z
                               ON z.gdcd = a.gdcd
                        LEFT JOIN gd_item i
                               ON i.gdcd = a.gdcd
                        LEFT JOIN cd_master t6
                               ON t6.cdtype = '09' AND t6.cdcode = i.typecd
                        LEFT JOIN od_reservegoods r
                               ON a.gdcd = r.gdcd
                              AND r.useyn = 'Y'
                              <![CDATA[
                              AND DATEDIFF(D,CONVERT(DATETIME,r.od_from,120),GETDATE()) >= 0
                              AND DATEDIFF(D,GETDATE(),CONVERT(DATETIME,r.od_to,120)) >= 0
                              ]]>
                  WHERE 1 = 1 
                    AND a.useyn = 'Y' 
                    AND (a.reserveyn = 'N' OR (a.reserveyn = 'Y' AND r.gdcd IS NOT NULL))
                    AND (a.divcd = '30' OR (  a.divcd='20'
                                              AND a.deliverydtyn = 'N'
                                              AND a.gdcd NOT IN ('A3','A4','A7','A8','B2','B3','C3','G9','H6','H9','P9','R6','R9','T1','T2','T3','Z02','Z21','Z22','Z25','Z26','Z94')
                                           )
                         )
                   AND a.saleflag IN ('P','S')
                 <if test=" 0 lte compareDate1 and compareDate2 lte 0">
                     <if test="strMEMGRPCD == '' or strMEMGRPCD.indexOf(userDefinedTarget) lte 0">
                         AND g.gdcd NOT IN (SELECT slgdcd FROM specialsellingl WHERE slidx = 784)
                     </if>
                 </if>
                 <if test="0 lte compareDate3 and compareDate4 lte 0">
                     <if test="strMEMGRPCD == '' or strMEMGRPCD.indexOf(userDefinedTarget) lte 0">
                         AND g.gdcd NOT IN (SELECT slgdcd FROM specialsellingl WHERE slidx = 792)
                     </if>
                 </if>
                 <if test="0 lte compare1 and compare2 lte 0">
                     <if test="strMEMGRPCD == '' OR strMEMGRPCD.indexOf(userDefinedTarget) lte 0 ">
                         AND a.gdcd NOT IN (SELECT slgdcd FROM specialsellingl WHERE slidx = 784)
                     </if>
                 </if>
                 <if test="0 lte compare3 and compare4 lte 0">
                     <if test="strMEMGRPCD == '' OR strMEMGRPCD.indexOf(userDefinedTarget3) lte 0 ">
                         AND a.gdcd NOT IN (SELECT slgdcd FROM specialsellingl WHERE slidx = 792)
                     </if>
                 </if>
                 ) a
            WHERE 1 = 1
        <if test="customFilterProduct != null and customFilterProduct != '' ">
            AND a.gdcd NOT IN
            <foreach collection="customFilterProduct" item="customFilterProduct"  open="(" separator="," close=")">
                #{customFilterProduct}
            </foreach>
        </if>
        ORDER BY div1, 1-(saleprice / price1) DESC
        OFFSET #{intPageOffset} ROWS
        FETCH NEXT #{intPageSize} ROWS ONLY
    </select>

<!--    'System        : m.62life.com
    'Program       :
    'Title         : 자연이랑모바일 - 할인, 추천 상품
    'File          : weekhot_m.asp
    'Program Type  : asp
    'Analyst       :
    'Author        : hwkim
    'Date Started  : 20140324
    'Last Modified :
    'Called By     :
    'Parameters    :
    'Purpose       :
    'Version       :
    '
    'Modified   Author  V/M     Reason For Modification

    '20170619   hwkim   0.9     처음 작성
    '20170713   hwkim   0.9.1   카테고리 추가
    '20200324   sykim   0.9.2   상품정보 단일화(gd_master & od_reservegoods > gd_master) 적용.-->

    <select id="defSetOneProd" parameterType="java.util.Map" resultType="gdMasterEx">
        /* defProdOneProd 기본세트상품 단품상품 표시*/
        SELECT a.exdiv1
             , c.catdesc
             , COUNT(gdcd) AS cnt
        FROM (
                 SELECT g.gdcd
                      , g.exdiv1
                 FROM gd_master g
                   LEFT JOIN od_reservegoods r ON g.gdcd = r.gdcd
                                              AND r.useyn = 'Y'
                                              <![CDATA[
                                              AND DATEDIFF(D,CONVERT(DATETIME,r.od_from,120),GETDATE()) >= 0
                                              AND DATEDIFF(D,GETDATE(),CONVERT(DATETIME,r.od_to,120)) >= 0
                                              ]]>
                  WHERE 1=1
                    AND (g.reserveyn = 'N' OR (g.reserveyn = 'Y' AND r.gdcd IS NOT NULL))
                    AND g.useyn = 'Y'
                    AND g.divcd = '30'
                    AND g.saleflag IN ('P','S')
                  <if test='strMEMGRPCD == "" or strMEMGRPCD == null or strMEMGRPCD.indexOf(SK_EC) lte 0 '>
                      AND r.gdcd NOT IN (SELECT slgdcd FROM specialsellingl WHERE slidx = 161)
                  </if>
                  <if test='strMEMGRPCD == "" or strMEMGRPCD == null or strMEMGRPCD.indexOf(SK_CHEMICALS) lte 0 '>
                      AND r.gdcd NOT IN (SELECT slgdcd FROM specialsellingl WHERE slidx = 160)
                  </if>
                  <if test='strMEMGRPCD = "" or strMEMGRPCD == null or strMEMGRPCD.indexOf(CNTHOTH) lte 0'>
                      AND r.gdcd NOT IN (SELECT slgdcd FROM specialsellingl WHERE slidx = 162)
                  </if>
             ) a
          JOIN exmenu c
            ON c.cat1 = a.exdiv1
         WHERE 1 = 1
         <if test="customFilterProduct != null and customFilterProduct != '' ">
             AND a.gdcd NOT IN
            <foreach collection="customFilterProduct" item="customFilterProduct" open="(" separator="," close=")">
              #{customFilterProduct}
            </foreach>
         </if>
        GROUP BY a.exdiv1, c.catdesc
        ORDER BY a.exdiv1
    </select>
    <!--
        'System        : m.62life.com
        'Program       :
        'Title         : 자연이랑모바일 - 상품 페이지 단위로 가져오기
        'File          : get_discount_list2_m.asp
        'Program Type  : asp
        'Analyst       :
        'Author        : hwkim
        'Date Started  : 20161116
        'Last Modified :
        'Called By     :
        'Parameters    :
        'Purpose       :
        'Version       :
        '
        'Modified   Author  V/M     Reason For Modification

        '20161116   hwkim   0.9     처음 작성
        '20170713   hwkim   0.9.1   카테고리 추가
        '20180621   hyeok   -&#45;&#45;     표시대상 상품 조건에 세트유형(20) 추가
        '20180803   hwkim   0.9.2   상품등급 라벨 표시, 할인율 사각형스티커 변경 등
        '20201116   chhyeon   -       2020-11-16~20 간 일반회원 활성화 이벤트로 특정상품만 일반회원에게 노출하도록 설정. >> ONLY_NORMAL_GROUP_PRODUCT
        '20210728   hnjang          품절상품 정렬 변경(하단 노출)
        -->
    <select id="discountListPaging" parameterType="java.util.Map" resultType="java.util.Map">
        /* discountListPaging 할인상품 페이징*/
        SELECT CEILING( CAST(COUNT(1) AS FLOAT)/ #{intPagePerItem}) maxPage
             , COUNT(a.gdcd) CNT
        FROM (
               SELECT g.gdcd
               FROM gd_master g
                 LEFT JOIN od_reservegoods r
                        ON g.gdcd = r.gdcd
                       AND r.useyn = 'Y'
                       <![CDATA[
                       AND DATEDIFF(D,CONVERT(DATETIME,r.od_from,120),GETDATE()) >= 0
                       AND DATEDIFF(D,GETDATE(),CONVERT(DATETIME,r.od_to,120)) >= 0
                       ]]>
                WHERE 1=1
                  AND g.useyn = 'Y'
                  AND g.divcd = '30'
                  AND (g.divcd = '30' OR ( g.divcd = '20'
                                           AND g.deliverydtyn = 'N'
                                           AND g.gdcd NOT IN ('A3','A4','A7','A8','B2','B3','C3','G9','H6','H9','P9','R6','R9','T1','T2','T3','Z02','Z21','Z22','Z25','Z26','Z94')
                                         )
                      )
                  AND g.saleflag IN ('P','S')
                  AND (g.reserveyn = 'N' OR (g.reserveyn = 'Y' AND r.gdcd IS NOT NULL))
                  <if test="div1 != ''">
                     AND g.exdiv1 = #[div1}
                  </if>
                  <if test="strMEMGRPCD == '' or strMEMGRPCD.indexOf(SK_EC) lte 0 ">
                     AND r.gdcd NOT IN (SELECT slgdcd FROM specialsellingl WHERE slidx = 161)
                  </if>
                  <if test="strMEMGRPCD == '' or strMEMGRPCD.indexOf(SK_CHEMICALS) lte 0 ">
                     AND r.gdcd NOT IN (SELECT slgdcd FROM specialsellingl WHERE slidx = 160)
                  </if>
                  <if test="strMEMGRPCD = '' or strMEMGRPCD.indexOf(CNTHOTH) lte 0">
                     AND r.gdcd NOT IN (SELECT slgdcd FROM specialsellingl WHERE slidx = 162)
                  </if>
               ) a
         WHERE 1 = 1
         <if test="customFilterProduct != null and customFilterProduct != '' ">
             AND a.gdcd NOT IN
            <foreach collection="customFilterProduct" item="customFilterProduct"  open="(" separator="," close=")">
                 #{customFilterProduct}
            </foreach>
         </if>
    </select>

    <select id="discountSetProdList" parameterType="java.util.Map" resultType="gdMasterEx">
        /*discountSetProdList 세트 할인상품 리스트*/
        SELECT *
        FROM (
               SELECT FLOOR((ROW_NUMBER() OVER (ORDER BY 1-(a.saleprice/a.price1) DESC)-1)/ #{intPagePerItem} + 1) AS page
                    , a.odtype
                    , a.gdcd
                    , a.gdname
                    , a.unit
                    , a.price1
                    , a.gdimg
                    , a.divcd
                    , a.div1
                    , a.indt
                    , a.updt
                    , a.shortdesc
                    , a.saleprice
                    , a.soldoutyn
                    , a.gdcnt
                    , a.newyn
                    , a.qtysaleyn
                    , a.deliverydtyn
                    , a.origin
                    , a.producer
                    , a.address
                    , a.gradedesc
                    , a.odtype2
                    , a.thedaysyn
                    , a.reserveyn
               FROM (
                      SELECT g.gdcd
                           , g.gdname
                           , g.unit
                           , g.price1
                           , g.gdimg
                           , g.divcd
                           , g.div1
                           , g.indt
                           , g.updt
                           , g.shortdesc
                           , dbo.getProductPrice(#{strMEMGRPCD}, #{strGroupSalePolicy}, g.gdcd) saleprice
                           , ISNULL(g.soldoutyn,'N') soldoutyn
                           , ISNULL(s.gdcnt,99999) gdcnt
                           , ISNULL(g.newyn,'N') newyn
                           , ISNULL(g.qtysaleyn,'N') qtysaleyn
                           , ISNULL(g.deliverydtyn,'N') deliverydtyn
                           , i.origin
                           , i.producer
                           , i.address
                           , ISNULL(t.cdname,'미지정') AS gradedesc
                           , '01' odtype2
                           , g.thedaysyn
                           , CASE g.dispatchtype WHEN 'I' THEN '11'
                                                 WHEN 'O' THEN '15'
                             END odtype
                          , ISNULL(g.reserveyn,'N') reserveyn
                      FROM gd_master g
                        LEFT JOIN gd_item i
                               ON i.gdcd = g.gdcd
                        LEFT JOIN cd_master t
                               ON t.cdtype = #{typeFarm}
                              AND t.cdcode = i.typecd
                        LEFT JOIN gd_cnt s
                               ON g.gdcd = s.gdcd
                        LEFT JOIN od_reservegoods r
                               ON g.gdcd = r.gdcd
                              AND r.useyn = 'Y'
                              <![CDATA[
                              AND DATEDIFF(D,CONVERT(DATETIME,r.od_from,120),GETDATE()) >= 0
                              AND DATEDIFF(D,GETDATE(),CONVERT(DATETIME,r.od_to,120)) >= 0
                              ]]>
                       WHERE 1=1
                         AND g.useyn = 'Y'
                         AND g.divcd = '30'
                         AND (g.divcd = '30' OR ( g.divcd='20'
                                                  AND g.deliverydtyn = 'N'
                                                  AND g.gdcd NOT IN ('A3','A4','A7','A8','B2','B3','C3','G9','H6','H9','P9','R6','R9','T1','T2','T3','Z02','Z21','Z22','Z25','Z26','Z94')
                                                )
                             )
                         AND g.saleflag IN ('P','S')
                         AND (g.reserveyn = 'N' OR (g.reserveyn = 'Y' AND r.gdcd IS NOT NULL))
                       <if test="div1 != ''">
                         AND g.exdiv1 = #[div1}
                       </if>
                      ) a
                WHERE 1 = 1
                <if test="customFilterProduct != null and customFilterProduct != '' ">
                    AND a.gdcd NOT IN
                   <foreach collection="customFilterProduct" item="customFilterProduct" open="(" separator="," close=")">
                         #{customFilterProduct}
                   </foreach>
                </if>
                <if test="compareDate1 gte 0 and compareDate2 gte 0">
                   <if test="strMEMGRPCD == '' OR strMEMGRPCD != '' and strMEMGRPCD != groupNormal">
                       AND a.gdcd NOT IN
                       <foreach collection="onlyNormalGroupProduct" item="onlyNormalGroupProduct" open="(" separator="," close=")">
                          #{onlyNormalGroupProduct}
                       </foreach>
                   </if>
                </if>
             )AS pl
         WHERE page = #{intPage}
    </select>
<!--    '20161116   hwkim   0.9     처음 작성
    '20161222   hwkim   0.9.1   장바구니 담기 기능 옵션 추가.
    '20170329   hwkim   0.9.3   할인 가격 표시 변경
    '20170420   hwkim   0.9.4   당일발송 주문 담기 처리 추가. / thedaysyn
    '20170613   hwkim   0.9.5   당일발송 주문 담기 처리 제외 (1차범위)
    '20170621   hwkim   0.9.6   할인상품 표시페이지 변경에 따라 더보기 버튼을 새로운 discount_list2_m 페이지로 링크
    '20180114   hwkim   0.9.7   상품표시 레이아웃 개선
    '20180621   hyeok   -&#45;&#45;     표시대상 상품 조건에 세트유형(20) 추가
    '20180803   hwkim   0.9.2   상품등급 라벨 표시, 할인율 사각형스티커 변경 등
    '20200324   sykim   0.9.3   상품정보 단일화(gd_master & od_reservegoods > gd_master) 적용.
    '20210113   chhyeon 1.0     쿼리 수행속도 단축
    '20210118   chhyeon 1.1     필터링 기능 추가.
    '20210125   chhyeon 1.2     x2 버전 생성
    '20210204   chhyeon 1.2.1   사용자 정의 (고객)그룹 표시 제한 방식 적용
    '20210310   hwkim   -       일시품절 시 높이 맞춤처리, 더 보기 버튼 레이아웃
    '20210604   chhyeon         속도 개선
    '20210906   hnjang  1.2.2   배송유형별(자연이랑,업체직송) 분류 기능 추가-->
    
    <select id="discountListX2">
        SELECT CEILING( CAST(COUNT(1) AS FLOAT)/20) maxPage
             , COUNT(a.gdcd) CNT
          FROM ( 
                 SELECT g.gdcd
                   FROM gd_master g
                     LEFT JOIN od_reservegoods r
                            ON g.gdcd = r.gdcd
                           AND r.useyn = 'Y'
                           AND CONVERT(VARCHAR,GETDATE(),23) BETWEEN r.od_from AND r.od_to
                    WHERE g.useyn = 'Y'
                      AND (g.divcd = '30'
                           OR (g.divcd = '20' AND

                               g.deliverydtyn = 'N' AND
                               g.gdcd NOT IN ('A3','A4','A7','A8','B2','B3','C3','G9','H6','H9','P9','R6','R9','T1','T2','T3','Z02','Z21','Z22','Z25','Z26','Z94')
                               )
                           )
               AND g.saleflag IN ('P','S') 
               AND (g.reserveyn = 'N' OR (g.reserveyn = 'Y' AND r.gdcd IS NOT NULL)) 
               AND (ISNULL(g.expgrcd, '') = '' 
                     OR EXISTS (SELECT cl.ulgrcd FROM customgrp_l cl 
                                 WHERE cl.ulcode = g.expgrcd AND cl.ulgrcd = '& strMEMGRPCD & ')) 
    </select>
</mapper>