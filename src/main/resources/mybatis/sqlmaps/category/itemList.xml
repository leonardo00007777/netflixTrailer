<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.x62life.mo.dao.category.CategoryDao">
<!--    'System        : m.62life.com-->
<!--    'Program       :-->
<!--    'Title         : 자연이랑모바일 - 상품 카테고리별 보기-->
<!--    'File          : item_list_m.asp-->
<!--    'Program Type  : asp-->
<!--    'Analyst       :-->
<!--    'Author        : hwkim-->
<!--    'Date Started  : 20170124-->
<!--    'Last Modified :-->
<!--    'Called By     :-->
<!--    'Parameters    :-->
<!--    'Purpose       :-->
<!--    'Version       :-->
<!--    '-->
<!--    'Modified   Author  V/M     Reason For Modification-->

<!--    '20170124   hwkim   0.9     처음 작성 - 옵션 상품 목록 제외 처리-->
<!--    '20170227   hwkim   0.9.1   상품 없을 때 안내 표시 처리 버그 수정-->
<!--    '20170314   hwkim   0.9.2   정렬기능 붙임. 일부 수정 item_sort_list_m 으로 부터-->
<!--    '20170327   hwkim   -       가격표시 디자인 변경-->
<!--    '20170420   hwkim   0.9.3   당일발송 주문 담기 처리 추가. / thedaysyn-->
<!--    '20170613   hwkim   0.9.4   당일발송 주문 담기 처리 제외 (1차범위)-->
<!--    '20171107   hwkim   -       웹페이지 타이틀 상품명 추가. 공유에 활용-->
<!--    '20180114   hwkim   0.9.5   상품표시 레이아웃 개선-->
<!--    '20180612   hwkim   -       상품 상세 A/B 테스트 제거-->
<!--    '20180706   hyeok   -       직거래 상품 표시 버그 수정-->
<!--    '20180710   hwkim   0.9.6   새로운 Swipe 라이브러리 변경-->
<!--    '20180803   hwkim   0.9.7   상품등급 라벨 표시, 할인율 사각형스티커 변경 등-->
<!--    '20180808   hwkim   0.9.8   신속, 업체직송 표시 통합-->
<!--    '20180905   hwkim   0.9.9   카테고리 두개 통합 지정 기능 추가 - ','로 구분-->
<!--    '20181023   hwkim   1.0.0   상품명 표시 특수문자에 의한 분리규칙 추가-->
<!--    '20190927   hwkim   1.1     상품 정렬조건에 '판매량 순' 추가-->

<!--    '20200224 chhyeon 정확도 순에서 판매량 순으로 기본값 변경-->
<!--    '20200225 chhyeon orderBy 예외값 입력 시 문제방지 코드 추가.-->

<!--    '20200226 chhyeon 위 2개 변경사항 추가-->
<!--    '20200324   sykim   1.1.1   상품정보 단일화(gd_master & od_reservegoods > gd_master) 적용.-->
    <select id="showCategoryBasicProd">
       /*showCategoryBasicProd 일반 상품 카테고리 표시*/
        SELECT a.exdiv1
             , a.exdiv2
             , b.subcatdesc
        FROM (
                 SELECT DISTINCT gdcd
                               , exdiv1
                               , exdiv2
                 FROM (
                          SELECT g.gdcd
                               , ISNULL(n.div1,g.exdiv1) exdiv1
                               , ISNULL(n.div2,g.exdiv2) exdiv2
                          FROM gd_master g
                            LEFT JOIN gd_another_category n ON g.gdcd = n.gdcd
                                                           AND n.div1 = #{strExdiv1}
                           WHERE g.useyn = 'Y'
                              AND (g.divcd = '30' OR (g.divcd = '20' AND g.deliverydtyn = 'N' AND
                                                      g.gdcd NOT IN ('A3','A4','A7','A8','B2','B3','C3','G9','H6','H9','P9','R6','R9','T1','T2','T3','Z02','Z21','Z22','Z25','Z26','Z94')
                                                     )
                                  )
                              AND g.gdcd IN (SELECT gdcd
                                             FROM gd_master
                                              WHERE useyn = 'Y'
                                                AND exdiv1 = #{strExDiv1}
                                             UNION
                                             SELECT gdcd
                                             FROM gd_another_category
                                              WHERE div1 = #{strExDiv1}
                                            )
                              <if test="listingMode == 'OPT'">
                                  AND ISNULL(g.optionp,'N') = 'N'
                              </if>
                              <if test='strMEMGRPCD == "" or strMEMGRPCD.indexOf("219") lte 0'>
                                  AND g.gdcd NOT IN
                                  <foreach collection="isensExceptProduct" item="isensExceptProduct"  open="(" separator="," close=")">
                                      #{isensExceptProduct}
                                  </foreach>
                              </if>
                          UNION ALL
                          SELECT gdcd
                               , exdiv1
                               , exdiv2
                          FROM gd_master
                           WHERE useyn = 'Y'
                             AND (divcd = '30' OR (divcd = '20' AND deliverydtyn = 'N'
                                                                AND gdcd NOT IN ('A3','A4','A7','A8','B2','B3','C3','G9','H6','H9','P9','R6','R9','T1','T2','T3','Z02','Z21','Z22','Z25','Z26','Z94')
                                                  )
                                 )
                             AND ISNULL(optionp,'N') = 'N'
                             AND exdiv1 = #{strExdiv1}
                             AND gdcd NOT IN (#{ExceptProduct})
                             <if test='strMEMGRPCD == "" or strMEMGRPCD.indexOf("219") lte 0'>
                                 AND g.gdcd NOT IN
                                 <foreach collection="isensExceptProduct" item="isensExceptProduct"  open="(" separator="," close=")">
                                     #{isensExceptProduct}
                                 </foreach>
                             </if>
                      ) b
             ) a
          LEFT JOIN exsubmenu b ON a.exdiv1 = b.cat1
                               AND a.exdiv2 = b.cat2
         WHERE 1 = 1
        <if test='strMEMGRPCD == "" OR userDefinedTarget.indexOf(strMEMGRPCD) lte 0 '>
            AND g.gdcd NOT IN (SELECT slgdcd FROM specialsellingl where slidx=468)
        </if>
        <if test='strMEMGRPCD == "" OR userDefinedTarget2.indexOf(strMEMGRPCD) lte 0'>
            AND g.gdcd NOT IN (SELECT slgdcd FROM specialsellingl where slidx = 641)
        </if>
        <if test=" 0 lte targetDate1 and targetDete2 lte 0">
            <if test="strMEMGRPCD == '' or userDefinedTarget.indexOf(strMEMGRPCD) lte 0">
                AND g.gdcd NOT IN (SELECT slgdcd FROM specialsellingl WHERE slidx = 784)
            </if>
        </if>
        <if test="0 lte targetDate3 and targetDate4 lte 0">
            <if test="strMEMGRPCD == '' or userDefinedTarget3.indexOf(strMEMGRPCD) lte 0">
                AND g.gdcd NOT IN (SELECT slgdcd FROM specialsellingl WHERE slidx = 792)
            </if>
        </if>
        <if test="strMEMGRPCD == '' or userDefinedTarget.indexOf(strMEMGRPCD) lte 0 ">
            AND g.gdcd NOT IN (SELECT slgdcd FROM specialsellingl WHERE slidx = 836)
        </if>
        <if test="customFilterProduct != ''">
            AND a.gdcd NOT IN
            <foreach collection="customFilterProduct" item="customFilterProduct"  open="(" separator="," close=")">
                #{customFilterProduct}
            </foreach>
        </if>
        GROUP BY exdiv1, exdiv2, subcatdesc
        ORDER BY exdiv1, exdiv2
    </select>

    <select id="selectCategory">
       /* selectCategory 카테고리 선택*/
        SELECT subcatdesc
        FROM exsubmenu
         WHERE cat1 = #{strExDiv1}
           AND cat2 = #{strExDiv2}
    </select>

    <select id="categoryProdListPaging">
        SELECT COUNT(gdcd) CNT
        FROM (
                 SELECT g.gdcd
                 FROM gd_master g
                  WHERE 1 = 1
                    AND g.useyn = 'Y'
                    AND (g.divcd = '30' OR (g.divcd = '20' AND g.deliverydtyn = 'N' AND
                                            g.gdcd NOT IN ('A3','A4','A7','A8','B2','B3','C3','G9','H6','H9','P9','R6','R9','T1','T2','T3','Z02','Z21','Z22','Z25','Z26','Z94')
                                           )
                        )
                  <if test="strExDiv1 != ''">
                      AND g.gdcd IN (SELECT gdcd
                                     FROM gd_master
                                      WHERE useyn = 'Y'
                                        AND exdiv1 = #{strExDiv1}
                                      <if test="strExDiv2 != ''">
                                          AND exdiv2 = #{strExDiv2}
                                      </if>
                                     UNION
                                     SELECT gdcd
                                     FROM gd_another_category
                                      WHERE div1 = #{strExDiv1}
                                      <if test="strExDiv2 != ''">
                                          AND div2 = #{strExDiv2}
                                      </if>
                                    )
                  </if>
                  <if test="listingMode == 'OPT'">
                      AND ISNULL(g.optionp,'N') = 'N'
                  </if>
                  <if test="strDivCd != ''">
                      AND g.divcd LIKE #{strDivCd}
                  </if>
                  <if test='strMEMGRPCD != "" OR strMEMGRPCD.indexOf("219") lte 0'>
                      AND g.gdcd NOT IN
                      <foreach collection="isensExceptProduct" item="isensExceptProduct"  open="(" separator="," close=")">
                          #{isensExceptProduct}
                      </foreach>
                  </if>
              ) a
           WHERE 1 = 1
           <if test="strMEMGRPCD != '' OR userDefinedTarget.indexOf(strMEMGRPCD) lte 0">
               AND a.gdcd NOT IN (SELECT slgdcd FROM specialsellingl where slidx=468)
           </if>
    </select>
</mapper>
