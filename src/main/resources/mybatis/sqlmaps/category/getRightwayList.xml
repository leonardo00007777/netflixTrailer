<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="getRightwayList">
<!--    'System        : m.62life.com-->
<!--    'Program       :-->
<!--    'Title         : 자연이랑모바일 - 오늘발송 상품 페이지 단위로 가져오기-->
<!--    'File          : get_rightaway_list2_m.asp-->
<!--    'Program Type  : asp-->
<!--    'Analyst       :-->
<!--    'Author        : hwkim-->
<!--    'Date Started  : 20170621-->
<!--    'Last Modified :-->
<!--    'Called By     :-->
<!--    'Parameters    :-->
<!--    'Purpose       :-->
<!--    'Version       :-->
<!--    '-->
<!--    'Modified   Author  V/M     Reason For Modification-->

<!--    '20170621   hwkim   0.9     처음 작성-->
<!--    '20170707   hwkim   0.9.1   카테고리 추가-->
<!--    '20180530   hwkim   -       페이징 버그 수정-->
<!--    '20180626   hyeok   0.9.2   목록내 검색 기능 추가-->
<!--    '20200324   sykim   0.9.3   상품정보 단일화(gd_master & od_reservegoods > gd_master) 적용.-->
    <select id="getRightwayListPaging" resultType="java.util.Map">
        /* getRightwayListPaging 상품 리스트 페이징*/
        SELECT CEILING( CAST(COUNT(1) AS FLOAT)/#{intPagePerItem}) maxPage
             , COUNT(a.gdcd) CNT
        FROM (
                 SELECT gdcd
                 FROM gd_master
                  WHERE useyn = 'Y'
                    AND divcd = '30'
                    AND thedaysyn = 'Y'
             ) a
    </select>

    <select id="getRightwayList">
        /* getRightwayList 상품 리스트*/
        SELECT *
        FROM (
                 SELECT FLOOR((ROW_NUMBER() OVER (ORDER BY 1-(a.saleprice/a.price1))-1)/ #{intPagePerItem} + 1) AS page
                      , a.odtype
                      , a.gdcd
                      , a.gdname
                      , a.unit
                      , a.price1
                      , a.gdimg
                      , a.mgdimg1
                      , a.divcd
                      , a.div1
                      , a.indt
                      , a.updt
                      , a.shortdesc
                      , a.saleprice
                      , a.soldoutyn
                      , a.gdcnt
                      , a.newyn
                      , a.qtysaleyn
                      , a.deliverydtyn
                      , a.origin
                      , a.producer
                      , a.address
                      , a.gradedesc
                      , a.odtype2
                      , a.thedaysyn
                 FROM (
                          SELECT '' odtype
                               , g.gdcd
                               , g.gdname
                               , g.unit
                               , g.price1
                               , g.gdimg
                               , g.mgdimg1
                               , g.divcd
                               , g.div1
                               , g.indt
                               , g.updt
                               , g.shortdesc
                               , dbo.getProductPrice(#{strMEMGRPCD}, #{strGroupSalePolicy}, g.gdcd) saleprice
                               , CASE WHEN ISNULL(g.soldoutyn,'N')='N' THEN 'N' ELSE g.soldoutyn END soldoutyn, ISNULL(s.gdcnt,99999) gdcnt
                               , ISNULL(g.newyn,'N') newyn
                               , ISNULL(g.qtysaleyn,'N') qtysaleyn
                               , CASE WHEN ISNULL(g.deliverydtyn,'')='' THEN 'N' ELSE g.deliverydtyn END deliverydtyn
                               , i.origin
                               , i.producer
                               , i.address
                               , ISNULL(t.cdname,'미지정') AS gradedesc
                               , '01' odtype2
                               , g.thedaysyn
                          FROM gd_master g
                            LEFT JOIN gd_item i ON i.gdcd = g.gdcd
                            LEFT JOIN cd_master t ON t.cdtype = #{typeFarm}
                                                 AND t.cdcode = i.typecd
                            LEFT JOIN gd_cnt s ON g.gdcd = s.gdcd
                           WHERE 1=1
                             AND g.useyn = 'Y'
                             AND g.divcd = '30'
                             AND g.thedaysyn = 'Y'
                      ) a
             ) AS pl
         WHERE page = #{intPage}
    </select>
</mapper>