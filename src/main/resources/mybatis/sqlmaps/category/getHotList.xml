<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.x62life.mo.dao.category.CategoryDao">
<!--    'System        : m.62life.com-->
<!--    'Program       :-->
<!--    'Title         : 자연이랑모바일 - 인기상품 페이지 단위로 가져오기-->
<!--    'File          : get_hot_list_m.asp-->
<!--    'Program Type  : asp-->
<!--    'Analyst       :-->
<!--    'Author        : hwkim-->
<!--    'Date Started  : 20161118-->
<!--    'Last Modified :-->
<!--    'Called By     :-->
<!--    'Parameters    :-->
<!--    'Purpose       :-->
<!--    'Version       :-->
<!--    '-->
<!--    'Modified   Author  V/M     Reason For Modification-->

<!--    '20161118   hwkim   0.9     처음 작성-->
<!--    '20170213   hwkim   0.9.1   옵션 상품 표시 제외 처리-->
<!--    '20170329   hwkim   0.9.2   할인 가격 표시 변경-->
<!--    '20170420   hwkim   0.9.3   당일발송 주문 담기 처리 추가. / thedaysyn-->
<!--    '20170613   hwkim   0.9.5   당일발송 주문 담기 처리 제외 (1차범위)-->
<!--    '20180114   hwkim   0.9.6   상품표시 레이아웃 개선-->
<!--    '20180307   sykim   -       판매가 getMasterPrice > getProductPrice 변경.-->
<!--    '20180621   hyeok   -&#45;&#45;     표시대상 상품 조건에 세트유형(20) 추가-->
<!--    '20180803   hwkim   0.9.7   상품등급 라벨 표시, 할인율 사각형스티커 변경 등-->
<!--    '20200324   sykim   0.9.8   상품정보 단일화(gd_master & od_reservegoods > gd_master) 적용.-->

    <select id="targetDate" parameterType="int" resultType="int">
        /*targetDate 특정 날짜
            targetDate1 2020-06-18
          , targetDate2 2020-06-27
          , targetDate3 2020-06-26
          , targetDate4 2020-07-06
          */
        SELECT DateDiff(D, #{targetDate}, SYSDATETIME())
    </select>
    <select id="isenseFilteringProdGdcd" parameterType="java.util.Map" resultType="java.lang.String">
        /*isenseFilteringProd 아이센스 필터 상품코드*/
        SELECT gdcd
        FROM (
                 SELECT RANK() OVER(PARTITION BY b.exdiv1 ORDER BY NEWID()) rndrank
                      , gdcd
                 FROM (
                          SELECT RANK() OVER(PARTITION BY g.exdiv1 ORDER BY a.cntsum DESC, a.opricesum DESC) gdrank
                               , a.gdcd
                               , g.exdiv1
                          FROM (
                                   SELECT g.gdcd
                                        , SUM(g.gdcnt) cntsum
                                        , SUM(g.price) pricesum
                                        , SUM(sprice)  spricesum
                                        , SUM(oprice)  opricesum
                                   FROM od_goods g
                                            JOIN od_pay p ON g.paynum = p.paynum
                                   WHERE 1 = 1
                                     AND p.paystcd = '10'
                                      <![CDATA[
                                     AND p.paydt >= DATEADD(d, -1, CONVERT(CHAR (10), GETDATE(), 21))
                                   GROUP BY g.gdcd
                                      ]]>
                               ) a
                                   JOIN gd_master g ON a.gdcd = g.gdcd
                                   LEFT JOIN gd_cnt s ON g.gdcd = s.gdcd
                                   LEFT JOIN od_reservegoods r ON g.gdcd = r.gdcd
                                                              AND r.useyn = 'Y'
                                                              <![CDATA[
                                                              AND DATEDIFF(D, CONVERT(DATETIME, r.od_from, 120), GETDATE()) >= 0
                                                              AND DATEDIFF(D, GETDATE(), CONVERT(DATETIME, r.od_to, 120)) >= 0
                                                              ]]>
                           WHERE 1 = 1
                            AND ISNULL(s.gdcnt, 99999) > 0
                            AND g.exdiv1 NOT IN ('85', '90')
                            AND (g.useyn = 'Y' OR g.gdcd IN (SELECT gdcd
                                                             FROM od_reservegoods
                                                             WHERE useyn = 'Y'
                                                               <![CDATA[
                                                               AND od_from <= CONVERT(VARCHAR, GETDATE(), 23)
                                                               AND od_to >= CONVERT(VARCHAR, GETDATE(), 23)
                                                               ]]>
                                                             )
                                )
                            AND (g.reserveyn = 'N' OR (g.reserveyn = 'Y' AND r.gdcd IS NOT NULL))
                            AND (g.divcd = '30' OR (g.divcd = '20'
                                                    AND g.deliverydtyn = 'N'
                                                    AND g.gdcd NOT IN ('A3', 'A4', 'A7', 'A8', 'B2', 'B3', 'C3', 'G9', 'H6', 'H9', 'P9', 'R6', 'R9', 'T1','T2', 'T3', 'Z02', 'Z21', 'Z22', 'Z25', 'Z26', 'Z94')
                                                   )
                                )
                            <if test='strMEMGRPCD == "" or strMEMGRPCD.indexOf("219") lte 0'>
                                AND g.gdcd NOT IN
                                <foreach collection="isensExceptProduct" item="isensExceptProduct"  open="(" separator="," close=")">
                                    #{isensExceptProduct}
                                </foreach>
                            </if>
                            <if test="strMEMGRPCD == '' OR strMEMGRPCD.indexOf(userDefinedTarget) lte 0 ">
                                AND g.gdcd NOT IN (SELECT slgdcd FROM specialsellingl where slidx=468)
                             </if>
                             <if test="strMEMGRPCD == '' OR strMEMGRPCD.indexOf(userDefinedTarget2) lte 0">
                                AND g.gdcd NOT IN (SELECT slgdcd FROM specialsellingl where slidx = 641)
                             </if>
                             <if test=" 0 lte targetDate1 and targetDete2 gte 0">
                                 <if test="strMEMGRPCD == '' or strMEMGRPCD.indexOf(userDefinedTarget) lte 0">
                                     AND g.gdcd NOT IN (SELECT slgdcd FROM specialsellingl WHERE slidx = 784)
                                 </if>
                             </if>
                             <if test="0 lte targetDate3 and targetDate4 gte 0">
                                 <if test="strMEMGRPCD == '' or strMEMGRPCD.indexOf(userDefinedTarget3) lte 0">
                                     AND g.gdcd NOT IN (SELECT slgdcd FROM specialsellingl WHERE slidx = 792)
                                 </if>
                             </if>
                             <if test="strMEMGRPCD == '' or strMEMGRPCD.indexOf(userDefinedTarget) lte 0 ">
                                 AND g.gdcd NOT IN (SELECT slgdcd FROM specialsellingl WHERE slidx = 836)
                             </if>
                      ) b
                 <![CDATA[
                  WHERE b.gdrank <= 30
                 ]]>
             ) c
        <![CDATA[
        WHERE c.rndrank <= 4
        ]]>
    </select>

    <select id="isenseBestProd" parameterType="java.util.Map" resultType="com.x62life.mo.model.product.GdMasterEx">
        /*isenseBest 베스트 상품 */
        SELECT g.gdcd
             , gdname
             , g.gdimg
             , g.gdimg2
             , g.gdimg3
             , g.gdimg4
             , g.mgdimg1
             , g.dispatchtype
             , g.priceyn
             , ISNULL(g.qtysaleyn,'N') qtysaleyn
             , g.price1
             , dbo.getMasterPrice(g.gdcd) saleprice
             , g.exdiv1
             , g.exdiv2
             , g.divcd
             , g.div1
             , ISNULL(s.gdcnt,99999) gdcnt
             , g.minqty
             , g.maxqty
             , g.shortdesc
             , ISNULL(t.cdname,'미정') AS typename
             , ISNULL(g.recommendyn,'N') recommendyn
             , ISNULL(g.newyn,'N') newyn
             , ISNULL(g.thedaysyn,'N') thedaysyn
             , ISNULL(g.soldoutyn,'N') soldoutyn
             , CONVERT(CHAR(10),g.plandate,120) plandate
             , ISNULL(g.reserveyn,'N') reserveyn
             , c.cat1 cdcode
             , c.catdesc cdname
             , m.cat2 smenucd
             , m.subcatdesc smenudesc
             , g.explain
             , g.unit
             , i.address
             , i.origin
             , i.producer
             , ISNULL(r.od_from,'') od_from
             , ISNULL(r.od_to,'') od_to
             , ISNULL(r.dlv_from,'') dlv_from
             , ISNULL(r.dlv_to,'') dlv_to
             , CASE WHEN ISNULL(r.packunit,'') = '' THEN '' ELSE r.packunit END packunit
             , g.expdt
             , g.vat
             , g.limitdelivery
             , g.bestbeforedate
             , g.packaging
             , g.handling
             , g.precaution1
             , g.precaution2
             , g.importnote
             , g.addinformation
             , g.testidx
             , g.optionp
             , g.updt
             , g.subgdcd1
             , g.subgdcd2
             , g.subgdcd3
             , g.subgdcd4
             , g.subgdcd5
             , CASE WHEN r.type IS NOT NULL THEN r.type ELSE '01' END odtype2
             , g.scode
             , g.suprice
             , CASE g.dispatchtype WHEN 'I' THEN '11' WHEN 'O' THEN '15' END odtype
             , ISNULL(g.deliverydtyn,'N') deliverydtyn
             , ISNULL(g.reserveyn,'N') reserveyn
        FROM gd_master g
          LEFT JOIN gd_cnt s ON g.gdcd = s.gdcd
          LEFT JOIN gd_item i ON i.gdcd = g.gdcd
          LEFT JOIN od_reservegoods r ON g.gdcd = r.gdcd
                                     AND r.useyn = 'Y'
                                     <![CDATA[
                                     AND DATEDIFF(D,CONVERT(DATETIME,r.od_from,120),GETDATE()) >= 0
                                     AND DATEDIFF(D,GETDATE(),CONVERT(DATETIME,r.od_to,120)) >= 0
                                     ]]>
          LEFT JOIN cd_master t ON t.cdtype = '09'
                               AND t.cdcode = i.typecd
          LEFT JOIN exmenu c ON c.cat1 = g.exdiv1
                            AND c.useyn = 'Y'
          LEFT JOIN exsubmenu m ON m.cat1 = g.exdiv1
                               AND m.cat2 = g.exdiv2
                               AND m.useyn = 'Y'
        WHERE g.gdcd IN
                        <foreach collection="isenseFilteringProdGdcd" item="strBestItems" open="(" separator="," close=")">>
                             #{strBestItems}
                        </foreach>
           AND (g.reserveyn = 'N' OR (g.reserveyn = 'Y' AND r.gdcd IS NOT NULL))
        ORDER BY NEWID()
    </select>
</mapper>