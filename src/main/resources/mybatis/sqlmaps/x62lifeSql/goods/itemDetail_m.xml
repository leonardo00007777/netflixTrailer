<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="itemDetailCategory_a">
<!--    'System        : m.62life.com-->
<!--    'Program       :-->
<!--    'Title         : 자연이랑모바일 - 상품 카테고리별 보기-->
<!--    'File          : item_detail_m.asp-->
<!--    'Program Type  : asp-->
<!--    'Analyst       :-->
<!--    'Author        : hwkim-->
<!--    'Date Started  : 20130506-->
<!--    'Last Modified :-->
<!--    'Called By     :-->
<!--    'Parameters    :-->
<!--    'Purpose       :-->
<!--    'Version       :-->
    <select id="reservedProdList">
        /* reservedProdList preOrderInfo = "Y" 일 때 예약배송 상품 조회*/
        SELECT r.gdcd
             , r.gdnm AS gdname
             , r.unit
             , g.priceyn
             , r.gd_expalin AS explain
             , g.newyn
             , g.recommendyn
             , g.qtysaleyn
             , g.price1
             , dbo.getMasterPrice(g.gdcd) saleprice
             , dbo.getProductPrice(#{strMEMGRPCD}, #{strGroupSalePolicy}, g.gdcd) groupsaleprice
             , dbo.getIsGroupSaleGoods(#{strMEMGRPCD}, #{strGroupSalePolicy}, g.gdcd) isgroupsale
             , g.gdimg
             , r.divcd
             , r.divcd1 AS div1
             , c.cdcode
             , c.cdname
             , g.gdimg2
             , g.gdimg3
             , g.gdimg4
             , g.subgdcd1
             , g.subgdcd2
             , g.subgdcd3
             , g.subgdcd4
             , g.subgdcd5
             , g.shortdesc
             , g.expdt
             , g.vat
             , CASE WHEN ISNULL(g.deliverydtyn,'')='' THEN 'N' ELSE g.deliverydtyn END deliverydtyn
             , CASE WHEN ISNULL(g.thedaysyn,'')='' THEN 'N' ELSE g.thedaysyn END thedaysyn
             , CASE WHEN ISNULL(r.recommandyn,'')='' THEN 'N' ELSE r.recommandyn END recommendyn
             , CASE WHEN ISNULL(g.soldoutyn,'')='' THEN 'N' ELSE g.soldoutyn END soldoutyn
             , ISNULL( gc.gdcnt ,99999) gdcnt
             , i.origin
             , i.producer
             , i.address
             , ISNULL(t.cdname,'미지정') AS gradedesc
             , m.smenucd
             , m.smenudesc
             , r.od_from
             , r.od_to
             , r.dlv_from
             , r.dlv_to
             , i.typecd AS gdtype
             , t.cdname AS gdtypename
             , t.cdname AS typename
             , r.packunit
             , g.bestbeforedate
             , g.packaging
             , g.handling
             , g.precaution1
             , g.precaution2
             , g.addinformation
             , g.importnote
             , g.testidx
             , '' PLANDATE
             , g.DISPATCHTYPE DISPATCHTYPE
             , g.optionp
             , g.mpcode
             , ISNULL(r.alltimesale,'N') alltimesale
        FROM od_reservegoods r
          JOIN gd_master g ON g.gdcd = r.gdcd
          JOIN cd_master c ON c.cdtype = '20'
                          AND c.cdcode = r.divcd1
          LEFT JOIN gd_item i ON i.gdcd = r.gdcd
          LEFT JOIN cd_master t ON t.cdtype = '09'
                               AND t.cdcode = i.typecd
          LEFT JOIN submenu m ON m.category = r.divcd1
                             AND sub_category like '%'+ g.div2 + '%'
          LEFT JOIN gd_cnt gc ON gc.gdcd = r.gdcd
         WHERE 1 = 1
           AND CONVERT(CHAR(10),GETDATE(),120) BETWEEN r.od_from AND r.od_to
           AND r.useyn = 'Y'
           AND r.gdcd= #{strGDCD}
    </select>

    <select id="optionProductNo">
        /* noPreOrderInfo 옵션 상품 표시 여부 = N
            preOrderInfo = "N" */
        SELECT gdcd
             , gdname
             , price1
             , dbo.getMasterPrice(gdcd) saleprice
        FROM gd_master
         WHERE 1=1
         <choose>
             <when test="strOptionp == 'Y'">
                 AND ( gdcd IN (SELECT mpcode FROM gd_master WHERE gdcd= #{strGDCD} AND useyn='Y')
                            OR mpcode IN (SELECT gdcd FROM gd_master WHERE gdcd IN (SELECT mpcode FROM gd_master WHERE gdcd=#{strGDCD} AND useyn='Y'))
                     )
             </when>
             <otherwise>
                 AND (gdcd = #{strGDCD} OR mpcode IN (SELECT gdcd FROM gd_master WHERE gdcd = #{strGDCD} AND useyn='Y'))
             </otherwise>
         </choose>
        ORDER BY gdcd
    </select>

    <select id="optionProductYes">
        /* noPreOrderInfo 옵션 상품 표시 여부 = N
           preOrderInfo = "Y" */
        SELECT gdcd
             , gdname
             , price1
             , dbo.getMasterPrice(gdcd) saleprice
        FROM gd_master gm
         WHERE 1=1
           AND gdcd IN ( SELECT r.gdcd
                         FROM od_reservegoods r
                          WHERE r.gdcd = gm.gdcd
                            AND CONVERT(CHAR(10),GETDATE(),120) BETWEEN r.od_from AND r.od_to
                            AND r.useyn = 'Y'
                       )
         <choose>
             <when test="strOptionp == 'Y'">
                 AND (gdcd IN (SELECT mpcode FROM gd_master WHERE gdcd = #{strGDCD})
                           OR mpcode IN (SELECT gdcd FROM gd_master WHERE gdcd IN (SELECT mpcode FROM gd_master WHERE gdcd = #{strGDCD})))
             </when>
             <otherwise>
                 AND (gdcd = #{strGDCD}
                           OR mpcode IN (SELECT gdcd FROM gd_master WHERE gdcd = #{strGDCD}))
             </otherwise>
         </choose>
        ORDER BY gdcd
    </select>

    <select id="prodDefaultInfo">
        SELECT testpath
        FROM c_pesticide_residue
         WHERE testidx = #{strTestidx}
    </select>

    <select id="searchProdList">
        /*searchProdList 상품목록조회 (일반상품, 패키지 상품은 제외)*/
        SELECT g.gdcd
             , g.gdname
             , g.unit
             , g.priceyn
             , g.explain
             , g.newyn
             , g.recommendyn
             , g.qtysaleyn
             , g.price1
             , dbo.getMasterPrice(g.gdcd) saleprice
             , dbo.getProductPrice(#{strMEMGRPCD},#{strGroupSalePolicy}, g.gdcd) groupsaleprice
             , dbo.getIsGroupSaleGoods(#{strMEMGRPCD}, #{strGroupSalePolicy}, g.gdcd) isgroupsale
             , g.gdimg
             , g.divcd
             , g.div1
             , g.gdimg2
             , g.gdimg3
             , g.gdimg4
             , g.subgdcd1
             , g.subgdcd2
             , g.subgdcd3
             , g.subgdcd4
             , g.subgdcd5
             , g.shortdesc
             , g.expdt
             , g.vat
             , c.cdcode
             , c.cdname
             , CASE WHEN ISNULL(g.deliverydtyn,'')='' THEN 'N' ELSE g.deliverydtyn END deliverydtyn
             , CASE WHEN ISNULL(g.thedaysyn,'')='' THEN 'N' ELSE g.thedaysyn END thedaysyn
             , CASE WHEN ISNULL(g.recommendyn,'')='' THEN 'N' ELSE g.recommendyn END recommendyn
             , CASE WHEN ISNULL(g.soldoutyn,'')='' THEN 'N' ELSE g.soldoutyn END soldoutyn
             , ISNULL(s.gdcnt,99999) gdcnt
             , i.origin
             , i.producer
             , i.address
             , ISNULL(t.cdname,'미지정') AS gradedesc
             , m.smenucd
             , m.smenudesc
             , i.typecd AS gdtype
             , t.cdname AS gdtypename
             , t.cdname AS typename
             , '' packunit
             , g.bestbeforedate
             , g.packaging
             , g.handling
             , g.precaution1
             , g.precaution2
             , g.addinformation
             , g.importnote
             , g.testidx
             , CONVERT(CHAR(10),g.PLANDATE,120) PLANDATE
             , g.DISPATCHTYPE
             , g.optionp
             , g.mpcode
        FROM gd_master g
          JOIN cd_master c ON c.cdtype = '20'
                          AND c.cdcode = div1
          LEFT JOIN gd_cnt s ON g.gdcd = s.gdcd
          LEFT JOIN gd_item i ON i.gdcd = g.gdcd
          LEFT JOIN cd_master t ON t.cdtype = '09'
                               AND t.cdcode = i.typecd
          LEFT JOIN submenu m ON m.category = g.div1
                             AND sub_category like '%'+ g.div2 + '%'
         WHERE 1 = 1
           AND g.useyn = 'Y'
           <![CDATA[
           AND g.divcd <> '10'
           AND g.gdcd= #{strGDCD}
           ]]>
    </select>

    <select id="setProdDetailList">
        SELECT a.gdqty
             , b.gdname
        FROM (SELECT sgdcd
                   , gdqty
              FROM gd_week
               WHERE gdyear = #{strNowGDYear}
                 AND gdweek = #{strNowGDWeek}
                 AND gdcd = #{strGDCD}
                 <![CDATA[
                 AND sgdcd <> '*') A
          JOIN gd_master b ON a.sgdcd = b.gdcd
        ORDER BY b.gdname
                 ]]>
    </select>
</mapper>
