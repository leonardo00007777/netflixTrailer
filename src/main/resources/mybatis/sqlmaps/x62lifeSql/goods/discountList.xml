<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="discountList">
<!--    'System        : m.62life.com-->
<!--    'Program       :-->
<!--    'Title         : 자연이랑모바일 - 상품 페이지 단위로 가져오기-->
<!--    'File          : get_direct_list_m.asp-->
<!--    'Program Type  : asp-->
<!--    'Analyst       :-->
<!--    'Author        : hwkim-->
<!--    'Date Started  : 20161118-->
<!--    'Last Modified :-->
<!--    'Called By     :-->
<!--    'Parameters    :-->
<!--    'Purpose       :-->
<!--    'Version       :-->
<!--    '-->
<!--    'Modified   Author  V/M     Reason For Modification-->
<!--    '-&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;  &#45;&#45;&#45;&#45;&#45;&#45;  &#45;&#45;&#45;&#45;    &#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;-->
<!--    '20161116   hwkim   0.9     처음 작성-->
<!--    '20170102   hwkim   0.9.1   명절상품 제외 기준 동일하게 처리. / 명절상품은 별도(기획전 등) 게시-->
<!--    '20170329   hwkim   0.9.3   할인 가격 표시 변경-->
<!--    '20170420   hwkim   0.9.4   당일발송 주문 담기 처리 추가. / thedaysyn-->
<!--    '20170613   hwkim   0.9.5   당일발송 주문 담기 처리 제외 (1차범위)-->
<!--    '20180114   hwkim   0.9.6   상품표시 레이아웃 개선-->
<!--    '20180803   hwkim   0.9.7   상품등급 라벨 표시, 할인율 사각형스티커 변경 등-->
<!--    '사용자 정의 필터링 상품 - 첫구매(2019)이벤트 상품, 5월휴면고객특가-->
<!--    CUSTOM_FILTER_PRODUCT = "'43042719','91073305','05020034','99701120','1010000011','1010000031'"-->

    <select id="defProdOneProd">
        /* defProdOneProd 기본 단품 할인, 추천 상품*/
        SELECT a.exdiv1
             , c.catdesc
             , COUNT(gdcd) CNT
        FROM (
                 SELECT g.gdcd
                      , g.exdiv1
                 FROM gd_master g
                   LEFT JOIN od_reservegoods r ON g.gdcd = r.gdcd
                                              AND r.useyn = 'Y'
                                              <![CDATA[
                                              AND DATEDIFF(D,CONVERT(DATETIME,r.od_from,120),GETDATE()) >= 0
                                              AND DATEDIFF(D,GETDATE(),CONVERT(DATETIME,r.od_to,120)) >= 0
                                              ]]>
                  WHERE 1=1
                    AND (g.reserveyn = 'N' OR (g.reserveyn = 'Y' AND r.gdcd IS NOT NULL))
                    AND g.useyn = 'Y'
                    AND g.divcd = '30'
                    AND g.saleflag IN ('P','S')
                  <if test="strMEMGRPCD == '' or SK_EC.indexOf(strMEMGRPCD) lte 0 ">
                      AND r.gdcd NOT IN (SELECT slgdcd FROM specialsellingl WHERE slidx = 161)
                  </if>
                  <if test="strMEMGRPCD == '' or SK_CHEMICALS.indexOf(strMEMGRPCD) lte 0 ">
                      AND r.gdcd NOT IN (SELECT slgdcd FROM specialsellingl WHERE slidx = 160)
                  </if>
                  <if test="strMEMGRPCD = '' or CNTHOTH.indexOf(strMEMGRPCD) lte 0">
                      AND r.gdcd NOT IN (SELECT slgdcd FROM specialsellingl WHERE slidx = 162)
                  </if>
             ) a
          JOIN cd_master c ON c.cdtype = '20'
                          AND c.cdcode = a.div1
          JOIN exmenu c ON c.cat1 = a.exdiv1
         WHERE 1 = 1
         <if test="customFilterProduct">
             AND a.gdcd NOT IN (#{customFilterProduct})
         </if>
        GROUP BY a.exdiv1, c.catdesc
        ORDER BY a.exdiv1
    </select>
</mapper>