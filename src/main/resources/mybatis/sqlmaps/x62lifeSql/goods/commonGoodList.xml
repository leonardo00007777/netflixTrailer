<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="commonGoodList">
    <select id="getItemList">
/* getItemList 상품 리스트 가져오기*/
/* '리스팅 모드가 OPT 일 경우, 옵션 상품은 목록에 표시하지 않는다.
    LISTING_MODE = "OPT"
 */
        SELECT smenucd
             , smenudesc
             , sub_category
        FROM submenu
         WHERE category = #{strGDTYPE}
           AND smenucd LIKE #{strSmenucd}
    </select>

    <select id="getReserveItemListPaging">
        /* getReserveItemListPaging 페이지 계산 (업체직송상품) */
        SELECT CEILING( CAST(COUNT(1) AS FLOAT)/ #{intPagePerItem} ) MAXPAGE
             , COUNT(r.gdcd) CNT
        FROM od_reservegoods r
          JOIN gd_master g ON g.gdcd = r.gdcd
          JOIN cd_master c ON c.cdtype = '20'
                          AND c.cdcode = r.divcd1
          LEFT JOIN gd_item i ON i.gdcd = r.gdcd
          LEFT JOIN cd_master t ON t.cdtype = '09'
                               AND t.cdcode = i.typecd
          LEFT JOIN submenu m ON m.category = r.divcd1
                             AND sub_category like '%'+ g.div2 + '%'
         WHERE 1 = 1
           AND r.useyn='Y'
           <![CDATA[
           AND r.od_from <= CONVERT(CHAR(10), GETDATE(), 121) AND r.od_to >= CONVERT(CHAR(10), GETDATE(), 121)
           ]]>
           <if test="strOdtype2 == '02'">
               AND r.type = #{strOdtype2}
           </if>
           <if test="strGdtype != ''">
               AND g.div1 = #{strGdtype}
           </if>
           <if test="listingMode == 'OPT'">
               AND ISNULL(g.optionp,'N') = 'N'
           </if>
           <if test="strMEMGRPCD != '' or indexOf(spCustomerGroup) lte 0" >
               AND r.gdcd NOT IN (#{spProduct})
           </if>
           AND r.gdcd NOT IN (#{exceptProduct})
           <choose>
               <when test='orderBy == "PD"'>
                   ORDER BY groupsaleprice DESC
               </when>
               <when test='orderBy == "PU"'>
                   ORDER BY groupsaleprice
               </when>
               <when test='orderBy == "PP"'>
                   ORDER BY (dbo.getProductPrice(#{strMEMGRPCD},${strGroupSalePolicy}, gdcd)/price1), gdcd
               </when>
               <when test='orderBy == "PN"'>
                   ORDER BY gdname
               </when>
               <otherwise>
                   ORDER BY div1, smenucd, gdcd
               </otherwise>
           </choose>
    </select>

    <select id="getReserveItemList">
        /* getReserveItemList 상품목록조회 (업체직송상품)*/
        SELECT * FROM (
                          SELECT FLOOR( (ROW_NUMBER() OVER ( #{strOrderRef} ) - 1 ) / #{intPagePerItem} + 1) AS PAGE
                               , a.*
                            FROM (
                                 SELECT r.gdcd
                                      , r.gdnm AS gdname
                                      , r.unit
                                      , g.priceyn
                                      , r.gd_expalin AS explain
                                      , g.newyn
                                      , g.recommendyn
                                      , g.qtysaleyn
                                      , g.price1
                                      , dbo.getMasterPrice(g.gdcd) saleprice
                                      , dbo.getProductPrice(#{strMEMGRPCD}, #{strGroupSalePolicy}, g.gdcd) groupsaleprice
                                      , dbo.getIsGroupSaleGoods(#{strMEMGRPCD}, #{strGroupSalePolicy}, g.gdcd) isgroupsale
                                      , g.gdimg
                                      , g.mgdimg1
                                      , r.divcd
                                      , r.divcd1 AS div1
                                      , c.cdcode
                                      , c.cdname
                                      , CASE WHEN ISNULL(g.deliverydtyn,'')='' THEN 'N' ELSE g.deliverydtyn END deliverydtyn
                                      , CASE WHEN ISNULL(g.soldoutyn,'')='' THEN 'N' ELSE g.soldoutyn END soldoutyn
                                      , ISNULL(gc.gdcnt ,99999) gdcnt
                                      , i.origin
                                      , i.producer
                                      , i.address
                                      , ISNULL(t.cdname,'미지정') AS gradedesc
                                      , m.smenucd
                                      , m.smenudesc
                                      , r.od_from
                                      , r.od_to
                                      , r.dlv_from
                                      , r.dlv_to
                                      , r.alltimesale
                                      , r.type odtype2
                                      , g.thedaysyn
                                      , g.shortdesc
                                      , '12' odtype
                                 FROM od_reservegoods r
                                   JOIN gd_master g ON g.gdcd = r.gdcd
                                   JOIN cd_master c ON c.cdtype = '20'
                                                   AND c.cdcode = r.divcd1
                                   LEFT JOIN gd_item i ON i.gdcd = r.gdcd
                                   LEFT JOIN cd_master t ON t.cdtype = '09'
                                                        AND t.cdcode = i.typecd
                                   LEFT JOIN submenu m ON m.category = r.divcd1
                                                      AND sub_category like '%'+ g.div2 + '%'
                                   LEFT JOIN gd_cnt gc ON gc.gdcd = r.gdcd
                                  WHERE 1 = 1
                                    AND r.useyn='Y'
                                    <![CDATA[
                                    AND r.od_from <= CONVERT(CHAR(10), GETDATE(), 121)
                                    AND r.od_to >= CONVERT(CHAR(10), GETDATE(), 121)
                                    ]]>
                                    <if test="strOdtype2 != ''">
                                        AND r.type LIKE '%' + #{strOdtype2} + '%'
                                    </if>
                                    <if test="strGdtype != ''">
                                        AND g.div1 = #{strGdtype}
                                    </if>
                                    <if test="listingMode == 'OPT'">
                                        AND ISNULL(g.optionp,'N') = 'N'
                                    </if>
                                    <if test="strMEMGRPCD != '' or spCustomerGroup.indexOf(strMEMGRPCD) lte 0" >
                                        AND r.gdcd NOT IN (#{spProduct})
                                    </if>
                                    AND r.gdcd NOT IN (#{exceptProduct})
                                 ) a
                          WHERE 1=1
                      ) AS pl
        WHERE PAGE = #{intPage}
    </select>

    <select id="getItemListPaging">
         /*getItemListPaging 일반 상품 페이징(업체직송X)*/
        SELECT CEILING(CAST(COUNT(1) AS FLOAT) / #{intPagePerItem}) MAXPAGE
             , COUNT(gdcd) CNT
        FROM (
                 SELECT '11' odtype
                      , g.gdcd
                      , '01' odtype2
                 FROM gd_master g
                   JOIN cd_master c ON c.cdtype = '20'
                                   AND c.cdcode = div1
                   LEFT JOIN gd_cnt s ON g.gdcd = s.gdcd
                   LEFT JOIN gd_item i ON i.gdcd = g.gdcd
                   LEFT JOIN submenu m ON m.category = g.div1
                                      AND sub_category like '%'+ g.div2 + '%'
                  WHERE 1 = 1
                    AND g.useyn = 'Y'
                    AND (divcd = '30' OR ( divcd = '20'
                                     AND  deliverydtyn = 'N'
                                     AND  g.gdcd NOT IN ('A3','A4','A7','A8','B2','B3','C3','G9','H6','H9','P9','R6','R9','T1','T2','T3','Z02','Z21','Z22','Z25','Z26','Z94')
                                         )
                        )
                    <if test="listingMode == 'OPT'">
                        AND ISNULL(g.optionp,'N') = 'N'
                    </if>
                    <if test="strGdtype != ''">
                        AND g.div1 = #{strGdtype}
                    </if>
                    <if test="strGdtype == ''">
                        AND g.div1 IN (#{strGdtypeIn})
                    </if>
                    <if test="strSmenucd != '%' and strRs1SmenuCd != ''">
                        AND g.div2 IN (#{strRs1Sub_category})
                    </if>
                    <if test="strDivCd != ''">
                        g.divcd LIKE #{strDivCd}
                    </if>
                   UNION ALL
                   SELECT '12' odtype
                         , r.gdcd
                         , r.type odtype2
                   FROM od_reservegoods r
                     JOIN gd_master g ON r.gdcd = g.gdcd
                     LEFT JOIN gd_cnt gc ON gc.gdcd = r.gdcd
                     LEFT JOIN gd_item i ON i.gdcd = g.gdcd
                     LEFT JOIN cd_master t6 ON t6.cdtype = '09'
                                           AND t6.cdcode = i.typecd
                     LEFT JOIN submenu m ON m.category = g.div1
                                           AND sub_category LIKE '%'+ g.div2 + '%'
                   WHERE r.useyn = 'Y'
                   <![CDATA[
                     AND r.od_from <= CONVERT(VARCHAR,GETDATE(),23)
                     AND r.od_to >= CONVERT(VARCHAR,GETDATE(),23)
                   ]]>
                   <if test="listingMode == 'OPT'">
                      AND ISNULL(g.optionp,'N') = 'N'
                   </if>
                   <if test="strGdtype != ''">
                      AND g.div1 = #{strGdtype}
                   </if>
                   <if test="strGdtype == ''">
                      AND g.div1 IN (#{strGdtypeIn})
                   </if>
                   <if test="strSmenucd != '%' and strRs1SmenuCd != ''">
                      AND g.div2 IN (#{strRs1Sub_category})
                   </if>
                   <if test="strDivCd != ''">
                      g.divcd LIKE #{strDivCd}
                   </if>
                     AND r.gdcd NOT IN (#{exceptProduct})
              ) a
        WHERE 1=1
        <if test="strOdtype != ''">
            AND a.odtype = #{strOdtype}
        </if>
        <if test="strOdtype2 != ''">
            AND a.odtype2 LIKE #{strOdtype2}
        </if>
    </select>

    <select id="getItemListSearch">
        /* getItemListSearch 상품목록조회 (통합)*/
        SELECT * FROM (
                          SELECT FLOOR( (ROW_NUMBER() OVER ( #{strOrderRef} ) - 1 ) / #{intPagePerItem} + 1) AS PAGE
                               , a.*
                          FROM (
                                 SELECT '11' odtype
                                      , g.gdcd
                                      , g.gdname
                                      , g.unit
                                      , g.priceyn
                                      , g.newyn
                                      , g.recommendyn
                                      , g.qtysaleyn
                                      , g.price1
                                      , dbo.getMasterPrice(g.gdcd) saleprice
                                      , dbo.getProductPrice(#{strMEMGRPCD}, #{strGroupSalePolicy}, g.gdcd) groupsaleprice
                                      , dbo.getIsGroupSaleGoods(#{strMEMGRPCD}, #{strGroupSalePolicy}, g.gdcd) isgroupsale
                                      , g.gdimg
                                      , g.mgdimg1
                                      , g.divcd
                                      , g.div1
                                      , c.cdcode
                                      , c.cdname
                                      , CASE WHEN ISNULL(g.deliverydtyn,'')='' THEN 'N' ELSE g.deliverydtyn END deliverydtyn
                                      , CASE WHEN ISNULL(g.soldoutyn,'')='' THEN 'N' ELSE g.soldoutyn END soldoutyn, ISNULL(s.gdcnt,99999) gdcnt
                                      , '' od_from
                                      , '' od_to
                                      , '' dlv_from
                                      , '' dlv_to
                                      , '-' alltimesale
                                      , i.origin
                                      , i.producer
                                      , i.address
                                      , ISNULL(t.cdname,'미지정') AS gradedesc
                                      , m.smenucd
                                      , m.smenudesc
                                      , '01' odtype2
                                      , g.thedaysyn
                                      , g.shortdesc
                                 FROM gd_master g
                                   JOIN cd_master c ON c.cdtype = '20'
                                                   AND c.cdcode = g.div1
                                   LEFT JOIN gd_cnt s ON g.gdcd = s.gdcd
                                   LEFT JOIN gd_item i ON i.gdcd = g.gdcd
                                   LEFT JOIN cd_master t ON t.cdtype = '09'
                                                        AND t.cdcode = i.typecd
                                   LEFT JOIN submenu m ON m.category = g.div1
                                                      AND sub_category like '%'+ g.div2 + '%'
                                  WHERE 1 = 1
                                    AND g.useyn = 'Y'
                                    AND (divcd = '30' OR (divcd = '20'
                                                     AND deliverydtyn = 'N'
                                                     AND g.gdcd NOT IN ('A3','A4','A7','A8','B2','B3','C3','G9','H6','H9','P9','R6','R9','T1','T2','T3','Z02','Z21','Z22','Z25','Z26','Z94')
                                                         )
                                        )
                                  <if test="listingMode == 'OPT'">
                                      AND ISNULL(g.optionp,'N') = 'N'
                                  </if>
                                  <if test="strGdtype != ''">
                                      AND g.div1 = #{strGdtype}
                                  </if>
                                  <if test="strGdtype == ''">
                                      AND g.div1 IN (#{strGdtypeIn})
                                  </if>
                                  <if test="strSmenucd != '%' and strRs1SmenuCd != ''">
                                      AND g.div2 IN (#{strRs1Sub_category})
                                  </if>
                                  <if test="strDivCd != ''">
                                      g.divcd LIKE #{strDivCd}
                                  </if>
                                 UNION ALL
                                 SELECT '12' odtype
                                      , g.gdcd
                                      , g.gdname
                                      , g.unit
                                      , g.priceyn
                                      , g.newyn
                                      , g.recommendyn
                                      , g.qtysaleyn
                                      , g.price1
                                      , dbo.getMasterPrice(g.gdcd) saleprice
                                      , dbo.getProductPrice(#{strMEMGRPCD}, #{strGroupSalePolicy}, g.gdcd) groupsaleprice
                                      , dbo.getIsGroupSaleGoods(#{strMEMGRPCD}, #{strGroupSalePolicy} ,g.gdcd) isgroupsale
                                      , g.gdimg
                                      , g.mgdimg1
                                      , g.divcd
                                      , g.div1
                                      , c.cdcode
                                      , c.cdname
                                      , CASE WHEN ISNULL(g.deliverydtyn,'')='' THEN 'N' ELSE g.deliverydtyn END deliverydtyn
                                      , CASE WHEN ISNULL(g.soldoutyn,'')='' THEN 'N' ELSE g.soldoutyn END soldoutyn
                                      , ISNULL(s.gdcnt,99999) gdcnt
                                      , r.od_from
                                      , r.od_to
                                      , r.dlv_from
                                      , r.dlv_to
                                      , r.alltimesale
                                      , i.origin
                                      , i.producer
                                      , i.address
                                      , ISNULL(t.cdname,'미지정') AS gradedesc
                                      , m.smenucd
                                      , m.smenudesc
                                      , r.type odtype2
                                      , g.thedaysyn
                                      , g.shortdesc
                                 FROM od_reservegoods r
                                   JOIN gd_master g ON r.gdcd = g.gdcd
                                   JOIN cd_master c ON c.cdtype = '20'
                                                   AND c.cdcode = g.div1
                                   LEFT JOIN gd_cnt s ON s.gdcd = r.gdcd
                                   LEFT JOIN gd_item i ON i.gdcd = g.gdcd
                                   LEFT JOIN cd_master t ON t.cdtype = '09'
                                                        AND t.cdcode = i.typecd
                                   LEFT JOIN submenu m ON m.category = g.div1
                                                      AND sub_category LIKE '%'+ g.div2 + '%'
                                  WHERE r.useyn = 'Y'
                                  <![CDATA[
                                    AND r.od_from <= CONVERT(VARCHAR,GETDATE(),23)
                                    AND r.od_to >= CONVERT(VARCHAR,GETDATE(),23)
                                  ]]>
                                <if test="listingMode == 'OPT'">
                                    AND ISNULL(g.optionp,'N') = 'N'
                                </if>
                                <if test="strGdtype != ''">
                                    AND g.div1 = #{strGdtype}
                                </if>
                                <if test="strGdtype == ''">
                                    AND g.div1 IN (#{strGdtypeIn})
                                </if>
                                <if test="strSmenucd != '%' and strRs1SmenuCd != ''">
                                    AND g.div2 IN (#{strRs1SubCategory})
                                </if>
                                <if test="strDivCd != ''">
                                    g.divcd LIKE #{strDivCd}
                                </if>
                                    AND r.gdcd NOT IN (#{exceptProduct})
                             ) a
                    WHERE 1=1
                    <if test="strOdtype != ''">
                        AND a.odtype = #{strOdtype}
                    </if>
                    <if test="strOdtype2 != ''">
                        AND a.odtype2 LIKE #{strOdtype2}
                    </if>
                 ) AS pl
               WHERE PAGE = #{intPage}
    </select>
</mapper>