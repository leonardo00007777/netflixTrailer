<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="specialSelling1">
<!--    'System        : m.62life.com-->
<!--    'Program       :-->
<!--    'Title         : 자연이랑모바일 - 기획전 상세-->
<!--    'File          : specialselling1_m.asp-->
<!--    'Program Type  : asp-->
<!--    'Analyst       :-->
<!--    'Author        : hwkim-->
<!--    'Date Started  : 20120525-->
<!--    'Last Modified :-->
<!--    'Called By     :-->
<!--    'Parameters    :-->
<!--    'Purpose       :-->
<!--    'Version       :-->
<!--    '-->
<!--    'Modified   Author  V/M     Reason For Modification-->
<!--    '-&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;  &#45;&#45;&#45;&#45;&#45;&#45;  &#45;&#45;&#45;&#45;    &#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;-->
<!--    '20130506   hwkim   0.9     처음 작성-->
<!--    '20140717   hwkim   0.9.1   인기상품 슬라이더 추가-->
<!--    '20140818   hwkim   0.9.2   메인그림에 링크 추가-->
<!--    '20150213   sykim   0.9.3   쿼리튜닝.-->
<!--    '20151111   hwkim   0.9.2   상품 리스트 표시 디자인 통일-->
<!--    '20160823   hwkim   0.9.3   에스케이케미칼 사업장 및 관계사 그룹 표시 적용-->
<!--    '20161201   hyeok   0.9.4   사이트 리뉴얼 layout적용-->
<!--    '20161210   hwkim   0.9.5   표준 레이아웃 및 기능 추가 정리 처리-->
<!--    '20161230   hwkim   0.9.6   카테고리 선택 기능 추가-->
<!--    '20170314   hwkim   0.9.7   정렬 기능 추가, specialselling1_sort_m 으로 부터-->
<!--    '20170329   hwkim   -       할인 가격 표시 변경-->
<!--    '20170420   hwkim   0.9.8   당일발송 주문 담기 처리 추가. / thedaysyn-->
<!--    '20170515   hwkim   0.9.9   기획전 추천상품(Top 표시) 표시 처리 추가.-->
<!--    '20170613   hwkim   1.0     당일발송 주문 담기 처리 제외 (1차범위)-->
<!--    '20180125   hwkim   1.0.1   상품표시 방식 변경-->
<!--    '20180420   hyeok   1.0.2   기획전 시행기간 범위 확장 (기간 -> 일시)-->
<!--    '20180425   hwkim   1.0.3   타이틀 표시 유무 처리 및 기획전 표시 기능 추가.-->
<!--    '20180427   hwkim   1.1     전문관을 위해 개선된 디자인 적용-->
<!--    '20180529   hwkim   1.1.1   카테고리 배너 표시 기능 추가-->
<!--    '20180710   hwkim   -       검색을 위한 Swiper 라이브러리 상위버전 적용-->
<!--    '20180813   hwkim   1.1.2   상품등급 라벨 표시, 할인율 사각형스티커 변경 등-->
<!--    '20181023   hwkim   1.1.3   상품명 표시 특수문자에 의한 분리규칙 추가-->
<!--    '20200324   sykim   1.1.4   상품정보 단일화(gd_master & od_reservegoods > gd_master) 적용-->
<!--    '20200409   chhyeon 1.1.5   디자인팀 요청 - 상단 select 박스-> 버튼-->
<!--    '20200625   chhyeon 1.1.6   user3 추가-->
    <select id="specialSellingDefaultCategory">
       /*specialSellingDefaultCategory 기획전 기본 카테고리*/
        SELECT c.cat1
             , c.catdesc
             , COUNT(x.slgdcd) CNT
        FROM specialsellingl x
          JOIN gd_master g ON x.slgdcd = g.gdcd
          JOIN exmenu c ON g.exdiv1 = c.cat1
          LEFT JOIN od_reservegoods r
                 ON g.gdcd = r.gdcd
                 AND r.useyn = 'Y'
                 <![CDATA[
                 AND DATEDIFF(D,CONVERT(DATETIME,r.od_from,120),GETDATE()) >= 0
                 AND DATEDIFF(D,GETDATE(),CONVERT(DATETIME,r.od_to,120)) >= 0
                 ]]>
         WHERE x.slidx = #{sidx}
           AND g.useyn = 'Y'
           AND (g.reserveyn = 'N' OR (g.reserveyn = 'Y' AND r.gdcd IS NOT NULL))
         <if test="listingMode == 'OPT'">
             AND ISNULL(g.optionp,'N') = 'N'
         </if>
        GROUP BY c.cat1, c.catdesc
        ORDER BY cat1
    </select>

    <select id="specialSellingUserCategory">
        /*specialSellingDefaultCategory 기획전 유저 설정 카테고리*/
        SELECT x.slcat cdcode
             , COUNT(x.slcat) CNT
        FROM specialsellingl x
          JOIN gd_master g ON x.slgdcd = g.gdcd
          LEFT JOIN od_reservegoods r ON g.gdcd = r.gdcd
                                     AND r.useyn = 'Y'
                                 <![CDATA[
                                    AND DATEDIFF(D,CONVERT(DATETIME,r.od_from,120),GETDATE()) >= 0
                                    AND DATEDIFF(D,GETDATE(),CONVERT(DATETIME,r.od_to,120)) >= 0
                                 ]]>
         WHERE x.slidx = #{sidx}
           AND g.useyn = 'Y'
           AND (g.reserveyn = 'N' OR (g.reserveyn = 'Y' AND r.gdcd IS NOT NULL))
           <if test="listingMode == 'OPT'">
             AND ISNULL(g.optionp,'N') = 'N'
           </if>
        GROUP BY x.slcat
        ORDER BY x.slcat
    </select>

    <select id="specialSellingTopTen">
        /*specialSellingTopTen 기획전 top 10 */
        SELECT TOP 10 shidx
             , shtitle
             , grpcd
        FROM specialsellingh
         WHERE 1 = 1
           AND shrtype = #{shrtype}
         <![CDATA[
           AND shstartdt <= GETDATE()
           AND shenddt >= GETDATE()
         ]]>
         <choose>
             <when test="rsshlevel == '1'">
                 ND shlevel = #{rsshlevel}
             </when>
             <otherwise>
                 AND shlevel = #{rsshlevel}
                 AND shrelidx = #{rsshrelidx}
             </otherwise>
         </choose>
        <![CDATA[
          AND ISNULL(shhideyn,'N') <> 'Y'
        ]]>
        ORDER BY ISNULL(grpcd,''), shidx DESC
    </select>
</mapper>