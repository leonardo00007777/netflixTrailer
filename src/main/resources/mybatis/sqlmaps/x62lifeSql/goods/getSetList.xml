<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="getSetList">
<!--    'System        : m.62life.com-->
<!--    'Program       :-->
<!--    'Title         : 자연이랑모바일 - 상품 페이지 단위로 가져오기-->
<!--    'File          : get_direct_list_m.asp-->
<!--    'Program Type  : asp-->
<!--    'Analyst       :-->
<!--    'Author        : hwkim-->
<!--    'Date Started  : 20161118-->
<!--    'Last Modified :-->
<!--    'Called By     :-->
<!--    'Parameters    :-->
<!--    'Purpose       :-->
<!--    'Version       :-->
<!--    '-->
<!--    'Modified   Author  V/M     Reason For Modification-->
<!--    '20161116   hwkim   0.9     처음 작성-->
<!--    '20170329   hwkim   0.9.1   할인 가격 표시 변경-->
<!--    '20180803   hwkim   0.9.2   상품등급 라벨 표시, 할인율 사각형스티커 변경 등-->
<!--    '하나은행VIP(아이센스) 대상상품 필터링-->
<!--    ISENS_EXCEPT_PRODUCT = "'B11','B12','B13','B14'"-->
    <select id="setListPaging">
        /*setListPaging 세트리스트 페이징*/
        SELECT CEILING( CAST(COUNT(1) AS FLOAT)/ #{intPagePerItem} ) MAXPAGE
             , COUNT(g.gdcd) CNT
        FROM gd_master g
          JOIN cd_master c ON c.cdtype = '20'
                          AND c.cdcode = div1
          LEFT JOIN gd_cnt s ON g.gdcd = s.gdcd
          LEFT JOIN gd_item i ON i.gdcd = g.gdcd
         WHERE 1 = 1
           AND g.useyn = 'Y'
           AND g.divcd = '20' AND g.div1 IN ('80')
         <foreach collection="java.util.List" item="setList" >
           AND (g.gdcd IN (#{setList})
                       OR g.div2 IN ('01','04','05','10','20','70')
               )
           </foreach>
           AND g.divcd = '20'
           AND g.useyn = 'Y'
           AND g.gdcd IN (SELECT gdcd FROM gd_set WHERE gdsetyn='Y')
           <if test='strMEMGRPCD == "" OR strMEMGRPCD.indexOf("219") lte 0'>
             AND g.gdcd NOT IN (#{isensExceptProduct})
           </if>
    </select>

    <select id="setListProd">
        /*setListPaging 세트 상품 리스트*/
        SELECT * FROM (
                          SELECT FLOOR( (ROW_NUMBER() OVER ( ORDER BY g.gdcd ) - 1 ) / #{intPagePerItem} + 1) AS PAGE
                               , g.gdcd
                               , g.gdname
                               , g.unit
                               , g.priceyn
                               , g.newyn
                               , g.recommendyn
                               , g.qtysaleyn
                               , g.price1
                               , dbo.getMasterPrice(g.gdcd) saleprice
                               , dbo.getProductPrice(#{strMEMGRPCD}, #{strGroupSalePolicy}, g.gdcd) groupsaleprice
                               , dbo.getIsGroupSaleGoods( #{strMEMGRPCD}, #{strGroupSalePolicy}, g.gdcd) isgroupsale
                               , g.gdimg
                               , g.divcd
                               , g.div1
                               , c.cdcode
                               , c.cdname
                               , CASE WHEN ISNULL(g.deliverydtyn,'')='' THEN 'N' ELSE g.deliverydtyn END deliverydtyn
                               , CASE WHEN ISNULL(g.soldoutyn,'')='' THEN 'N' ELSE g.soldoutyn END soldoutyn
                               , ISNULL(s.gdcnt,99999) gdcnt
                               , i.origin
                               , i.producer
                               , i.address
                               , ISNULL(t.cdname,'미지정') AS gradedesc
                               , g.thedaysyn
                               , g.shortdesc
                          FROM gd_master g
                            JOIN cd_master c ON c.cdtype = '20'
                                            AND c.cdcode = div1
                            LEFT JOIN gd_cnt s ON g.gdcd = s.gdcd
                            LEFT JOIN gd_item i ON i.gdcd = g.gdcd
                            LEFT JOIN cd_master t ON t.cdtype = '09'
                                                 AND t.cdcode = i.typecd
                           WHERE 1 = 1
                             AND g.useyn = 'Y'
                             AND g.divcd = '20'
                             AND g.div1 IN ('80')
                           <foreach collection="java.util.List" item="setList" >
                             AND (g.gdcd IN (#{setList})
                                         OR g.div2 IN ('01','04','05','10','20','70')
                                 )
                           </foreach>
                             AND g.divcd = '20'
                             AND g.useyn = 'Y'
                             AND g.gdcd IN (SELECT gdcd FROM gd_set WHERE gdsetyn='Y')
                           <if test='strMEMGRPCD == "" OR strMEMGRPCD.indexOf("219") lte 0'>
                             AND g.gdcd NOT IN (#{isensExceptProduct})
                           </if>
                      ) AS pl
        WHERE PAGE = #{intPage}
    </select>
</mapper>