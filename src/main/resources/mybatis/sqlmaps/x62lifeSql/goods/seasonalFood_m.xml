<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="seasonalFood_m">
<!--    'System        : m.62life.com-->
<!--    'Program       :-->
<!--    'Title         : 제철관(모바일)-->
<!--    'File          : seasonalfood_m.asp-->
<!--    'Program Type  : asp-->
<!--    'Analyst       :-->
<!--    'Author        : chhyeon-->
<!--    'Date Started  : 20200805-->
<!--    'Last Modified :-->
<!--    'Called By     :-->
<!--    'Parameters    :-->
<!--    'Purpose       :-->
<!--    'Version       :-->
<!--    '-->
<!--    'Modified   Author  V/M     Reason For Modification-->

<!--    '20200805   chhyeon   0.9     초안작성-->
    <select id="seasonalFoodTopOne">
        SELECT TOP 1 *
        FROM SEASONAL_FOODHALL
         WHERE sfusyn = 'Y'
         <![CDATA[
           AND sfstdt <= GETDATE()
           AND sfeddt > GETDATE()
         ]]>
        <choose>
            <when test="strSfidx != ''">
                AND sfidx = #{strSfidx}
            </when>
            <otherwise>
                ORDER BY sfsort, sfstdt, sfidx
            </otherwise>
        </choose>
    </select>

    <select id="seasonalFoodCntOne">
        SELECT COUNT(1) sfcnt
        FROM SEASONAL_FOODHALL
         WHERE sfusyn = 'Y'
          <![CDATA[
           AND sfstdt <= GETDATE()
           AND sfeddt > GETDATE()
          ]]>
    </select>

    <select id="seasonalFoodSelect">
        SELECT sfshort, sfidx
        FROM SEASONAL_FOODHALL
         WHERE sfusyn = 'Y'
          <![CDATA[
           AND sfstdt <= GETDATE()
           AND sfeddt > GETDATE()
          ]]>
        ORDER BY sfsort, sfstdt, sfidx
    </select>

    <select id="seasonalFoodRecommendProdCheck">
        SELECT COUNT(1) prodcnt
        FROM SEASONAL_FOODHALL_PROD
         WHERE sfpidx = #{strSfidx}
           AND sfpusyn = 'Y'
    </select>

    <select id="seasonalFoodProdList">
        SELECT g.gdcd
             , gdname
             , g.unit
             , g.price1
             , g.gdimg
             , g.divcd
             , g.div1
             , g.div2
             , g.indt
             , g.updt
             , g.shortdesc
             , dbo.getMasterPrice(g.gdcd) saleprice
             , dbo.getProductPrice(#{strMEMGRPCD}, #{strGroupSalePolicy}, g.gdcd) groupsaleprice
             , dbo.getIsGroupSaleGoods(#{strMEMGRPCD}, #{strGroupSalePolicy},g.gdcd) isgroupsale
             , CASE WHEN ISNULL(g.soldoutyn,'N')='N' THEN 'N' ELSE g.soldoutyn END soldoutyn
             , ISNULL(g.newyn,'N') newyn
             , ISNULL(g.qtysaleyn,'N') qtysaleyn
             , g.recommendyn
             , g.plandate
             , ISNULL(c.gdcnt,99999) gdcnt
             , g.thedaysyn
             , g.optionp
             , g.priceyn
             , g.mgdimg1
             , g.dispatchtype
             , ISNULL(r.od_from,'') od_from
             , ISNULL(r.od_to,'') od_to
             , ISNULL(r.dlv_from,'') dlv_from
             , ISNULL(r.dlv_to,'') dlv_to
             , ISNULL(r.alltimesale,'-') alltimesale
             , i.origin
             , i.producer
             , i.address
             , CASE g.dispatchtype WHEN 'I' THEN '11' WHEN 'O' THEN '15' END odtype
             , ISNULL(g.deliverydtyn,'N') deliverydtyn
             , ISNULL(g.reserveyn,'N') reserveyn
             , g.exdiv2
             , sfp.sfpsort
        FROM gd_master g
          LEFT JOIN gd_cnt c ON c.gdcd = g.gdcd
          LEFT JOIN gd_item i ON i.gdcd = g.gdcd
          LEFT JOIN od_reservegoods r ON g.gdcd = r.gdcd
                                     AND r.useyn = 'Y'
                                    <![CDATA[
                                     AND DATEDIFF(D,CONVERT(DATETIME,r.od_from,120),GETDATE()) >= 0
                                     AND DATEDIFF(D,GETDATE(),CONVERT(DATETIME,r.od_to,120)) >= 0
                                     ]]>
          JOIN seasonal_foodhall_prod sfp ON  sfp.sfpgdcd = g.gdcd
         WHERE 1=1
           AND g.useyn = 'Y'
           AND (g.reserveyn = 'N' OR (g.reserveyn = 'Y' AND r.gdcd IS NOT NULL))
           AND (g.divcd = '30' OR (  g.divcd='20'
                                     AND g.deliverydtyn = 'N'
                                     AND g.gdcd NOT IN ('A3','A4','A7','A8','B2','B3','C3','G9','H6','H9','P9','R6','R9','T1','T2','T3','Z02','Z21','Z22','Z25','Z26','Z94')
                                   )
               )
          AND sfp.sfpidx = #{strSfidx}
          AND sfp.sfpusyn = 'Y'
        ORDER BY CASE sfp.sfpsort WHEN 0
                                    THEN 99
                                  ELSE sfp.sfpsort
                 END
    </select>
</mapper>