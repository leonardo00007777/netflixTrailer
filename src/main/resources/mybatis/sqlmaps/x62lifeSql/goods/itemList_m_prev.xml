<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="itemList_m_prev">
<!--    'System        : m.62life.com-->
<!--    'Program       :-->
<!--    'Title         : 자연이랑모바일 - 상품 카테고리별 보기-->
<!--    'File          : item_list_m.asp-->
<!--    'Program Type  : asp-->
<!--    'Analyst       :-->
<!--    'Author        : hwkim-->
<!--    'Date Started  : 20120525-->
<!--    'Last Modified :-->
<!--    'Called By     :-->
<!--    'Parameters    :-->
<!--    'Purpose       :-->
<!--    'Version       :-->
<!--    '-->
<!--    'Modified   Author  V/M     Reason For Modification-->

<!--    '20130506   hwkim   0.9     처음 작성-->
<!--    '20140306   hwkim   0.9.1   하위 카테고리 네비게이션 바 추가-->
<!--    '20140703   hwkim   0.9.2   한 페이지 더보기 처리 버튼 기능 추가-->
<!--    '20140705   hwkim   0.9.3   목록 자동 스크롤-->
<!--    '20140710   hwkim   0.9.4   스크롤 시 자동 목록 추가 스크립트 미작동 브라우저를 위해 하단 버튼 표시-->
<!--    '20140905   hwkim   0.9.5   상단 카테고리 스크롤 시 상단 고정-->
<!--    '20141212   hwkim   0.9.6   스크롤 시 자동 목록 추가 스크립트 기본값 제거-->
<!--    '20141216   hwkim   0.9.7   뒤로가기 처리 (Ajax back), 그리드 보기 형식 기본-->
<!--    '20141229   hwkim   0.9.8   상품보기 디자인 변경-->
<!--    '20151110   hwkim   -       상품보기 리스트 형식 디자인 변경-->
<!--    '20161121   hwkim   0.9.9   리뉴얼 + 선택한 하위 카테고리 표시-->
    <select id="reservedProdCategory">
        /*
        reservedProdCategory
        strOdtype = "12" then
        '예약상품일 경우 카테고리를 표시
        */
        SELECT c.cdcode
             , c.cdname
             , COUNT(1) CNT
        FROM od_reservegoods r
          JOIN gd_master g ON g.gdcd = r.gdcd
          JOIN cd_master c ON c.cdtype = '20'
                          AND c.cdcode = r.divcd1
         WHERE 1 = 1
           AND r.useyn='Y'
           <![CDATA[
           AND r.od_from <= CONVERT(CHAR(10), GETDATE(), 121) AND r.od_to >= CONVERT(CHAR(10), GETDATE(), 121)
           AND r.type = #{strOdtype2}
           ]]>
         <if test='strMEMGRPCD == "" OR spCustomerGroup.indexOf(strMEMGRPCD) lte 0'>
             AND r.gdcd NOT IN (#{spProduct})
         </if>
        GROUP BY c.cdcode, c.cdname
        ORDER BY c.cdcode
    </select>

    <select id="normalProdCategory">
        /*normalProdCategory 일반상품일 경우 하위 카테고리 표시*/
        SELECT smenucd
             , smenudesc
        FROM submenu
         WHERE category = #{strGdtype}
           AND useyn='Y'
    </select>

    <select id="prodSubMenu">
        /*
          prodSubMenu
          strOdtype = "12" Or strSmenucd = "%"
          상품 서브메뉴
          (한우, 돈육, 닭/오리, 기타 ...) 예약상품일경우 더미처리
        */
        SELECT TOP 1 '' smenucd
             , '' smenudesc
             , '' sub_category
        FROM submenu
    </select>

    <select id="otherProdSubMenu">
       /*otherProdSubMenu 그 외 서브메뉴 */
        SELECT smenucd
             , smenudesc
             , sub_category
        FROM submenu
         WHERE category = #{strGdtype}
           AND smenucd LIKE #{strSmenucd}
    </select>

    <select id="prevProdListPaging">
         /*prevProdListPaging  strOdtype = "12" = 예약배송상품 페이징*/
        SELECT CEILING( CAST(COUNT(1) AS FLOAT)/ #{intPagePerItem} ) MAXPAGE
             , COUNT(r.gdcd) CNT
        FROM od_reservegoods r
          JOIN gd_master g ON g.gdcd = r.gdcd
          JOIN cd_master c ON c.cdtype = '20'
                          AND c.cdcode = r.divcd1
          LEFT JOIN gd_item i ON i.gdcd = r.gdcd
          LEFT JOIN cd_master t ON t.cdtype = '09' AND t.cdcode = i.typecd
          LEFT JOIN submenu m ON m.category = r.divcd1
                             AND sub_category
                            LIKE '%'+ g.div2 + '%'
         WHERE 1 = 1
            AND r.useyn='Y'
           <![CDATA[
            AND r.od_from <= CONVERT(CHAR(10), GETDATE(), 121) AND r.od_to >= CONVERT(CHAR(10), GETDATE(), 121)
            ]]>
           <if test="strGdtype != ''">
               AND g.div1 = #{strGdtype}
           </if>
           AND r.type = #{strOdtype2}
           <if test='strMEMGRPCD == "" OR spCustomerGroup.indexOf(strMEMGRPCD) lte 0'>
               AND r.gdcd NOT IN (#{spProduct})
           </if>
    </select>

    <select id="searchReservedProd">
        /* searchReservedProd 상품목록조회 (예약배송상품) */
        SELECT * FROM (
                         SELECT FLOOR( (ROW_NUMBER() OVER ( ORDER BY r.divcd1, m.smenucd, r.gdcd ) - 1 ) /  #{intPagePerItem}  + 1) AS PAGE
                              , r.gdcd
                              , r.gdnm AS gdname
                              , r.unit
                              , g.priceyn
                              , r.gd_expalin AS explain
                              , g.newyn
                              , g.recommendyn
                              , g.qtysaleyn
                              , g.price1
                              , dbo.getMasterPrice(g.gdcd) saleprice
                              , dbo.getProductPrice(#{strMEMGRPCD},#{strGroupSalePolicy},g.gdcd) groupsaleprice
                              , dbo.getIsGroupSaleGoods(#{strMEMGRPCD},#{strGroupSalePolicy},g.gdcd) isgroupsale
                              , g.gdimg
                              , r.divcd
                              , r.divcd1 AS div1
                              , c.cdcode, c.cdname
                              , CASE WHEN ISNULL(g.deliverydtyn,'')='' THEN 'N' ELSE g.deliverydtyn END deliverydtyn
                              , CASE WHEN ISNULL(g.soldoutyn,'')='' THEN 'N' ELSE g.soldoutyn END soldoutyn
                              , ISNULL( r.stock_num ,99999) gdcnt
                              , i.origin
                              , i.producer
                              , i.address
                              , ISNULL(t.cdname,'미지정') AS gradedesc
                              , m.smenucd
                              , m.smenudesc
                              , r.od_from
                              , r.od_to
                              , r.dlv_from
                              , r.dlv_to
                         FROM od_reservegoods r
                           JOIN gd_master g ON g.gdcd = r.gdcd
                           JOIN cd_master c ON c.cdtype = '20'
                                           AND c.cdcode = r.divcd1
                           LEFT JOIN gd_item i ON i.gdcd = r.gdcd
                           LEFT JOIN cd_master t ON t.cdtype = '09'
                                                AND t.cdcode = i.typecd
                           LEFT JOIN submenu m ON m.category = r.divcd1
                                              AND sub_category
                                             LIKE '%'+ g.div2 + '%'
                          WHERE 1 = 1
                            AND r.useyn='Y'
                            <![CDATA[
                            AND r.od_from <= CONVERT(CHAR(10), GETDATE(), 121) AND r.od_to >= CONVERT(CHAR(10), GETDATE(), 121)
                            ]]>
                          <if test='strGdtype != "" OR spCustomerGroup.indexOf(strMEMGRPCD) lte 0'>
                              AND g.div1 = #{strGdtype}
                          </if>
                            AND r.type = #{strOdtype2}
                          <if test='strMEMGRPCD == "" OR spCustomerGroup.indexOf(strMEMGRPCD) lte 0' >
                            AND r.gdcd NOT IN (#{spProduct})
                          </if>
                        ) AS pl
                    WHERE PAGE = #{intPage}
    </select>

    <select id="prevProdNormalPaging">
        /* prevProdNormalPaging 일반상품 페이징*/
        SELECT CEILING( CAST(COUNT(1) AS FLOAT)/ #{intPagePerItem}) MAXPAGE
             , COUNT(g.gdcd) CNT
        FROM gd_master g
          JOIN cd_master c ON c.cdtype = '20'
                          AND c.cdcode = div1
          LEFT JOIN gd_cnt s ON g.gdcd = s.gdcd
          LEFT JOIN gd_item i ON i.gdcd = g.gdcd
          LEFT JOIN submenu m ON m.category = g.div1
                             AND sub_category
                             LIKE '%'+ g.div2 + '%'
         WHERE 1 = 1
           AND g.useyn = 'Y'
           <![CDATA[
           AND g.divcd <> '10'
           ]]>
         <if test="strGdtype != ''">
             AND g.div1 = #{strGdtype}
         </if>
         <if test="strSmenucd != '%' and strRs1SmenuCd != ''">
             AND g.div2 IN (#{strRs1SubCategory})
         </if>
    </select>

    <select id="searchNormalProd">
        /* searchNormalProd  상품목록조회 (일반상품)*/
        SELECT * FROM (
                        SELECT FLOOR( (ROW_NUMBER() OVER ( ORDER BY g.div1, m.smenucd, g.gdcd ) - 1 ) /  #{intPagePerItem} + 1) AS PAGE
                             , g.gdcd
                             , g.gdname
                             , g.unit
                             , g.priceyn
                             , g.newyn
                             , g.recommendyn
                             , g.qtysaleyn
                             , g.price1
                             , dbo.getMasterPrice(g.gdcd) saleprice
                             , dbo.getProductPrice(#{strMEMGRPCD}, #{strGroupSalePolicy},g.gdcd) groupsaleprice
                             , dbo.getIsGroupSaleGoods(#{strMEMGRPCD}, #{strGroupSalePolicy},g.gdcd) isgroupsale
                             , g.gdimg
                             , g.divcd
                             , g.div1
                             , c.cdcode
                             , c.cdname
                             , CASE WHEN ISNULL(g.deliverydtyn,'')='' THEN 'N' ELSE g.deliverydtyn END deliverydtyn
                             , CASE WHEN ISNULL(g.soldoutyn,'')='' THEN 'N' ELSE g.soldoutyn END soldoutyn, ISNULL(s.gdcnt,99999) gdcnt
                             , i.origin
                             , i.producer
                             , i.address
                             , ISNULL(t.cdname,'미지정') AS gradedesc
                             , m.smenucd
                             , m.smenudesc
                        FROM gd_master g
                          JOIN cd_master c ON c.cdtype = '20'
                                          AND c.cdcode = div1
                          LEFT JOIN gd_cnt s ON g.gdcd = s.gdcd
                          LEFT JOIN gd_item i ON i.gdcd = g.gdcd
                          LEFT JOIN cd_master t ON t.cdtype = '09'
                                               AND t.cdcode = i.typecd
                          LEFT JOIN submenu m ON m.category = g.div1
                                             AND sub_category
                                            LIKE '%'+ g.div2 + '%'
                         WHERE 1 = 1
                           AND g.useyn = 'Y'
                           <![CDATA[
                           AND g.divcd <> '10'
                           ]]>
                         <if test="strGdtype != '' ">
                             AND g.div1 = #{strGdtype}
                         </if>
                         <if test="strSmenucd != '%' and strRs1SmenuCd != '' ">
                             AND g.div2 IN (#{strRs1SubCategory})
                         </if>
                     ) AS pl
                   WHERE PAGE = #{intPage}
    </select>
</mapper>
