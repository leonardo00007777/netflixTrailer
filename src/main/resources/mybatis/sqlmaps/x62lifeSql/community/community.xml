<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="community">
    <sql id="communityCommon">
        SELECT TOP 3 ctsidx
             , ctscd
             , title
             , content
             , indt
             , thumbimg
        FROM bd_contents
        WHERE 1=1
          AND useyn = 'Y'
    </sql>
    <select id="boardDetail">
        /*boardDetail 자연이랑모바일 - 게시판 자세히 보기*/
        <![CDATA[
        SELECT COUNT(DISTINCT memcd) AS CNT
        FROM od_pay
         WHERE paysct = '10'
           AND paydt >= '2017-12-08 07:00:00.0'
           AND paydt < '2017-12-11'
           AND paynum IN ( SELECT paynum
                           FROM od_header
                            WHERE paystcd = '10'
                              AND odgubun IN ('11')
                              AND orddt >= '2017-12-08 07:00:00.0'
                              AND orddt < '2017-12-11'
                         )
        ]]>
    </select>

    <update id="boardViewCnt">
       /*boardViewCnt 조회수 +1 */
        UPDATE bd_contents
           SET rcount=ISNULL(rcount,0)+1
        WHERE useyn='Y'
          AND ctscd= #{ctscd}
          AND ctsidx= #{ctsidx}
    </update>

    <select id="boardAmplify">
      /*boardAmplify 자연이랑모바일 - 게시판 본문만 보기(확대)*/
        SELECT title
             , content
             , indt
        FROM bd_contents
          WHERE useyn = 'Y'
            AND ctscd = #{ctscd}
            AND ctsidx = #{ctsidx}
        <choose>
            <when test="strLoginMemCd == null or strLoginMemCd == ''">
                AND ISNULL(grpcd, '') = ''
            </when>
            <otherwise>
                AND ISNULL(grpcd, '') IN('', #{strMEMGRPCD}, #{inStrMEMGRPCD})
            </otherwise>
        </choose>
    </select>

    <select id="eventQuit">
        /* eventQuit '20171206 hwkim 농식품 상생협력 경연대회 이벤트1 자동 마감처리 동작 수행 (종료 후 삭제 또는 주석 달것) */
        <![CDATA[
        SELECT COUNT(DISTINCT memcd) CNT
        FROM od_pay
         WHERE paystcd = '10'
           AND paydt >= '2017-12-08 07:00:00.0'
           AND paydt < '2017-12-11'
           AND paynum IN (SELECT paynum
                          FROM od_header
                           WHERE paystcd = '10'
                             AND odgubun IN ('11')
                             AND orddt >= '2017-12-08 07:00:00.0'
                             AND orddt < '2017-12-11')
         ]]>
    </select>

    <select id="communityBoardList">
       /* communityBoardList 커뮤니티 게시판 목록*/
        SELECT * FROM (
                          SELECT FLOOR( (ROW_NUMBER() OVER ( ORDER BY ctsidx DESC ) - 1 ) / #{intPagePerItem} + 1) AS PAGE
                               , ctsidx
                               , title
                               , content
                               , CONVERT(VARCHAR(20),indt,111) AS indt
                               , (SELECT COUNT(rseqno) FROM basicomments WHERE rtype='WZ' AND rid='bd_contents' AND ridx=ctsidx) RCNT
                               , thumbimg
                          FROM bd_contents
                           WHERE 1 = 1
                             AND useyn = 'Y'
                             AND ctscd = #{ctscd}
                           <choose>
                             <when test="strLoginMemCd == null or strLoginMemCd == ''">
                               AND ISNULL(grpcd, '') = ''
                             </when>
                             <otherwise>
                               AND ISNULL(grpcd, '') IN('', #{strMEMGRPCD}, #{inStrMEMGRPCD})
                             </otherwise>
                           </choose>
                       ) AS pl
        WHERE PAGE = #{intPage}
    </select>

    <select id="communityBoardPaging">
         /*communityBoardPaging 커뮤니티 게시판 페이징*/
         /*  '지정된 사용자는 무조건 볼 수 있도록
        'I1047006: 송호섭, I0006074: 임혜정, I1000675: 박성희, I1032425: 하상돈
        'I1049552: 김태훈, I1062276: 김기령, I1082322: 박소연, I1084143: 김민희
        'I1056159: 오진선, I1084162: 한은정, I1052177: 이영실, I1079369: 이영은
        'I1056660: 유하라, I0007404: 윤석희, I1008267: 정왕재, I1000227: 이경희
        'I1062040: 이새라, I1014111: 박윤정, I1048759: 양희정, I1078347: 김하율
        'I1073168: 최아영, I1061924: 박유영, I1065578: 박미주, I1078980: 최선아
        'I1062305: 홍새라, I1008121: 김흥완, I0007558: 김상연, I1032423: 오혁
        'I1079370: 현철훈, I1090518: 이수현, I1091331: 안가혜
         White List 처리 필요*/
        SELECT CEILING( CAST(COUNT(1) AS FLOAT)/ #{intPagePerItem} ) MAXPAGE
             , COUNT(ctsidx) CNT
        FROM bd_contents
         WHERE 1 = 1
           AND useyn = 'Y'
           AND ctscd = #{ctscd}
         <choose>
           <when test="strLoginMemCd == null or strLoginMemCd == ''">
              AND ISNULL(grpcd, '') = ''
           </when>
           <otherwise>
               AND ISNULL(grpcd, '') IN('', #{strMEMGRPCD}, #{inStrMEMGRPCD})
           </otherwise>
         </choose>
    </select>

    <select id="getCommunityBoardKind">
        /* getCommunityBoardKind 커뮤니티 게시판 유형 얻기*/
        SELECT cdcode
             , cdname
             , cdval1
             , cdval2
        FROM cd_master
         WHERE 1=1
           AND cdtype='05'
           AND useyn='Y'
           AND cdcode IN ('01','02','03','05','06','11','12','20','21','22','23','24','25')
        ORDER BY cdcode
    </select>
    
    <select id="recipeBlogVisitMemSearch">
        /*recipeBlogVisitMemSearch 블로그 방문자 조회 */
        SELECT memid
        FROM blogvisitors
        WHERE DATEDIFF(d,datex,getdate())=0
          AND ipx = #{visitIP}
          AND memid = #{memidx}
          <if test="strLoginMemID != '' and memid != strLoginMemID">
            AND vmemid = #{strLoginMemID}
          </if>
          <if test="strLoginMemID != '' and memidx != strLoginMemID">
              AND vmemid = '_anonymous'
          </if>
    </select>

    <insert id="insertBlogVisitRecord">
        /*insertBlogVisitRecord 방문자 id기록*/
        INSERT INTO blogvisitors
                (
                   memid
                 , vmemid
                 , ipx
                 , refererx
                )
        VALUES (
                <if test="strLoginMemID != null and memid != strLoginMemID">
                   #{memidx}
                 , #{strLoginMemID}
                 , #{visitIP}
                 , #{refererx}
                </if>
                <if test="strLoginMemID == null and memidx != strLoginMemID">
                   #{memidx}
                 , '_anonymous'
                 , #{visitIP}
                 , #{refererx}
                </if>
               )
    </insert>

    <select id="getBlogDescDetail">
        /* getBlogDescDetail 본문 가져오기 */
        SELECT seqno
             , btitle
             , bbody
             , brdate
        FROM blog
         WHERE 1 = 1
           AND memid= #{memid}
           <choose>
               <when test="memidx != '' and cidx != ''">
                   AND idx = #{cidx}
               </when>
               <otherwise>
                   AND seqno = #{seqno}
               </otherwise>
           </choose>
    </select>

    <select id="recipeBlogNoCategoryPaging">
        /* recipeBlogNoCategoryPaging 레시피 블로그 카테고리 삭제 버전 페이징*/
        SELECT CEILING( CAST(COUNT(1) AS FLOAT)/ #{intPagePerItem}) MAXPAGE
             , COUNT(seqno) CNT
        FROM blog
         WHERE 1 = 1
           AND bgroup='90'
        <if test="searchValue != null and searchValue != ''">
            AND (
                 btitle LIKE '%' + #{searchValue} + '%'
                 OR idx IN (SELECT bidx FROM basictagmap WHERE btype = #{tagTypeBlog} AND btidx IN (SELECT btidx FROM basictag
                 WHERE btname LIKE '%' + #{searchValue} + '%') AND bid = memid)
                )
        </if>
    </select>

    <select id="recipeBlogNoCategoryList">
        /* recipeBlogNoCategoryPaging 레시피 블로그 카테고리 삭제 버전 List*/
        SELECT * FROM (
                          SELECT FLOOR( (ROW_NUMBER() OVER ( ORDER BY seqno DESC ) - 1 ) / #{intPagePerItem} + 1) AS PAGE
                               , seqno
                               , idx
                               , btitle
                               , bbody
                               , CONVERT(VARCHAR(20),brdate,111) AS brdate
                               , (SELECT COUNT(rseqno) FROM basicomments WHERE rtype='BL' AND rid=memid AND ridx=idx) RCNT
                               , memid
                               , thumbimg
                          FROM blog
                          WHERE 1 = 1
                            AND bgroup='90'
                          <if test="searchValue != null and searchValue != ''">
                              AND (
                                   btitle LIKE '%' + #{searchValue} + '%'
                                   OR idx IN (SELECT bidx FROM basictagmap WHERE btype = #{tagTypeBlog} AND btidx IN (SELECT btidx FROM basictag
                                   WHERE btname LIKE '%' + #{searchValue} + '%') AND bid = memid)
                                  )
                          </if>
                      ) AS pl
        WHERE PAGE = #{intPagePerItem}
    </select>

    <select id="recipeBlogBackPaging">
        /*recipeBlogBackPaging*/
        SELECT CEILING( CAST(COUNT(1) AS FLOAT)/ #{intPagePerItem} ) MAXPAGE
             , COUNT(seqno) CNT
        FROM blog
         WHERE 1 = 1
           AND bgroup='90'
        <if test="searchValue != null and searchValue != ''">
            AND btitle LIKE '%' + #{searchValue} + '%'
        </if>
        <if test="tagName != null and tagName != ''">
            AND idx IN (SELECT bidx FROM basictagmap WHERE btype = #{tagTypeBlog} AND btidx IN (SELECT btidx FROM basictag WHERE btname = #{tagName}))
        </if>
    </select>

    <select id="recipeBlogBackList">
        /* recipeBlogBackList */
        SELECT * FROM (
                          SELECT FLOOR( (ROW_NUMBER() OVER ( ORDER BY seqno DESC ) - 1 ) / #{intPagePerItem} + 1) AS PAGE
                               , seqno
                               , idx
                               , btitle
                               , bbody
                               , CONVERT(VARCHAR(20),brdate,111) AS brdate
                               , (SELECT COUNT(rseqno) FROM basicomments WHERE rtype='BL' AND rid=memid AND ridx = idx) RCNT
                               , memid
                               , thumbimg
                          FROM blog
                           WHERE 1 = 1
                             AND bgroup='90'
                           <if test="searchValue != null and searchValue != ''">
                               AND btitle LIKE '%' + #{searchValue} + '%'
                           </if>
                           <if test="tagName != null and tagName != ''">
                               AND idx IN (SELECT bidx FROM basictagmap WHERE btype = #{tagTypeBlog} AND btidx IN (SELECT btidx FROM basictag WHERE btname = #{tagName}))
                           </if>
                      ) AS pl
        WHERE PAGE = #{intPagePerItem}
    </select>

    <select id="recipeBlogCategoryYesPaging">
        /*recipeBlogCategoryYesPaging 자연이랑모바일 - 레시피 블로그(Category Y 버전) Paging*/
        SELECT CEILING( CAST(COUNT(1) AS FLOAT)/ #{intPagePerItem} ) MAXPAGE
             , COUNT(seqno) CNT
        FROM blog
         WHERE 1 = 1
           AND bgroup='90'
         <if test="selTag != null and selTag != ''">
             AND idx IN (SELECT bidx FROM basictagmap WHERE btype = #{tagTypeBlog} AND btidx IN (SELECT btidx FROM basictag WHERE btname LIKE #{selTag}) AND bid = memid)
         </if>
         <if test="recipeTag1 != null and recipeTag1 != ''">
             AND idx IN (SELECT bidx FROM basictagmap WHERE btype = #{tagTypeBlog} AND btidx IN (SELECT btidx FROM basictag WHERE btname LIKE #{recipeTag1}) AND bid = memid)
         </if>
         <if test="recipeTag2 != null and recipeTag2 != ''">
             AND idx IN (SELECT bidx FROM basictagmap WHERE btype = #{tagTypeBlog}  AND btidx IN (SELECT btidx FROM basictag WHERE btname LIKE #{recipeTag2}) AND bid = memid)
         </if>
         <if test="selTag != null and searchValue != null">
             AND (
                  btitle LIKE '%' + #{searchValue} + '%'
                           OR idx IN (SELECT bidx FROM basictagmap WHERE btype = #{tagTypeBlog} AND btidx IN (SELECT btidx FROM basictag WHERE btname LIKE '%' + #{searchValue} + '%' ) AND bid = memid)
                 )
         </if>
            AND bblind = 'N'
    </select>

    <select id="recipeBlogCategoryYesList">
        /* recipeBlogCategoryYesList 자연이랑모바일 - 레시피 블로그(Category Y 버전) 목록*/
        SELECT * FROM (
                          SELECT FLOOR( (ROW_NUMBER() OVER ( ORDER BY seqno DESC ) - 1 ) / #{intPagePerItem} + 1) AS PAGE
                               , seqno
                               , idx
                               , btitle
                               , bbody
                               , CONVERT(VARCHAR(20),brdate,111) AS brdate
                               , (SELECT COUNT(rseqno) FROM basicomments WHERE rtype='BL' AND rid=memid AND ridx = idx) RCNT
                               , memid
                               , thumbimg
                          FROM blog
                           WHERE 1 = 1
                             AND bgroup='90'
                            <if test="selTag != null and selTag != ''">
                                AND idx IN (SELECT bidx FROM basictagmap WHERE btype = #{tagTypeBlog} AND btidx IN (SELECT btidx FROM basictag WHERE btname LIKE #{selTag}) AND bid = memid)
                            </if>
                            <if test="recipeTag1 != null and recipeTag1 != ''">
                                AND idx IN (SELECT bidx FROM basictagmap WHERE btype = #{tagTypeBlog} AND btidx IN (SELECT btidx FROM basictag WHERE btname LIKE #{recipeTag1}) AND bid = memid)
                            </if>
                            <if test="recipeTag2 != null and recipeTag2 != ''">
                                AND idx IN (SELECT bidx FROM basictagmap WHERE btype = #{tagTypeBlog}  AND btidx IN (SELECT btidx FROM basictag WHERE btname LIKE #{recipeTag2}) AND bid = memid)
                            </if>
                            <if test="selTag != null and searchValue != null">
                                AND (
                                     btitle LIKE '%' + #{searchValue} + '%'
                                              OR idx IN (SELECT bidx FROM basictagmap WHERE btype = #{tagTypeBlog} AND btidx IN(SELECT btidx FROM basictag WHERE btname LIKE '%' + #{searchValue} + '%' ) AND bid = memid)
                                    )
                            </if>
                             AND bblind = 'N'
                      ) AS pl
        WHERE PAGE = #{intPage}
    </select>

    <select id="communityPageFirst">
        /* communityPageFirst 자연이랑모바일 - 커뮤니티 처음화면*/
        SELECT TOP 24 ctsidx
             , ctscd
             , title
             , content
        FROM bd_contents
         WHERE useyn = 'Y'
        ORDER BY ctsidx DESC
    </select>

    <select id="communityEventList">
        /*communityEventList 자연이랑모바일 - 커뮤니티 최신 이벤트 목록 시작*/
        <include refid="communityCommon"/>
           AND ctscd = '02'
        ORDER BY ctsidx DESC
    </select>


    <select id="communityRuralExperienceContentsOne">
        /* communityRuralExperienceContentsOne - ctscd = '01'*/
        /* 자연이랑모바일 - 농촌체험 콘텐츠 */
        <include refid="communityCommon"/>
           AND ctscd = '01'
        ORDER BY ctsidx DESC
    </select>

    <select id="communityRuralExperienceContentsThree">
        /* communityRuralExperienceContentsThree - ctscd = '03*/
        /* 자연이랑모바일 - 농촌체험 콘텐츠 */
        <include refid="communityCommon"/>
           AND ctscd = '03'
        ORDER BY ctsidx DESC
    </select>

    <select id="communityRuralExperienceContentsFive">
        /* communityRuralExperienceContentsThree - ctscd = '05*/
        /* 자연이랑모바일 - 농촌체험 콘텐츠 */
        <include refid="communityCommon"/>
          AND ctscd = '05'
        ORDER BY ctsidx DESC
    </select>

    <select id="communityRuralExperienceContentsSix">
        /* communityRuralExperienceContentsThree - ctscd = '06*/
        /* 자연이랑모바일 - 농촌체험 콘텐츠 */
        <include refid="communityRuralExperience"/>
        AND ctscd = '06'
        ORDER BY ctsidx DESC
    </select>

    <update id="discussionIdxCnt">
        /*discussionIdxCnt 자연이랑모바일 - 토론 게시판 view cnt*/
        UPDATE discussion
        SET viewcount=ISNULL(viewcount,0)+1
         WHERE idx= #{idx}
    </update>

    <select id="discussionSelect">
        /*discussionSelect 자연이랑모바일 - 토론 게시판 글 수정 시 이전 글 가져오기*/
        SELECT idx
             , titlex
             , contents
             , datex
             , writer
             , viewcount
             , agree
             , oppose
             , replies
             , memname
             , DATEDIFF(d,todate,getdate()) AS todate
        FROM discussion d
          JOIN mb_master m
            ON m.memcd = d.writer
         WHERE 1 = 1
           AND idx = #{idx}
    </select>

    <update id="updateDiscussion">
       /*updateDiscussion 자연이랑모바일 - 토론 게시판 글 수정*/
        UPDATE discussion
           SET titlex = #{strTitlex}
             , contents = #{strContents}
         WHERE 1 = 1
           AND idx = #{idx}
    </update>

    <insert id="insertDiscussion">
        /* insertDiscussion 자연이랑모바일 - 토론게시판 글 쓰기*/
        INSERT INTO discussion
               (
                 datex
               , writer
               , titlex
               , contents
               , viewcount
               , agree
               , oppose
               , replies
               )
              VALUES
               (
                 getdate()
               , #{strLoginMemCd}
               , #{strTitlex}
               , #{strContents}
               , '0'
               , '0'
               , '0'
               , '0'
               )
    </insert>

    <select id="editDiscussion">
        /*editDiscussion 자연이랑모바일 - 토론게시판 글 수정 시 이전 글 가져오기*/
        SELECT idx
             , titlex
             , contents
             , datex
             , writer
             , viewcount
             , agree
             , oppose
             , replies
             , memname
        FROM discussion d
          JOIN mb_master m
            ON m.memcd = d.writer
         WHERE 1 = 1
           AND idx = #{idx}
    </select>

    <select id="fsbPaging">
        /*fsbPaging 자연이랑모바일 - 일반게시판 Paging*/
        SELECT CEILING( CAST(COUNT(1) AS FLOAT)/ #{intPagePerItem} ) AS MAXPAGE
             , COUNT(idx) AS CNT
        FROM #{boardId}
         WHERE 1 = 1
    </select>

    <select id="fsbList">
        /*fsbList 자연이랑모바일 - 일반게시판 목록*/
        SELECT *
        FROM (
                 SELECT FLOOR((ROW_NUMBER() OVER ( ORDER BY idx DESC ) - 1) / #{intPagePerItem} + 1) AS PAGE
                      , idx
                      , seqNum
                      , midx
                      , author
                      , e_mail
                      , subject
                      , contents
                      , CONVERT(VARCHAR (20), regDate, 111)                                          AS regdate
                      , fileName1
                      , nickn
                      , isblogger
                      , (SELECT COUNT(rseqno)
                         FROM basicomments
                         WHERE rtype = 'BD'
                           AND rid = #{bid}
                           AND ridx = idx)                                                           AS RCNT
                 FROM #{boardId} a
                          LEFT JOIN memberprofile b
                                    ON a.memcd = b.memid
                 WHERE 1 = 1
             ) AS pl
         WHERE PAGE = #{intPage}
    </select>

    <update id="fsbDetailCnt">
        /*fsbDetailCnt 조회수 Cnt*/
        UPDATE #{boardId}
           SET readNum = ISNULL(readNum,0)+1
         WHERE idx = #{idx}
    </update>

    <select id="fsbDetailSelect">
        /*fsbDetailSelect 자연이랑모바일 - 게시판 자세히 보기*/
        SELECT idx
             , seqNum
             , objProperty
             , midx
             , author
             , e_mail
             , subject
             , contents
             , CONVERT(VARCHAR(20) ,regDate ,111) AS regdate
             , fileName1
             , nickn
             , isblogger
             , a.memcd
             , (SELECT COUNT(rseqno) FROM basicomments WHERE rtype='BD' AND rid = #{bid} AND ridx=idx) AS RCNT
        FROM #{boardId} a
          LEFT JOIN memberprofile b
                 ON a.memcd = b.memid
         WHERE 1 = 1
           AND idx = #{idx}
    </select>

    <update id="oneOnoneInquiryUpdate">
        /*oneOnoneInquiryUpdate 1대1문의 수정 처리*/
        UPDATE #{boardId}
           SET subject = #{strTitle}
             , contents = #{strContent}
            <if test="imageName != null">
             , fileName1 = #{imageName}
            </if>
             , latestDate = sysdate
           WHERE 1 = 1
             AND idx = #{idx}
    </update>

    <insert id="oneOnoneInquiryInsert">
        /*oneOnoneInquiryInsert 자연이랑모바일 - 1대1문의 쓰기 처리*/
        <selectKey order="BEFORE" keyProperty="seqnum" resultType="java.lang.String">
            SELECT LTRIM(RTRIM(ISNULL(MAX(seqNum),0)+1 )) seqnum FROM #{boardId}
        </selectKey>
        INSERT INTO #{boardId}
                  (
                     seqNum
                   , objProperty
                   , midx
                   , secret
                   , docType
                   , author
                   , e_mail
                   , homepage
                   , subject
                   , passwd
                   , category
                   , regDate
                   , latestDate
                   , memoNum
                   , readNum
                   , vote
                   , ip_reg
                   , usrAgent_reg
                   , ref
                   , re_step
                   , re_level
                   , siteLink1
                   , siteLink2
                   , fileName1
                   , fileSize1
                   , fileDownLoad1
                   , contents
                   , memcd
                  )
              VALUES
                 (
                   #{seqNum}
                   , 'M'
                   , '0'
                   , '0'
                   , 'text'
                   , #{strLoginMemName}
                   , ''
                   , ''
                   , #{strTitle}
                   , ''
                   , ''
                   , sysdate
                   , ''
                   , 0
                   , 0
                   , 0
                   , #{RemoteAddr}
                   , #{httpUserAgent}
                   , #{seqNum}
                   , '0'
                   , '0'
                   , ''
                   , ''
                   , #{imageName}
                   , fileSize
                   , fileDownLoad
                   , #{strContent}
                   , #{strLoginMemId}
                 )
    </insert>
    <select id="boardWriteEdit">
        /*boardWriteEdit 자연이랑모바일 - 게시판 글쓰기(수정)*/
        SELECT idx
             , seqNum
             , objProperty
             , midx
             , author
             , e_mail
             , subject
             , contents
             , CONVERT(VARCHAR(20),regDate,111) AS regdate
             , fileName1
             , nickn
             , isblogger
             , a.memcd
             , (SELECT COUNT(rseqno) FROM basicomments WHERE rtype='BD' AND rid = #{bid} AND ridx = idx) AS RCNT
        FROM #{boardId} a
          LEFT JOIN memberprofile b
                 ON a.memcd = b.memid
         WHERE 1=1
           AND idx = #{idx}
    </select>

    <select id="getNews">
       /* getNews 자연이랑모바일 - 최신 자연이랑 소식 가져오기 */
       /*    '지정된 사용자는 무조건 볼 수 있도록
        'I1047006: 송호섭, I0006074: 임혜정, I1000675: 박성희, I1032425: 하상돈
        'I1049552: 김태훈, I1062276: 김기령, I1082322: 박소연, I1084143: 김민희
        'I1056159: 오진선, I1084162: 한은정, I1052177: 이영실, I1079369: 이영은
        'I1056660: 유하라, I0007404: 윤석희, I1008267: 정왕재, I1000227: 이경희
        'I1062040: 이새라, I1014111: 박윤정, I1048759: 양희정, I1078347: 김하율
        'I1073168: 최아영, I1061924: 박유영, I1065578: 박미주, I1078980: 최선아
        'I1062305: 홍새라, I1008121: 김흥완, I0007558: 김상연, I1032423: 오혁
        'I1079370: 현철훈, I1090518: 이수현, I1091331: 안가혜
         화이트 리스트 처리 필요한지 확인*/
        SELECT TOP 1 content
             , ctsidx
             , ctscd
        FROM bd_contents
         WHERE useyn = 'Y'
        <if test="bdtype == news">
            AND ctscd IN ('01','03','05','06')
        </if>
        <if test="event">
            AND ctscd IN ('02')
        <![CDATA[
            AND fromdate <= GETDATE()
            AND GETDATE() < todate + 1
        ]]>
        </if>
        AND title like '%고객님께%'
           <choose>
               <when test="strLoginMemCd == null or strLoginMemCd == ''">
                   AND ISNULL(grpcd, '') = ''
               </when>
               <otherwise>
                   AND ISNULL(grpcd, '') IN('', #{strMEMGRPCD}, #{inStrMEMGRPCD})
               </otherwise>
           </choose>
        ORDER BY ctsidx DESC
    </select>

    <select id="getMagazine">
      /*getMagazine 매거진 - 컨텐츠 상세 모바일 */
        SELECT title
             , content
             , indt
             , ctscd
        FROM bd_contents bd
         WHERE bd.useyn = 'Y'
           AND bd.ctsidx = #{ctsidx}
           AND (ISNULL(bd.grpcd, '') = ''
            OR EXISTS (SELECT cl.ulgrcd FROM customgrp_l cl  WHERE cl.ulcode = bd.grpcd AND cl.ulgrcd = #{strMEMGRPCD}))
    </select>

    <select id="getMagazineEvent">
        /* getMagazineEventTwo 20171206 hwkim 농식품 상생협력 경연대회 이벤트1 자동 마감처리 동작 수행 (종료 후 삭제 또는 주석 달것)*/
        /* '만약 '02','11' 유형주문이 포함된 결제가 2995명에 도달했을 경우 해당 이벤트 그림교체 표시. */
        <![CDATA[
        SELECT COUNT(DISTINCT memcd) CNT
        FROM od_pay
         WHERE paystcd = '10'
           AND paydt >= '2017-12-08 07:00:00.0'
           AND paydt < '2017-12-11'
           AND paynum IN (
                          SELECT paynum
                            FROM od_header
                             WHERE paystcd = '10'
                               AND odgubun IN ('11')
                               AND orddt >= '2017-12-08 07:00:00.0'
                               AND orddt < '2017-12-11'
                          )
        ]]>
    </select>

    <select id="getMagazineCategory">
        /* getMagazineCategory 매거진 카테고리 얻기 */
        SELECT cdcode
             , cdname
        FROM cd_master
         WHERE 1=1
           AND cdtype='05'
           AND useyn='Y'
           AND cdcode = #{ctscd}
    </select>

    <update id="magazineCnt">
        /* magazineCnt 조회수 UP */
        UPDATE bd_contents
           SET rcount=ISNULL(rcount,0)+1
        WHERE useyn='Y'
          AND ctscd = #{ctscd}
          AND ctsidx = #{ctsidx}
    </update>

    <select id="getMagazineEalry">
        /* getRelationProduct 매거진 - 최신호 */
        SELECT MAX(zhidx) zhidx
        FROM magazine_h
         WHERE 1=1
           AND zhusyn='Y'
    </select>

    <select id="getRelationProduct">
        /* getRelationProduct 매거진 - 연관상품 조회 */
        SELECT a.odtype2
             , a.useyn
             , a.ruseyn
             , a.gdcd
             , b.gdname
             , b.unit
             , b.gdimg
             , b.divcd
             , b.div1
             , b.price1
             , dbo.getProductPrice(#{strMEMGRPCD}, #{strGroupSalePolicy}, a.gdcd) saleprice
             , ISNULL(s.gdcnt, 99999) gdcnt
             , i.origin
             , i.producer
             , i.address
             , ISNULL(c1.cdname,'미지정') AS gradedesc
             , b.soldoutyn
             , b.thedaysyn
             , b.mgdimg1
             , ISNULL(b.newyn,'N') newyn
             , ISNULL(b.qtysaleyn,'N') qtysaleyn
             , b.shortdesc
             , CASE b.dispatchtype WHEN 'I'
                                     THEN '11'
                                   WHEN 'O'
                                     THEN '15'
               END odtype
             , ISNULL(b.deliverydtyn,'N') deliverydtyn
             , ISNULL(b.reserveyn,'N') reserveyn
        FROM (
                 SELECT ISNULL(ISNULL(c.type, d.rtype), '01') odtype2
                      , a.gdcd, ISNULL(a.priority, 9) priority
                      , b.useyn, ISNULL(c.useyn, 'N') ruseyn
                 FROM blogoods a
                   LEFT JOIN gd_master b
                          ON a.gdcd = b.gdcd
                   LEFT JOIN od_reservegoods c
                          ON a.gdcd = c.gdcd
                         AND c.useyn = 'Y'
                        <![CDATA[
                         AND DATEDIFF(d, CONVERT(DATETIME, c.od_from, 120), GETDATE()) >= 0
                         AND DATEDIFF(d, GETDATE(), CONVERT(DATETIME, c.od_to, 120)) >= 0
                        ]]>
                   LEFT JOIN (SELECT gdcd, MAX(type) rtype, MAX(useyn) useyn FROM od_reservegoods GROUP BY gdcd) d
                          ON a.gdcd = d.gdcd
                  WHERE a.seqno = #{ctsidx}
                    AND a.btype = 'BD'
              ) a
          JOIN gd_master b
            ON a.gdcd = b.gdcd
          LEFT JOIN gd_cnt s
                 ON a.gdcd = s.gdcd
          LEFT JOIN gd_item i
                 ON a.gdcd = i.gdcd
          LEFT JOIN cd_master c1
                 ON c1.cdtype = '09'
                AND i.typecd = c1.cdcode
         WHERE (a.useyn = 'Y' OR a.ruseyn = 'Y')
        <![CDATA[
        ORDER BY CASE WHEN a.useyn <> 'Y' AND a.ruseyn <> 'Y'
                        THEN 0
                      ELSE 1
                 END DESC
               , CASE WHEN ISNULL(s.gdcnt, 99999) <= 0 OR b.soldoutyn = 'Y'
                        THEN 0
                      ELSE 1
                 END DESC
               , a.priority
               , a.gdcd
        ]]>
    </select>
</mapper>