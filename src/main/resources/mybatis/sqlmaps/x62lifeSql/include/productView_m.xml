<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="productView">
<!--    'System        : 자연이랑모바일-->
<!--    'Program       :-->
<!--    'Title         : 상품평 조회-->
<!--    'File          : productreview_m.asp-->
<!--    'Program Type  : asp-->
<!--    'Analyst       :-->
<!--    'Author        : hyeok-->
<!--    'Date Started  : 20180221-->
<!--    'Last Modified :-->
<!--    'Called By     :-->
<!--    'Parameters    :-->
<!--    'Purpose       :-->
<!--    'Version       :-->
<!--    '-->
<!--    'Modified   Author      V/M     Reason For Modification-->

<!--    '20180221   hyeok       0.9     처음작성(basicommentsview_m 참조)-->
<!--    '20190403   hwkim       0.9.1   별점 표시 방식 변경-->
    <select id="productViewRecentSixMonthPaging">
         /*productViewRecentSixMonthPaging 페이지 계산 (최근 6개월 안에 작성된 글만 표시)*/
        SELECT CEILING( CAST(COUNT(1) AS FLOAT)/ #{intPagePerItem} ) MAXPAGE
             , COUNT(rseqno) CNT
        FROM productreview
         WHERE 1 = 1
           AND rblind = 'N'
           AND rid = #{reviewId}
           AND ridx = #{reviewIdx}
           <![CDATA[
           AND rdatex >= dateadd(M ,-6, getdate())
           AND rtype = #{reviewType}
           ]]>
    </select>

    <select id="productViewProd">
        SELECT c.rseqno
             , c.rtype
             , ISNULL(c.rrseqno,c.rseqno) RRSEQNO
             , c.rdepth
             , c.rmemo
             , c.rwip
             , c.rwuid
             , c.rdatex
             , c.ragree
             , c.roppose
             , c.rblind
             , c.device
             , ISNULL(c.grade, '3') grade
             , p.nickn
             , p.ppath
             , p.smemo
             , p.isblogger
             , m.memname
             , p.memlevel
             , l.orddt
        FROM productreview c
          JOIN mb_master m ON c.rwuid = m.memid
          LEFT JOIN memberprofile p ON c.rwuid = p.memid
          LEFT JOIN (
                       SELECT memcd
                            , MAX(orddt) orddt
                       FROM od_header a
                         JOIN od_goods b ON a.ordnum=b.ordnum
                        WHERE a.paystcd IN ('10' )
                        <![CDATA[
                          AND a.orddt >= dateadd(M ,-6, getdate())
                          AND gdcd = #{reviewIdx}
                        ]]>
                       GROUP BY memcd
                    ) l ON l.memcd = m.memcd
        WHERE 1 = 1
          AND c.rblind = 'N'
          AND c.rid = #{reviewId}
          AND c.ridx = #{reviewIdx}
          <![CDATA[
          AND c.rdatex >= dateadd(M ,-6, getdate())
          AND c.rtype = #{reviewType}
          ]]>
        ORDER BY ISNULL(c.rrseqno, c.rseqno) DESC, c.rdepth, c.rseqno
        OFFSET  ((#{intPage} - 1) * #{intPagePerItem})  ROWS
        FETCH NEXT  #{intPagePerItem}  ROWS ONLY

    </select>
</mapper>