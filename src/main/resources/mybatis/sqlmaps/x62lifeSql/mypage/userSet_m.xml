<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="userSet">
<!--    'System        : m.62life.com
    'Program      :
    'Title         : 자연이랑모바일 - 내가 만드는 묶음상품 작성
    'File          : userset01_m.asp
    'Program Type  : asp
    'Analyst       :
    'Author        : HyeokOh
    'Date Started  : 20150901
    'Last Modified :
    'Called By     :
    'Parameters    :
    'Purpose       :
    'Version       :

    'Modified   Author  V/M     Reason For Modification

    '20150901   HyeokOh 0.1     처음 작성
    '20151006   hwkim   0.5     전체 변경 작업
    '20151106   hwkim   0.9     디자인 적용
    '20161204   hyeok   0.9.1   사이트 리뉴얼 layout적용
    '20161213   hwkim   0.9.2   레이아웃 표준 규칙 수정
    '20170313   hwkim   0.9.3   장바구니 선택 기능 대응 변경 처리-->
    <select id="getUserShoppingBasket">
        /* getUserShoppingBasket 나의 묶음상품 */
        SELECT t.gdcd
             , t2.gdname
             , t2.unit
        FROM shopping_basket t
          JOIN GD_MASTER t2
            ON t2.gdcd = t.gdcd
        WHERE t.MEMCD = #{strLoginMemCD}
          AND t.od_gubun = '11'
        ORDER BY t.gdcd
    </select>

<!--    'System        : m.62life.com-->
<!--    'Program      :-->
<!--    'Title         : 자연이랑모바일 - 내가 만드는 묶음상품 생성/담기 처리-->
<!--    'File          : userset02_m.asp-->
<!--    'Program Type  : asp-->
<!--    'Analyst       :-->
<!--    'Author        : HyeokOh-->
<!--    'Date Started  : 20150902-->
<!--    'Last Modified :-->
<!--    'Called By     :-->
<!--    'Parameters    :-->
<!--    'Purpose       :-->
<!--    'Version       :-->

<!--    'Modified   Author      V/M	    Reason For Modification-->

<!--    '20151014   HyeokOh     0.1	    처음 작성-->
<!--    '20151106   hwkim       0.9     전체 변경 작업-->
<!--    '20170313   hwkim       0.9.1   장바구니 선택 기능 대응 변경 처리-->
    <select id="createSerialNumber">
        /*createSerialNumber 번호키 생성*/
        SELECT ISNULL(MAX(hseqno),0)+1 hseqno
        FROM CART_RECIPE_HEADER
    </select>
    
    <select id="saveHeaderInfo">
         /*saveHeaderInfo 헤더정보 저장*/
        INSERT INTO CART_RECIPE_HEADER (
                                          hseqno
                                        , memcd
                                        , titlex
                                        , hmemo
                                        , pic1
                                        , icount
                                        , scount
                                        , rcount
                                        , indt
                                        , share
                                        )
               VALUES (
                        #{hseqno}
                      , #{strLoginMemCD}
                      , #{titlex}
                      , #{hmemo}
                      , #{pic1}
                      , 0
                      , 0
                      , 0
                      , GETDATE()
                      , #{share}
                      )
    </select>

    <insert id="saveProdInfo">
          /* saveProdInfo 라인정보 저장*/
            INSERT INTO CART_RECIPE_LINE(
                                          lseqno
                                        , lno
                                        , gdcd
                                        , gdqty
                                        , lmemo
                                        )
        <foreach collection="java.util.List" item="prodList" index="index">
                   VALUES (
                            #{hseqno}
                          , (#{index} + 1)
                          , Trim(#{prodList})
                          , 1
                          ,''
                          )
        </foreach>
    </insert>

    <select id="checkOverLapTag">
        /* checkOverLapTag 중복되는 태그 검색*/
        SELECT *
        FROM basictag
        <foreach collection="java.util.List" item="arrTags">
         WHERE btname = Trim(Replace(#{arrTags}," ",""))
        </foreach>
    </select>

    <update id="basicTagUpdate">
        /* basicTagUpdate 태그 업데이트*/
        UPDATE basictag
           SET btcount=btcount+1
        <foreach collection="java.util.List" item="arrTags">
         WHERE btname = Trim(Replace(#{arrTags}," ",""))
        </foreach>
    </update>

    <insert id="basicTagInsert">
        /* basicTagInsert 태그 Insert*/
        INSERT INTO basictag
        <foreach collection="java.util.List" item="arrTags">
               VALUES (
                       (SELECT ISNULL(MAX(btidx),0)+1 FROM basictag)
                      , Trim(Replace(#{arrTags}," ",""))
                      , '1'
                      , #{strLoginMemID}
                      , GETDATE()
                      )
        </foreach>
    </insert>

    <insert id="basicTagMapInsert">
         /* basicTagMapInsert 태그맵 Insert*/
        INSERT INTO basictagmap (
                                  btype
                                , bid
                                , bidx
                                , btidx
                                )
        <foreach collection="java.util.List" item="arrTags">
               VALUES ( #{tagTypeMySet}
                      , #{strLoginMemID}
                      , #{hseqno}
                      , (SELECT btidx FROM basictag WHERE btname= Trim(Replace(#{arrTags}," ","")))
                      )
        </foreach>
    </insert>

    <select id="getCartRecipe">
        /* getCartRecipe 장바구니 레시피 가져오기*/
        SELECT t.memcd
             , t.pic1
             , m.memid
        FROM CART_RECIPE_HEADER t
          JOIN MB_MASTER m
            ON t.memcd = m.memcd
         WHERE hseqno = #{hseqno}
    </select>

    <delete id="deleteCartRecipe">
        /* deleteCartRecipe 장바구니 레시피에 포함된 상품 목록정보 삭제*/
        DELETE FROM CART_RECIPE_LINE
                WHERE lseqno = #{hseqno}
    </delete>

    <delete id="deleteCartRecipeHeader">
        /* deleteCartRecipeHeader 장바구니 레시피 헤더 삭제*/
        DELETE FROM CART_RECIPE_HEADER
                WHERE hseqno = #{hseqno}
    </delete>

    <delete id="deleteCartRecipeComments">
        /* deleteCartRecipeComments 해당 장바구니 레시피와 관련 된 댓글 정보 삭제 */
        DELETE FROM basicomments
                WHERE rtype = #{tagTypeMySet}
                  AND ridx = #{hseqno}
                  AND rid = #{rs_memid}
    </delete>

    <delete id="deleteBasicTagMap">
        /* deleteBasicTagMap 해당 장바구니 레시피와 연결 된 태그 정보(TAGMAP)삭제*/
        DELETE FROM basictagmap
                WHERE btype = #{tagTypeMySet}
                  AND bid = #{rsMemid}
                  AND bidx = #{hseqno}
    </delete>

    <update id="modifyCartRecipe">
         /* modifyCartRecipe 장바구니 레시피 수정*/
        UPDATE CART_RECIPE_HEADER
        SET titlex = #{titlex}
          , hmemo = #{hmemo}
          , share = #{share}
          , pic1 = #{pic1}
          , updt = GETDATE()
         WHERE hseqno = #{hseqno}
           AND memcd = #{strLoginMemCD}
    </update>
    
    <insert id="otherUserRecipeSave">
        /* otherUserRecipeSave 다른 사용자 레시피 담기*/
        INSERT INTO shopping_basket(
                                     memcd
                                   , crtidx
                                   , gdcd
                                   , gdcnt
                                   , indt
                                   , od_gubun
                                   )
              SELECT #{strLoginMemCD}
                   , ISNULL((SELECT MAX(crtidx) FROM shopping_basket WHERE memcd=#{strLoginMemCD}),0)+t.lno
                   , t.gdcd
                   , '1', GETDATE(), '11'
              FROM CART_RECIPE_LINE t
                JOIN GD_MASTER gd
                  ON t.gdcd=gd.gdcd
                LEFT JOIN GD_CNT gc
                       ON t.gdcd=gc.gdcd
               WHERE t.lseqno= #{hseqno}
                 AND gd.useyn='Y'
                 AND gd.soldoutyn='N'
                 <![CDATA[
                 AND ISNULL(gc.gdcnt, 99999) >= 1
                 ]]>
                 AND t.gdcd NOT IN ( SELECT gdcd FROM shopping_basket
                                                  WHERE memcd=#{strLoginMemCD})
    </insert>

    <update id="putRecipeCntSave">
        /* putRecipeCntSave 담아간 횟수 저장 / 본인 제외 */
        UPDATE CART_RECIPE_HEADER
        SET scount = scount+1
         WHERE hseqno = #{hseqno}
           <![CDATA[
           AND memcd <> #{strLoginMemCD}
           ]]>
    </update>

    <select id="totalCnt">
       /*totalCnt 횟수 체크*/
        SELECT COUNT(1) TCNT
        FROM shopping_basket
         WHERE memcd = #{strLoginMemCD}
    </select>

    <update id="recommendCartRecipe">
       /* recommendCartRecipe 장바구니 레시피 추천 */
        UPDATE CART_RECIPE_HEADER
           SET rcount = rcount + 1
         WHERE hseqno = #{hseqno}
           <![CDATA[
           AND memcd<>#{strLoginMemCD}
           ]]>
    </update>

<!--    'System        : m.62life.com
    'Program      :
    'Title         : 자연이랑모바일 - 내가 만드는 묶음상품 수정하기
    'File          : userset03_m.asp
    'Program Type  : asp
    'Analyst       :
    'Author        : HyeokOh
    'Date Started  : 20150923
    'Last Modified :
    'Called By     :
    'Parameters    :
    'Purpose       :
    'Version       :

    'Modified  Author       V/M	    Reason For Modification

    '20150923  HyeokOh      0.1	    처음 작성
    '20151124  hwkim        0.9     전반적인 재 구성 작업
    '20161213  hwkim        0.9.2   레이아웃 표준 규칙 수정
    -->
    <select id="getCartRecipeHeader">
        SELECT titlex
             , hmemo
             , memcd
             , share
             , pic1
        FROM CART_RECIPE_HEADER
        WHERE hseqno = #{hseqno}
    </select>

    <select id="getCartRecipeLine">
        SELECT t.gdcd
             , t2.gdname
             , t2.unit
        FROM CART_RECIPE_LINE t
                 JOIN GD_MASTER t2 ON t2.gdcd=t.gdcd
        WHERE t.lseqno = #{hseqno}

    </select>
</mapper>