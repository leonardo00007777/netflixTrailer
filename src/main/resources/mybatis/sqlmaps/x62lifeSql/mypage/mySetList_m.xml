<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="mySetList">
<!--    'System        : m.62life.com
    'Program       :
    'Title         : 자연이랑모바일 - 내가 만든 묶음상품
    'File          : mysetlist_m.asp
    'Program Type  : asp
    'Analyst       :
    'Author        : hwkim
    'Date Started  : 20151015
    'Last Modified :
    'Called By     :
    'Parameters    :
    'Purpose       :
    'Version       :
    '
    'Modified   Author  V/M     Reason For Modification

    '20151015   hwkim   0.9     처음 작성
    '20161204   hyeok   0.9.1   사이트 리뉴얼 layout적용
    '20161212   hwkim   0.9.2   레이아웃 표준 규칙 수정-->
    <sql id="conditionCommon">
        /* 조건 공통부 */
        <if test='searchValue != "" '>
            AND titlex LIKE '%'  + #{searchValue} + '%'
        </if>
        <if test='tagName != "" '>
            AND hseqno IN (SELECT bidx
                           FROM basictagmap
                            WHERE btype=#{tagTypeMySet}
                              AND btidx IN (SELECT btidx
                                            FROM basictag
                                             WHERE btname = #{tagName}
                                           )
                           )
        </if>
    </sql>
    <select id="mySetListPaging">
        /* mySetListPaging 내가만드는 묶음 상품 리스트 페이징*/
        SELECT CEILING(CAST(COUNT(1) AS FLOAT)/ #{intPagePerItem} ) maxpage
             , COUNT(hseqno) CNT
        FROM CART_RECIPE_HEADER
         WHERE 1=1
           AND (share='Y' OR memcd = #{strLoginMemCD})
         <include refid="conditionCommon"/>
    </select>

    <select id="mySetList">
        /* mySetList 내가만드는 묶음 상품 리스트*/
        SELECT * FROM ( 
                          SELECT t.hseqno
                               , t.titlex
                               , t.memcd
                               , t.pic1
                               , t2.memname
                               , t.hmemo
                               , t.rcount
                               , t.icount
                               , ROUND(((t.scount*0.7)+(t.rcount*0.2)+(t.icount*0.1)),1) AS popscore
                               , REPLACE(CONVERT(VARCHAR(20),t.indt,111),'/','-') AS indt
                               , FLOOR( (ROW_NUMBER() OVER ( ORDER BY hseqno DESC ) - 1 ) / #{intPagePerItem} + 1) AS page
                               , (SELECT COUNT(rseqno)
                                  FROM basicomments
                                   WHERE rtype = #{tagTypeMySet}
                                     AND rid = t2.MEMID
                                     AND ridx = t.hseqno
                          ) AS rcnt
                          FROM CART_RECIPE_HEADER t
                                   JOIN MB_MASTER t2 ON t.memcd=t2.memcd
                          WHERE 1=1
                          <include refid="conditionCommon"/>
                            AND t.memcd = #{strLoginMemCD}
                      ) AS pl
                  WHERE page = #{intPage}
    </select>

    <select id="mySetListProd">
        /* mySetListProd 내가만드는 묶음 상품 상세*/
        SELECT cl.gdcd
             , g.gdname
             , cl.gdqty
        FROM CART_RECIPE_LINE cl
          JOIN GD_MASTER g
            ON g.gdcd = cl.gdcd
         WHERE cl.lseqno = #{rs_hseqno}
    </select>
</mapper>