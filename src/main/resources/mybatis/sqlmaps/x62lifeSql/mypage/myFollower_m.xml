<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="myFollower">
<!--    'System        : m.62life.com-->
<!--    'Program       :-->
<!--    'Title         : 자연이랑모바일 - 추천인 주문현황-->
<!--    'File          : myfollower_m.asp-->
<!--    'Program Type  : asp-->
<!--    'Analyst       :-->
<!--    'Author        : sykim-->
<!--    'Date Started  : 20190308-->
<!--    'Last Modified :-->
<!--    'Called By     :-->
<!--    'Parameters    :-->
<!--    'Purpose       :-->
<!--    'Version       :-->
<!--    '-->
<!--    'Modified   Author  V/M     Reason For Modification-->
<!--    '-&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;  &#45;&#45;&#45;&#45;&#45;&#45;  &#45;&#45;&#45;&#45;    &#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;-->
<!--    '20190308   sykim   0.9     처음 작성-->
<!--    '20190314   hwkim   0.9.1   추천인 수 정보 추가, 주문 현황 범위 확장(미 구매 주문자 포함 표시)-->
<!--    '20190327   hwkim   -       정책은 2019년 4월 1일부터 시행-->
    <select id="getMyFollowerCnt">
        /* getMyFollowerOrderCnt 나를 추천한 사람 */
        SELECT COUNT(r.memcd) CNT
        FROM recommender_table r
          JOIN mb_master m 
            ON r.memcd = m.memcd
         WHERE 1=1
           AND r.rmemcd = #{strLoginMemCD}
           <![CDATA[
           AND r.indt >= CONVERT(DATETIME,'2019-04-01',21)
           AND r.rmemcd = 'I1061364'
          ]]>
    </select>
    <select id="getRecommenderInfo">
        /* getRecommender 추천인 이름,아이디,최종주문,결제, 구매금액*/
        SELECT r.memcd
             , m.memname
             , m.memid
             , COUNT(p.paynum) paycnt
             , CONVERT(VARCHAR,MAX(p.paydt),23) paydt
             , SUM(ISNULL(p.ttlprice,0)) ttlsum
        FROM recommender_table r
          JOIN mb_master m 
            ON r.memcd = m.memcd
          LEFT JOIN od_pay p 
                 ON m.memcd = p.memcd
                AND p.paystcd = #{paystPay}
                AND p.paydt >= CONVERT(DATETIME,#{strStartDt},21)
                AND p.paydt < CONVERT(DATETIME,#{strEndDt},21)+1
                AND p.paynum IN (SELECT paynum FROM od_header
                                                WHERE paystcd = #{paystPay}
                                                  AND odgubun IN (#{nSalesOrderType}))
         WHERE 1=1
           AND r.rmemcd = #{strLoginMemCD}
           <![CDATA[
           AND r.indt >= CONVERT(DATETIME,'2019-04-01',21)
           ]]>
           AND r.rmemcd = 'I1061364'
        GROUP BY r.memcd, m.memname, m.memid
        ORDER BY memname
    </select>
</mapper>