<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="repeatedlyGoods">
<!--    'System        : m.62life.com
    'Program       :
    'Title         : 자연이랑모바일 - 자주구매 상품
    'File          : repeatedlygoods_m.asp
    'Program Type  : asp
    'Analyst       :
    'Author        : hwkim
    'Date Started  : 20130605
    'Last Modified :
    'Called By     :
    'Parameters    :
    'Purpose       :
    'Version       :
    '
    'Modified   Author  V/M     Reason For Modification

    '20130605   hwkim   0.9     처음 작성
    '20151112   hwkim   0.9.1   상품 리스트 표시 디자인 통일
    '20161208   hwkim   0.9.2   리뉴얼 및 표준 레이아웃 적용
    '20170420   hwkim   0.9.3   당일발송 주문 담기 처리 추가. / thedaysyn
    '20170613   hwkim   0.9.5   당일발송 주문 담기 처리 제외 (1차범위)
    '20180114   hwkim   0.9.6   상품표시 레이아웃 개선
    '20180803   hwkim   0.9.7   상품등급 라벨 표시 등
    '20180903   hyeok   0.9.8   신속,예약 상품 모두 표시
    '20200324   sykim   0.9.9   상품정보 단일화(gd_master & od_reservegoods > gd_master) 적용.-->
    <select id="repeatedlyGoodsList">
        /*repeatedlyGoodsList 자주 구매한 상품 리스트*/
        SELECT *
        FROM (
                 SELECT a.gdcd
                      , g.gdname
                      , g.unit
                      , g.price1
                      , dbo.getMasterPrice(g.gdcd) saleprice
                      , dbo.getProductPrice(#{strMEMGRPCD},#{strGroupSalePolicy},g.gdcd) AS groupsaleprice
                      , dbo.getIsGroupSaleGoods(#{strMEMGRPCD},#{strGroupSalePolicy},g.gdcd) AS isgroupsale
                      , g.gdimg
                      , g.mgdimg1
                      , g.divcd
                      , g.div1
                      , ISNULL(g.deliverydtyn,'N') deliverydtyn
                      , ISNULL(g.soldoutyn,'N') soldoutyn
                      , ISNULL(s.gdcnt,99999) gdcnt
                      , a.rtype
                      , a.tcount
                      , a.tsales
                      , g.shortdesc
                      , g.plandate
                      , '01' odtype2
                      , CASE g.dispatchtype WHEN 'I' THEN '11' WHEN 'O' THEN '15' END odtype
                      , ISNULL(g.reserveyn,'N') reserveyn
                 FROM repeatedlyg a
                   JOIN gd_master g
                     ON a.gdcd = g.gdcd
                   LEFT JOIN gd_cnt s
                          ON g.gdcd = s.gdcd
                   LEFT JOIN od_reservegoods r
                          ON g.gdcd = r.gdcd
                         AND r.useyn = 'Y'
                         AND DATEDIFF(D,CONVERT(DATETIME,r.od_from,120),GETDATE()) >= 0
                         AND DATEDIFF(D,GETDATE(),CONVERT(DATETIME,r.od_to,120)) >= 0
                  WHERE g.useyn = 'Y'
                    AND (g.divcd = '30' OR (g.divcd = '20'
                                            AND g.deliverydtyn = 'N'
                                            AND g.gdcd NOT IN ('A3','A4','A7','A8','B2','B3','C3','G9','H6','H9','P9','R6','R9','T1','T2','T3','Z02','Z21','Z22','Z25','Z26','Z94')
                                            )
                        )
                   AND (g.reserveyn = 'N' OR (g.reserveyn = 'Y' AND r.gdcd IS NOT NULL))
                   AND a.memcd = #{strLoginMemCd}
             ) a
        <choose>
            <when test='orderBy == "PD"'>
               ORDER BY groupsaleprice
            </when>
            <when test='orderBy == "PU"'>
               ORDER BY groupsaleprice DESC
            </when>
            <when test='orderBy == "PN"'>
               ORDER BY a.gdname
            </when>
            <when test='orderBy == "RP"'>
                ORDER BY a.rtype DESC, a.gdname
            </when>
            <otherwise>
                ORDER BY CASE WHEN a.rtype='R' THEN 0 ELSE 1 END, a.tcount DESC, a.divcd, a.div1, a.gdcd
            </otherwise>
        </choose>
    </select>
</mapper>