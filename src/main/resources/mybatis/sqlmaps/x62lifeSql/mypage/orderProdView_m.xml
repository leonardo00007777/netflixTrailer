<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="orderProdView00">
<!--    'System        : m.62life.com
    'Program       :
    'Title         : 자연이랑모바일 - 받은주문확인
    'File          : orderprodreview00_m.asp
    'Program Type  : asp
    'Analyst       :
    'Author        : hyeok
    'Date Started  : 20180326
    'Last Modified :
    'Called By     :
    'Parameters    :
    'Purpose       :
    'Version       :
    '
    'Modified   Author  V/M     Reason For Modification

    '20180326   hyeok   0.9     처음 작성-->
   <update id="orderHeaderUpdate">
      /* orderHeaderUpdate 배송정보 업데이트*/
       UPDATE od_header
       SET dlvstcd = #{dlvstComplete}
         , updt = GETDATE()
         , dlvdt = CASE WHEN ISDATE(ISNULL(dlvdt, '')) = 0
                          THEN CONVERT(CHAR(10), GETDATE(), 21)
                        ELSE dlvdt
                   END
        WHERE ordnum = #{strORDNUM}
          AND dlvstcd = #{dlvstDlv}
   </update>
    
<!--    'System        : m.62life.com
    'Program       :
    'Title         : 자연이랑모바일 - 수취확인 상품평 작성
    'File          : orderprodreview01_m.asp
    'Program Type  : asp
    'Analyst       :
    'Author        : hyeok
    'Date Started  : 20180319
    'Last Modified :
    'Called By     :
    'Parameters    :
    'Purpose       :
    'Version       :
    '
    'Modified   Author  V/M     Reason For Modification
 
    '20180319   hyeok   0.9     처음 작성
    '20180326   hyeok   0.9     기능수정(첫번째상품평열기, 작성글자수검사)
    '20180328   hyeok   0.9.1   이미작성된 상품평 있을경우 '상품평 수정' 표시-->
    
    <select id="getProdOrderDt">
        /* getProdOrderDt 주문일자 */
        SELECT ordnum
             , CONVERT(VARCHAR(19), orddt,21) orddt
        FROM od_header
         WHERE ordnum = #{strORDNUM}
    </select>
    
    <select id="getProdOdgubun">
        /* getProdOdgubun 상품 구분*/
        SELECT h.ordnum
             , CASE h.odgubun WHEN '05' THEN '자동'
                              WHEN '10' THEN '업체'
                              WHEN '11' THEN '신속'
                              WHEN '12' THEN '예약'
                              WHEN '15' THEN '업체'
                              ELSE CASE gm.divcd WHEN '10' THEN '패키지' ELSE '지정일' END
               END gubun
             , gm.gdcd
             , gm.gdname
             , l.gdcnt, l.price
             , gm.gdimg
             , CASE h.odgubun WHEN '11' THEN 20
                              WHEN '12' THEN 30
                              WHEN '15' THEN 50
                              ELSE CASE gm.divcd WHEN '10' THEN 10 ELSE 40 END
               END AS sort
             , pr.rmemo, pr.grade
        FROM od_pay p
          JOIN od_header h 
            ON h.paynum = p.paynum
          JOIN od_goods l 
            ON l.ordnum = h.ordnum 
           AND l.paynum = h.paynum
          LEFT JOIN gd_master gm 
                 ON gm.gdcd = l.gdcd
          LEFT JOIN cd_master c1 
                 ON c1.cdtype = '04' 
                AND c1.cdcode = h.dlvstcd
          LEFT JOIN productreview pr 
                 ON pr.ordnum = l.ordnum 
                AND pr.ridx = l.gdcd
         WHERE p.paystcd = #{paystPay}
           AND h.paystcd = #{paystPay}
           AND h.dlvstcd IN (#{dlvstComplete})
           AND h.ordnum = #{strORDNUM}
        ORDER BY sort, l.ordnum, h.dlvdt, l.gdcd
    </select>

<!--    'System        : m.62life.com
    'Program       :
    'Title         : 자연이랑모바일 - 상품평가 완료
    'File          : orderprodreview02_m.asp
    'Program Type  : asp
    'Analyst       :
    'Author        : hyeok
    'Date Started  : 20180320
    'Last Modified :
    'Called By     :
    'Parameters    :
    'Purpose       :
    'Version       :
    '
    'Modified   Author  V/M     Reason For Modification

    '20180320   hyeok   0.9     처음 작성
    '20180326   hyeok   0.9     기능수정(건너뛰기처리, 빈값처리, 작성완료안내UI추가)-->
    <select id="getProdReviewCnt">
        /*getProdReviewCnt 상품리뷰 Cnt*/
        SELECT COUNT(rseqno) rscnt
        FROM productreview
        WHERE ridx = #{strGdCd}
          AND rwuid = #{strLoginMemID}
          AND ordnum = #{strORDNUM}
    </select>

    <update id="alreadyExistReview">
        /*alreadyExistReview 상품평이 존재할 경우 */
        UPDATE productreview
        SET grade = #{strReviewGrade}
          , rmemo = #{strReviewContent}
         WHERE ridx = #{strGdCd}
           AND rwuid = #{strLoginMemID}
           AND ordnum = #{strORDNUM}
    </update>

    <select id="getReviewDate">
        /* getReviewDate 포인트 지급용 Date 상품평 작성 포인트 지급 함수는 2019.04.03 이후로 호출되도록 설정*/
        SELECT DateDiff("D", '2019-04-03', getDate())
    </select>

    <insert id="notExistReview">
        /*notExistReview 신규 상품평 Insert*/
        INSERT INTO productreview(
                                   rtype
                                 , rid
                                 , ridx
                                 , rrseqno
                                 , rdepth
                                 , rmemo
                                 , rwip
                                 , rwuid
                                 , ragree
                                 , roppose
                                 , rblind
                                 , device
                                 , grade
                                 , ordnum
                                 )
               VALUES (
                        'PR'
                      , 'gd_master'
                      , #{strGdCd}
                      , NULL
                      , 0
                      , #{strReviewContent}
                      , #{remoteAddr}
                      , #{strLoginMemID}
                      , 0
                      , 0
                      , 'N'
                      , 'M'
                      , #{strReviewGrade}
                      , #{strORDNUM}
                      )
    </insert>
</mapper>