<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="myPage">
<!--    'System        : m.62life.com-->
<!--    'Program       :-->
<!--    'Title         : 자연이랑모바일 - 마이페이지-->
<!--    'File          : mypage_m.asp-->
<!--    'Program Type  : asp-->
<!--    'Analyst       :-->
<!--    'Author        : hwkim-->
<!--    'Date Started  : 20130621-->
<!--    'Last Modified :-->
<!--    'Called By     :-->
<!--    'Parameters    :-->
<!--    'Purpose       :-->
<!--    'Version       :-->
<!--    '-->
<!--    'Modified   Author  V/M     Reason For Modification-->
<!--    '-&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;  &#45;&#45;&#45;&#45;&#45;&#45;  &#45;&#45;&#45;&#45;    &#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;-->
<!--    '20130621   hwkim   0.9     처음 작성-->
<!--    '20141210   hwkim   0.9.1   1대1문의 목록 추가-->
<!--    '20161127   hwkim   0.9.2   리뉴얼-->
<!--    '20170808   hwkim   0.9.3   12주년 배너 임시 추가 - 추후 삭제 함.-->
<!--    '20171214   hwkim   0.9.4   상담내역 목록 표시 변경-->
<!--    '20180205   hwkim   0.9.5   회원정보 수정 추가-->
<!--    '20190104   hwkim   0.9.6   지원금 완전소진 정보(별) 표시 제거-->
<!--    '20200616   sykim   -       MONTHLYCLOSING, subvention_dss(친환경기여도) 표시 안하는 정보 주석처리.-->
<!--    '20200827   chhyeon 0.9.7   진행주문보기 버튼 추가-->
    <select id="myPageDefaultInfo">
        /* myPageDefaultInfo 마이페이지 기본정보*/
        SELECT ordered
             , indelivery
             , lastmonthttl
             , thismonthttl
        FROM (
               SELECT COUNT(a.paynum) ordered
               FROM od_pay a
                 JOIN od_header b
                   ON a.paynum = b.paynum
                WHERE a.memcd = #{strLoginMEMCD}
                  AND a.paystcd BETWEEN #{paystINSTAY} AND #{paystPay}
                  <![CDATA[
                  AND DATEDIFF(d,a.fixdt,GETDATE()) <= 30
                  AND b.paystcd BETWEEN #{paystINSTAY} AND #{paystPay}
                  AND b.dlvstcd <= #{dlvstDlv}
                  ]]>
             ) AS a
           , (
               SELECT COUNT(a.paynum) indelivery
               FROM od_pay a
                 JOIN od_header b ON a.paynum = b.paynum
                WHERE a.memcd = #{strLoginMEMCD}
                 AND a.paystcd = #{paystPay}
                 <![CDATA[
                 AND DATEDIFF(d,a.fixdt,GETDATE()) <= 30
                 AND b.paystcd = #{paystPay}
                 AND (b.dlvstcd >= #{dlvstDlv} AND b.dlvstcd < #{dlvstComplete})
                 ]]>
             ) AS b
           , (
               <![CDATA[
               SELECT ISNULL(SUM(CASE WHEN paydt >= CONVERT(DATETIME,#{lastMonthFirstDay},21) AND paydt < CONVERT(DATETIME,#{lastMonthLastDay},21)+1
                                        THEN ttlprice
                                      ELSE 0
                                 END),0) lastmonthttl
                    , ISNULL(SUM(CASE WHEN paydt >= CONVERT(DATETIME,#{thisMonthFirstDay},21) AND paydt < CONVERT(DATETIME,#{date},21)+1
                                        THEN ttlprice
                                      ELSE 0
                                 END),0) thismonthttl
               ]]>
               FROM od_pay
                WHERE memcd = #{strLoginMemcd}
                  AND paystcd = #{paystPay}
                  <![CDATA[
                  AND paydt >= CONVERT(DATETIME,#{lastMonthFirstDay},21)
                  AND paydt < CONVERT(DATETIME,#{date},21)+1
                  ]]>
                  AND paynum IN (SELECT paynum FROM od_header
                                                WHERE paystcd = #{paystPay}
                                                  AND odgubun IN ( #{nSalesOrderType}))
              ) AS c
    </select>
    
 <!-- 미사용
    <select id="getEcoContributionRank">
        /*getEcoContributionRank  지난달 친환경 기여도 순위 구함*/
        SELECT s.rankx
             , s.rankx2
        <choose>
            <when test='strMEMGRPCD = "03" Or strMEMGRPCD = "26" Or strMEMGRPCD = "27"
                        Or strMEMGRPCD = "28" Or strMEMGRPCD = "33 Or strMEMGRPCD = "95"
                        Or strMEMGRPCD = "140" Or strMEMGRPCD = "148"'>
                , (SELECT COUNT(DISTINCT memcd) FROM subvention_dss WHERE grpcd IN ('03','26','27','28','33','95','140','148') AND payym = #{lastMonth}) maxx
            </when>
            <otherwise>
                , (SELECT COUNT(DISTINCT memcd) FROM subvention_dss WHERE grpcd = #{strMEMGRPCD} AND payym = #{lastMonth} ) maxx
            </otherwise>
        </choose>
             , x.rownum
             , (SELECT COUNT(1) cnt FROM subvention_dss WHERE payym=#{lastMonth}) cnt
             , (x.rownum*100.0)/(SELECT COUNT(1) cnt FROM subvention_dss WHERE payym=#{lastMonth}) xratio
        FROM subvention_dss s
          JOIN (SELECT row_number() over(ORDER BY sumttlprice DESC) as rownum
                     , memcd
                FROM subvention_dss
                 WHERE payym = #{lastMonth}) x 
            ON x.memcd=s.memcd
         WHERE s.memcd=#{strLoginMemCd}
           AND s.payym=#{lastMonth}
    </select>-->
  
    <!-- 미사용  
    <select id="nowCustomerBuyHistory">
        /* nowCustomerBuyHistory 현재 고객 구매이력*/
        SELECT m.ym
             , ISNULL(d.sumttlprice,0) sumttlprice
        FROM (SELECT DISTINCT CONVERT(CHAR(6)
                   , DATEADD(D,number, #{startMonth} + '01'),112) ym
             FROM master..spt_values
              WHERE type = P
                AND number <= DATEDIFF(d, #{startMonth} + '01', #{endMonth} + '01')
             ) m  /*날짜기준 Table*/
          LEFT JOIN subvention_dss d
                 ON m.ym = d.payym
                AND d.memcd =  #{strLoginMemCd}
                AND d.payym BETWEEN  #{startMonth} AND  #{endMonth}
        ORDER BY m.ym
    </select>-->
    
<!-- 미사용
    <select id="nowCustomerBuyAverage">
        /*nowCustomerBuyAverage 현재 고객 소속사 구매 평균금액 추이*/
        SELECT m.ym
             , ISNULL(SUM(d.sumttlprice),0)/(CASE WHEN COUNT(d.memcd)=0 THEN 1 ELSE COUNT(d.memcd) END) grpavg
        FROM (SELECT DISTINCT CONVERT(CHAR(6),DATEADD(D,number,#{startMonth} + '01'),112) ym
               FROM master..spt_values
                WHERE type = 'P'
                  <![CDATA[
                  AND number <= DATEDIFF(d,#{startMonth} +'01',#{endMonth} + '01')
                  ]]>
             ) m  /*'날짜기준 Table*/
          LEFT JOIN subvention_dss d
                 ON m.ym = d.payym
                AND d.grpcd = #{strMEMGRPCD}
                AND d.payym BETWEEN #{startMonth} AND #{endMonth}
                <![CDATA[
                AND d.sumttlprice > 0
                ]]>
        GROUP BY m.ym
        ORDER BY m.ym
    </select>-->
<!--  미사용
    <select id="allBuyAverage">
        /*전체 평균구매금액 추이 */
        SELECT m.ym
             , ISNULL(SUM(d.sumttlprice),0)/(CASE WHEN COUNT(d.memcd)=0 THEN 1 ELSE COUNT(d.memcd) END) grpavg
        FROM (SELECT DISTINCT CONVERT(CHAR(6),DATEADD(D,number,#{startMonth} + '01'),112) ym
              FROM master..spt_values
               WHERE type = 'P'
                 <![CDATA[
                 AND number <= DATEDIFF(d,#{startMonth}  + '01', #{endMonth} +'01')
                 ]]>
             ) m  /*'날짜기준 Table*/
          LEFT JOIN subvention_dss d
                 ON m.ym = d.payym
                AND d.payym BETWEEN #{startMonth} +'' AND #{endMonth} +''
                <![CDATA[
                AND d.sumttlprice > 0
                ]]>
        GROUP BY m.ym
        ORDER BY m.ym
    </select>-->

    <select id="getMembershipLevel">
        /*
        getMembershipLevel 멤버십레벨 구하기
            '멤버십 레벨 기본값.
             memLevel = "01"
             memLevelDesc = "씨앗"
             memLevelRatio = "0.5"
             memLevelImg1 = "icon_member1_circle.png"
             memLevelImg2 = "icon_member1_outline.png"
             memLevelColor = "color1"
        */
        SELECT l.mlevel
             , m.mvlevel
             , m.mvpntr
        FROM member_level l
          LEFT JOIN member_level_master m
                 ON l.mlevel = m.mvcode
                AND m.mvuse = 'Y'
         WHERE l.yyyymm = CONVERT(CHAR(4),DATEPART(YY,GETDATE()))
                        + RIGHT('0'+CONVERT(VARCHAR(2),DATEPART(M,GETDATE())),2)
          AND l.memcd = #{strLoginMemCd}
    </select>

    <select id="getMemberCurrencyInfo">
         /* getMemberCurrencyInfo 고객정보 현황(포인트,예치금 등)*/
        SELECT *
        FROM mb_currency
         WHERE memcd = #{strLoginMemCd}
    </select>
</mapper>