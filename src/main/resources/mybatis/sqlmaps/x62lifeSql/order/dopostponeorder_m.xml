<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="dopostponeorder">
    <select id="checkCancelLimit">
        /*checkCancelLimit 취소 횟수 제한 체크*/
        SELECT ccount 
        FROM LUNCH_ORDER_POSTPONE_LIMIT
         WHERE paynum = #{strPAYNUM}
    </select>
    
    <select id="errorCodeZero">
        /* errorCodeZero errorCode = "0000"*/
        SELECT dbo.GetNextLunchDlvDt(#{strPAYNUM}) nextdlvdt 
        FROM od_pay 
         WHERE paystcd IN (#{paystPay})
           AND paynum = #{strPAYNUM} 
           AND memcd = #{strLoginMEMCD} 
    </select>
    
    <update id="postPoneDelivery">
        /* postPoneDelivery 배달 연기 요청 업데이트*/
        UPDATE od_header 
            SET dlvdt = #{postponeDate} 
              , updt = getdate()
          WHERE paynum = #{strPAYNUM}
            AND ordnum = #{strORDNUM}
            AND dlvstcd IN (#{DLVST_RESERVE})
            AND paystcd IN (#{PAYST_PAY})
    </update>

    <update id="postPoneLimitUpdate">
        /* postPoneLimitUpdate 주문 연기 제한 업데이트*/
        UPDATE LUNCH_ORDER_POSTPONE_LIMIT 
            SET ccount = ccount+1 
              , lastordnum = #{strORDNUM}
              , lastupdt = getdate()
              , lastupid = #{strLoginMEMCD}
         WHERE paynum = #{strPAYNUM}
    </update>
    
    <insert id="postPoneOrderInsert">
        /* postPoneOrderInsert 주문 연기 제한 내역이 없을 때*/
        INSERT INTO LUNCH_ORDER_POSTPONE_LIMIT(
                                                paynum
                                              , ccount
                                              , lastordnum
                                              , lastupdt
                                              , lastupid
                                              ) 
        VALUES (
                 #{strPAYNUM}
               , 1
               , #{strORDNUM}
               , getdate()
               , #{strLoginMEMCD}
               )
    </insert>
</mapper>