<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="docancelorder">
<!--    'System        : 62life.com
    'Program       :
    'Title         : 주문취소처리
    'File          : docancelorder_m.asp
    'Program Type  : asp
    'Analyst       :
    'Author        : hwkim
    'Date Started  : 20150122
    'Last Modified :
    'Called By     :
    'Parameters    :
    'Purpose       :
    'Version       :
    '
    'Modified   Author      V/M     Reason For Modification
    '-&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;  &#45;&#45;&#45;&#45;&#45;&#45;      &#45;&#45;&#45;&#45;    &#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;
    '20150122   hwkim       0.9     처음작성
    '20160426   hwkim       0.9.1   반환값 flagSuccess 변경 / JSON 객체 true, false 예약어 이슈처리
    '20170524   sykim       0.9.2   베네피아와 시럽페이 취소를 위한 include 추가.
    '20180214   hyeok       -&#45;&#45;     SMS > 알림톡 변경 적용 (lib.database.asp 필수)
    '20190503   sykim       0.9.3   결제번호에 해당하는 주문들의 현재 상태(배송상태, 전송여부)를 파악하여 취소가 불가할 경우 실패하도록 함.-->

    <sql id="memConditionCommon">
        <choose>
            <when test='strLoginMemCD != "" '>
                AND a.memcd = ${strLoginMemCD}
            </when>
            <otherwise>
                AND b.memcd = ${memcdNoMember}
                AND b.memname = ${strSName}
                AND REPLACE(b.telno,'-','') = REPLACE(${strSTelNO},"-","")
            </otherwise>
        </choose>
    </sql>
    <select id="checkPaymentEffectiveness">
        SELECT a.paynum
             , ISNULL(a.pntprice,0) pntprice
             , ISNULL(a.accprice,0) accprice
             , ISNULL(a.dpsprice,0) dpsprice
        FROM od_pay a
          JOIN od_member b 
            ON a.paynum = b.paynum
         WHERE a.paystcd IN (#{paystInstay}, #{paystPay}, #{paystCancelreq})
           AND a.paynum = #{strPAYNUM}
         <include refid="memConditionCommon">
             <property name="strLoginMemCD" value="strLoginMemCD"/>
             <property name="memcdNoMember" value="memcdNoMember"/>
             <property name="strSName" value="strSName"/>
             <property name="strSTelNO" value="strSTelNO"/>
         </include>
    </select>
    
    <select id="estimationCancel">
        SELECT MAX(dlvstcd) maxdlvstcd
             , MAX(sendyn) maxsendyn
        FROM od_header
         WHERE paynum = #{strPAYNUM}
    </select>
    
    <select id="cancelOrder">
        SELECT t1.paycd
             , t1.paystcd
             , t4.paystcd AS ordpaystcd
        FROM od_pay t1
          JOIN od_member t2 
            ON t2.paynum = t1.paynum
          JOIN od_relation t3 
            ON t3.paynum = t1.paynum
          JOIN od_header t4 
            ON t4.ordnum = t3.ordnum
         WHERE t1.paynum = #{strPAYNUM}
           AND t4.ordnum LIKE #{strORDNUM}
        <include refid="memConditionCommon">
            <property name="strLoginMemCD" value="strLoginMemCD"/>
            <property name="memcdNoMember" value="memcdNoMember"/>
            <property name="strSName" value="strSName"/>
            <property name="strSTelNO" value="strSTelNO"/>
        </include>
    </select>
</mapper>