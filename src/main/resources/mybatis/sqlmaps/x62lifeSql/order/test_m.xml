<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="test">
    <select id="orderPaymentTest">
       /* orderPaymentTest 주문결제 테스트*/
        SELECT odtype
             , crtidx
             , gdcd
             , unit
             , gdname
             , price
             , gdcnt
             , price*gdcnt tsales
             , limitgdcnt
             , gdimg
             , div1
             , issale
             , qtysaleyn
             , soldoutyn
             , thedaysyn 
             , CASE WHEN vat = '1' THEN CEILING(price*gdcnt/1.1) 
                    WHEN vat = '2' THEN 0 
                    ELSE 0 
               END AS tax 
             , CASE WHEN vat = '1' THEN price*gdcnt-CEILING(price*gdcnt/1.1) 
                    WHEN vat = '2' THEN 0 
                    ELSE 0 
               END AS vat 
        FROM ( 
               SELECT CASE t2.divcd WHEN '10' THEN 'PKG' 
                                    ELSE od_gubun 
                      END AS odtype 
                    , t.crtidx
                    , t.gdcd
                    , t2.unit
                    , CASE od_gubun WHEN '12' THEN t4.gdnm ELSE t2.gdname END AS gdname 
                    , CASE WHEN t2.qtysaleyn='Y' THEN dbo.getQtySalePrice(t.gdcd, t.gdcnt, dbo.getProductPrice(#{strMemGrpCd},#{strGroupSalePolicy},t.gdcd)) 
                           ELSE dbo.getProductPrice(#{strMemGrpCd},#{strGroupSalePolicy},t.gdcd) 
                       END * ISNULL(t6.weekcnt, 1) AS price 
                    , t.gdcnt 
                    , ISNULL(t5.gdcnt, 9999) limitgdcnt 
                    , t2.gdimg
                    , t2.vat
                    , t2.div1
                    , dbo.getIsGroupSaleGoods(#{strMemGrpCd},#{strGroupSalePolicy},t.gdcd) issale
                    , CASE WHEN ISNULL(t2.qtysaleyn,'') = '' THEN 'N' ELSE t2.qtysaleyn END qtysaleyn
                    , t2.soldoutyn
                    , t2.thedaysyn
               FROM od_cart t
                 JOIN gd_master t2
                   ON t2.gdcd = t.gdcd
                 LEFT JOIN od_reservegoods t4
                        ON t4.gdcd = t.gdcd
                       AND t4.useyn = 'Y'
                       <![CDATA[
                       AND t4.od_from <= CONVERT(CHAR(10), GETDATE(), 121)
                       AND t4.od_to >= CONVERT(CHAR(10), GETDATE(), 121)
                       ]]>
                 LEFT JOIN gd_cnt t5
                        ON t5.gdcd = t.gdcd
                 LEFT JOIN gd_pack t6
                        ON t6.gdcd = t2.gdcd
                WHERE t.memcd = #{strLoginMemCd} 
             ) x 
       ORDER BY odtype, thedaysyn DESC, crtidx 
    </select>
</mapper>