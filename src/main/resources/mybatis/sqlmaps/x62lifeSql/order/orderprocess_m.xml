<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="orderprocess">
<!--    'System        : m.62life.com
    'Program       :
    'Title         : 자연이랑모바일 - 주문결제 처리
    'File          : orderprocess_m.asp
    'Program Type  : asp
    'Analyst       :
    'Author        : hwkim
    'Date Started  : 20130717
    'Last Modified :
    'Called By     :
    'Parameters    :
    'Purpose       :
    'Version       :
    '
    'Modified   Author  V/M     Reason For Modification

    '20130717   hwkim   0.9     처음 작성
    '20131001   sykim    -      현금영수증 발행용도, "0":소득공제용, "1":지출증빙용,
    '                           g_rcp_type 추가.
    '20140610   sykim   -       메일 및 SMS 무조건 발송으로 변경.
    '20170406   hwkim   0.9.1   보내는사람 정보 변경 기능 추가
    '20170515   sykim   0.9.2   당일출고 및 배송비 관련부분 변경.
    '20180214   hyeok   -&#45;&#45;     SMS > 알림톡 변경 적용 (lib.database.asp 필수)
    '20190610   sykim   0.9.3   고객사혜택(지원금, SK포인트, 급여공제, 건설의 복리후생포인트) 제한기능 추가.(T건강걷기 서비스시작)
    '20190830   sykim   -       tvos 공급가합 추가.
    '20200313   sykim   0.9.4   공급자별 배송비 정책 추가.
    '20200917   hwkim   0.9.5   특별 추가증정이벤트 코드 추가 (동일/유사 이벤트 시 코드 변경으로 이용 가능)-->
    <select id="getSumEventProd">
        SELECT ISNULL(SUM(og.oprice),0) applysum 
         FROM od_pay p 
           JOIN od_goods og
             ON og.paynum=p.paynum
          WHERE p.paystcd =#{paystPay}
            AND p.paynum = #{realPayNum}
            AND p.memcd = #{strLoginMemCd}
            AND og.gdcd IN (SELECT l.slgdcd
                            FROM specialsellingh h
                              JOIN specialsellingl l
                                ON h.shidx = l.slidx
                             WHERE h.shidx = #{ex_slidx}
                                AND GETDATE() BETWEEN h.shstartdt AND h.shenddt)
            <![CDATA[
            AND ISNULL((SELECT gdcnt FROM gd_cnt WHERE gdcd = #{ex_gdcd}),0) > 0  /*'증정품의 재고량이 설정되고 1이상일 경우만.*/
            ]]>
    </select>
    
    <select id="checkGiftProdFromOrderNum">
        SELECT TOP 1 ordnum 
        FROM od_header oh 
         WHERE oh.paystcd = #{paystPay}
           AND oh.paynum = #{realPayNum}
           AND oh.odgubun IN ('02','11')
           AND NOT EXISTS (SELECT gdcd
                           FROM od_goods ol
                            WHERE ol.paynum = oh.paynum
                              AND ol.ordnum = oh.ordnum
                              AND ol.gdcd=#{ex_gdcd}
                          )
        ORDER BY oh.odgubun DESC
    </select>
    
    <insert id="insertOrder">
        INSERT INTO od_goods (
                               paynum
                             , ordnum
                             , gdcd
                             , gdname
                             , price
                             , point
                             , gdcnt
                             , indt
                             , tax
                             , vat
                             , vos
                             , sprice
                             , oprice
                            ) 
        SELECT #{realPayNum}
             , #{applyOrderNumber}
             , gdcd
             , gdname
             , 0
             , 0
             , 1
             , GETDATE()
             , 0
             , 0
             , 0
             , 0
             , 0
        FROM gd_master
         WHERE gdcd = #{ex_gdcd}
    </insert>

    <update id="updateGoodsCnt">
        UPDATE gd_cnt 
          SET gdcnt = gdcnt - 1 
           WHERE gdcd = #{ex_gdcd}
    </update>
</mapper>