<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="gimjang">
    <select id="gimjangHeader">
       /*gimjangHeader 김장 기획전 헤더 */
        SELECT *
        FROM specialsellingh
        WHERE shidx = #{sidx}
          <![CDATA[
          AND shstartdt <= GETDATE()
          AND shenddt > GETDATE()
          ]]>
    </select>
    <select id="gimjangEventCategory">
        /*gimjangEventCategory 김장 기획전 카테고리 */
        SELECT x.slcat cdcode
             , COUNT(x.slcat) CNT
        FROM specialsellingl x
          JOIN gd_master g ON x.slgdcd = g.gdcd
          LEFT JOIN od_reservegoods r ON x.slgdcd = r.gdcd AND g.useyn = 'N'
         WHERE x.slidx = #{sidx}
           <![CDATA[
           AND (g.useyn = 'Y' OR (g.useyn = 'N' AND r.useyn = 'Y'
                                                AND GETDATE() >= CONVERT(DATETIME, od_from, 21)
                                                AND GETDATE() < CONVERT(DATETIME, od_to, 21) + 1
                                 )
               )
           ]]>
         <if test="listingMode == 'OPT'">
             AND ISNULL(g.optionp,'N') = 'N'
         </if>
        GROUP BY x.slcat
        ORDER BY x.slcat
    </select>

    <select id="gimjangEventTopTen">
        /*gimjangEventTopTen 김장 기획전 top 10*/
        SELECT TOP 10 shidx
             , shtitle
             , grpcd
        FROM specialsellingh
         WHERE 1 = 1
           AND shrtype = #{shrtype}
           <![CDATA[
           AND shstartdt <= GETDATE()
           AND shenddt >= GETDATE()
           ]]>
         <choose>
             <when test="rsshlevel == '1'">
                 AND shlevel = #{rsshlevel}
             </when>
             <otherwise>
                 AND shlevel = #{rsshlevel}
                 AND shrelidx = #{rsshrelidx}
             </otherwise>
         </choose>
        <![CDATA[
          AND ISNULL(shhideyn, 'N') <> 'Y'
        ]]>
        ORDER BY ISNULL(grpcd,''), shidx DESC
    </select>

    <select id="gimjangEventProdInfo">
        /*gimjangEventProdInfo 김장 이벤트 상품 정보*/
        SELECT * FROM (
                          SELECT '11' odtype
                               , a.gdcd
                               , a.gdname
                               , a.unit
                               , a.price1
                               , a.gdimg
                               , a.mgdimg1
                               , a.divcd
                               , a.div1
                               , a.indt
                               , a.updt
                               , a.shortdesc
                               , ISNULL(z.gdcnt,99999) gdcnt
                               , CASE WHEN ISNULL(a.soldoutyn,'N')='N'  THEN 'N' ELSE a.soldoutyn END soldoutyn
                               , CASE WHEN ISNULL(a.deliverydtyn,'')='' THEN 'N' ELSE a.deliverydtyn END deliverydtyn
                               , ISNULL(a.newyn,'N') newyn
                               , ISNULL(a.qtysaleyn,'N') qtysaleyn
                               , ISNULL(a.recommendyn,'N') recommendyn
                               , dbo.getMasterPrice(a.gdcd) saleprice
                               , dbo.getProductPrice( #{strMEMGRPCD} , #{strGroupSalePolicy}, a.gdcd) groupsaleprice
                               , c.cdcode
                               , c.cdname
                               , a.priceyn
                               , i.origin
                               , i.producer
                               , i.address
                               , ISNULL(t.cdname,'미지정') AS gradedesc
                               , '' od_from
                               , '' od_to
                               , '' dlv_from
                               , '' dlv_to
                               , a.thedaysyn
                               , x.slcat
                               , '' odtype2
                          FROM gd_master a
                            JOIN cd_master c ON c.cdtype = '20' AND c.cdcode = a.div1
                            JOIN specialsellingl x ON x.slgdcd = a.gdcd
                            LEFT JOIN gd_cnt z ON z.gdcd = a.gdcd
                            LEFT JOIN gd_item i ON i.gdcd = a.gdcd
                            LEFT JOIN cd_master t ON t.cdtype = '09' AND t.cdcode = i.typecd
                           WHERE 1 = 1
                             AND a.useyn = 'Y'
                             AND a.divcd IN ('30','20')
                             AND x.slidx = #{sidx}
                          <if test="div1 != ''">
                              <choose>
                                  <when test="rsIsud == 'N'">
                                      AND a.div1 = #{div1}
                                  </when>
                                  <otherwise>
                                      AND x.slcat = #{div1}
                                  </otherwise>
                              </choose>
                          </if>
                          <if test="listingMode == 'OPT'">
                              AND ISNULL(a.optionp,'N') = 'N'
                          </if>
                          UNION ALL
                          SELECT '12' odtype
                               , r.gdcd
                               , r.gdnm gdname
                               , r.unit
                               , m.price1
                               , m.gdimg
                               , m.mgdimg1
                               , r.divcd
                               , r.divcd1 div1
                               , r.indt
                               , r.updt
                               , m.shortdesc
                               , ISNULL(gc.gdcnt,99999) gdcnt
                               , CASE WHEN ISNULL(soldoutyn,'N')='N' THEN 'N' ELSE soldoutyn END soldoutyn
                               , CASE WHEN ISNULL(m.deliverydtyn,'')='' THEN 'N' ELSE m.deliverydtyn END deliverydtyn
                               , ISNULL(m.newyn,'N') newyn, 'N' qtysaleyn, 'N' recommendyn
                               , dbo.getMasterPrice(r.gdcd) saleprice
                               , dbo.getProductPrice(#{strMEMGRPCD}, #{strGroupSalePolicy}, r.gdcd) saleprice
                               , c.cdcode
                               , c.cdname
                               , 'Y' AS priceyn
                               , i.origin
                               , i.producer
                               , i.address
                               , ISNULL(t.cdname,'미지정') AS gradedesc
                               , r.od_from
                               , r.od_to
                               , r.dlv_from
                               , r.dlv_to
                               , m.thedaysyn
                               , x.slcat
                               , r.type odtype2
                          FROM od_reservegoods r
                            JOIN gd_master m ON r.gdcd = m.gdcd
                            JOIN cd_master c ON c.cdtype = '20' AND c.cdcode = m.div1
                            JOIN specialsellingl x ON x.slgdcd = r.gdcd
                            LEFT JOIN gd_item i ON i.gdcd = r.gdcd
                            LEFT JOIN cd_master t ON t.cdtype = '09' AND t.cdcode = i.typecd
                            LEFT JOIN gd_cnt gc ON gc.gdcd = r.gdcd
                           WHERE 1 = 1
                             AND r.useyn = 'Y'
                             <![CDATA[
                             AND r.od_from <= CONVERT(VARCHAR,GETDATE(),23) AND r.od_to >= CONVERT(VARCHAR,GETDATE(),23)
                             ]]>
                             AND x.slidx = #{sidx}
                            <if test="div1 != ''">
                                <choose>
                                    <when test="rsIsud == 'N'">
                                        AND a.div1 = #{div1}
                                    </when>
                                    <otherwise>
                                        AND x.slcat = #{div1}
                                    </otherwise>
                                </choose>
                            </if>
                            <if test="listingMode == 'OPT'">
                                AND ISNULL(a.optionp,'N') = 'N'
                            </if>
                    ) AS x
               <if test="orderBy == ''">
                   <![CDATA[
                   LEFT JOIN (SELECT gdcd bgdcd, SUM(gdcnt) bestcnt FROM od_goods WHERE indt >= CONVERT(DATETIME, '" & DATE - 1 & "', 21) GROUP BY gdcd) b ON x.gdcd = b.bgdcd
                    ]]>
               </if>
        WHERE 1 = 1
        <if test="shltoty != ''">
            AND x.odtype = #{shltoty}
        </if>
        <choose>
            <when test="rsIsud == 'Y'">
                ORDER BY x.slcat
            </when>
            <otherwise>
                ORDER BY cdcode
            </otherwise>
        </choose>
        <choose>
            <when test="orderBy == 'PD'">
                , x.saleprice DESC
            </when>
            <when test="orderBy == 'PU'">
                , x.saleprice
            </when>
            <when test="orderBy == 'PN'">
                , x.indt DESC
            </when>
            <otherwise>
                , b.bestcnt DESC, x.gdcd
            </otherwise>
        </choose>
    </select>
</mapper>