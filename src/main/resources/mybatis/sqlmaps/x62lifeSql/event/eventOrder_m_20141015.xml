<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="evnetOrder">
<!--    'System        : 62life.com
    'Program       :
    'Title         : 이벤트 페이지 - 휴면고객 활성화 사은품 선택정보 저장
    'File          : event_order2_20141015.asp
    'Program Type  : asp
    'Analyst       :
    'Author        : hwkim
    'Date Started  : 20141013
    'Last Modified :
    'Called By     :
    'Parameters    :
    'Purpose       :
    'Version       :
    '
    'Modified   Author  V/M     Reason For Modification-->

    <select id="checkOrder">
      SELECT ordered
      FROM temp_dormant_20141015
	   WHERE 1=1
	     AND ordered = 'N'
	     AND memcd = #{strLoginMemCd}
    </select>
    
    <select id="checkPayment">
        SELECT MAX(p.prepaynum) paynum
             , MAX(h.ordnum) ordnum
		FROM od_header h
		  JOIN od_pay p
		    ON p.paynum = h.paynum
		   AND p.paystcd = '10'
		   <![CDATA[
		   AND p.fixdt >= '2014-10-15'
		   ]]>
		   AND p.memcd = #{strLoginMemCd}
    </select>
    
    <select id="checkPaymentExistOrder">
         SELECT p.prepaynum paynum
              , h.ordnum 
         FROM od_header h 
		   JOIN od_pay p 
		     ON p.paynum = h.paynum 
		    AND p.paystcd = '10'
		    <![CDATA[
		    AND p.fixdt >= '2014-10-15'
		    ]]>
		    AND p.memcd = #{strLoginMemCd} 
		 WHERE p.prepaynum = #{paynum}
    </select>

    <insert id="saveEventGiftHistoryHeader">
        INSERT INTO present_header(
                                    paynum
                                  , ordnum
                                  , memcd
                                  , updt
                                  , usid
                                  , sendyn
                                  , note
                                  ) 
               VALUES(
                       #{paynum}
                     , #{ordnum}
                     , #{strLoginMemCd}
                     , getdate()
                     , #{strLoginMemCd}
                     , 'N'
                     , #{note}
                     )
    </insert>

    <insert id="saveEventGiftHistoryLine">
        INSERT INTO present_line(
                                  paynum
                                , gdcd
                                ,gdcnt
                                ) 
               VALUES(
                       #{paynum}
                     , #{dormantproduct}
                     , 1
                     )
    </insert>
    
    <update id="updateDormantInfo">
        UPDATE temp_dormant_20141015 
           SET ordered = 'Y' 
		 WHERE memcd = #{strLoginMemCd}
    </update>
</mapper>