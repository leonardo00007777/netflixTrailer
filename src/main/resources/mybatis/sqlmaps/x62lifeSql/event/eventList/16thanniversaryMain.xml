<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="16thanniversaryMain">
<!--    'System        : m.62life.com
    'Program       :
    'Title         : 자연이랑 고객이랑 16주년 이벤트(모바일)
    'File          : 16thanniversary_main_m.asp
    'Program Type  : asp
    'Analyst       :
    'Author        : chhyeon
    'Date Started  : 20200406
    'Last Modified :
    'Called By     :
    'Parameters    :
    'Purpose       :
    'Version       :
    '
    'Modified   Author    V/M     Reason For Modification

    '20200406   chhyeon   0.9     초안작성-->
    <select id="defaultCategory">
       /* defaultCategory 기본 카테고리*/
       SELECT c.cat1
            , c.catdesc
            , COUNT(x.slgdcd) CNT
       FROM specialsellingl x
         JOIN gd_master g
           ON x.slgdcd = g.gdcd
         JOIN exmenu c
           ON g.exdiv1 = c.cat1
         LEFT JOIN od_reservegoods r
                ON g.gdcd = r.gdcd
               AND r.useyn = 'Y'
              AND CONVERT(VARCHAR,GETDATE(),23) BETWEEN r.od_from AND r.od_to
        WHERE x.slidx = #{sidx}
          AND g.useyn = 'Y'
          AND (g.reserveyn = 'N' OR (g.reserveyn = 'Y' AND r.gdcd IS NOT NULL))
          <if test="listingMode == 'OPT'">
              AND ISNULL(g.optionp,'N') = 'N'
          </if>
       GROUP BY c.cat1, c.catdesc
       ORDER BY cat1
    </select>
    
    <select id="userCategory">
        /*userCategory 사용자 정의 카테고리*/
        SELECT x.slcat cdcode
             , COUNT(x.slcat) CNT
        FROM specialsellingl x
          JOIN gd_master g
            ON x.slgdcd = g.gdcd
          LEFT JOIN od_reservegoods r
                 ON g.gdcd = r.gdcd
                AND r.useyn = 'Y'
                AND CONVERT(VARCHAR,GETDATE(),23) BETWEEN r.od_from AND r.od_to
         WHERE x.slidx = #{sidx}
           AND g.useyn = 'Y'
           AND (g.reserveyn = 'N' OR (g.reserveyn = 'Y' AND r.gdcd IS NOT NULL))
          <if test="listingMode == 'OPT'">
              AND ISNULL(g.optionp,'N') = 'N'
          </if>
        GROUP BY x.slcat
        ORDER BY x.slcat 
    </select>
    
    <select id="specialSellingDetail">
        /* specialSellingDetail 기획전 상세*/
        SELECT * FROM (
                        SELECT a.gdcd
                             , a.gdname
                             , a.unit
                             , a.price1
                             , a.gdimg
                             , a.divcd
                             , a.div1
                             , a.exdiv1
                             , a.indt
                             , a.updt
                             , a.shortdesc
                             , ISNULL(z.gdcnt,99999) stock_num
                             , ISNULL(a.soldoutyn,'N') soldoutyn
                             , ISNULL(a.newyn,'N') newyn
                             , ISNULL(a.qtysaleyn,'N') qtysaleyn
                             , CASE a.dispatchtype WHEN 'I' THEN '11'
                                                   WHEN 'O' THEN '15'
                               END odtype
                             , ISNULL(a.deliverydtyn,'N') deliverydtyn
                             , ISNULL(a.reserveyn,'N') reserveyn
                             <choose>
                                <when test="strMEMGRPCD != '' and strGroupSalePolicy != 'N'">
                                    , dbo.getProductPrice(#{strMEMGRPCD}, #{strGroupSalePolicy}, g.gdcd) groupsaleprice
                                </when>
                                <otherwise>
                                    , dbo.getMasterPrice(a.gdcd) saleprice
                                </otherwise>
                             </choose>
                             , c.catdesc cdname
                             , x.slcat
                             , x.slnote
                             , a.plandate
                             , a.thedaysyn
                             , ISNULL(t6.cdname,'미지정') AS gradedesc
                             , '-' alltimesale
                             , a.priceyn
                             , a.mgdimg1
                             , t6.cdcode
                        FROM gd_master a
                          JOIN exmenu c
                            ON a.exdiv1 = c.cat1
                          JOIN specialsellingl x
                            ON x.slgdcd = a.gdcd
                          LEFT JOIN gd_cnt z
                                 ON z.gdcd = a.gdcd
                          LEFT JOIN gd_item i
                                 ON i.gdcd = a.gdcd
                          LEFT JOIN cd_master t6
                                 ON t6.cdtype = '09'
                                AND t6.cdcode = i.typecd
                          LEFT JOIN od_reservegoods r
                                 ON a.gdcd = r.gdcd
                                AND r.useyn = 'Y'
                                <![CDATA[
                                AND DATEDIFF(D,CONVERT(DATETIME,r.od_from,120),GETDATE()) >= 0
                                AND DATEDIFF(D,GETDATE(),CONVERT(DATETIME,r.od_to,120)) >= 0
                                ]]>
                         WHERE 1 = 1
                           AND a.useyn = 'Y'
                           AND (a.reserveyn = 'N' OR (a.reserveyn = 'Y' AND r.gdcd IS NOT NULL))
                           AND a.divcd IN ('30','20')
                           AND x.slidx = #{sidx}
                           <if test="extList != '' ">
                               AND a.gdcd NOT IN (#{extList})
                           </if>
                          <if test="div1 != '' ">
                              <choose>
                                 <when test="rsIsud == 'N'">
                                       AND a.div1 = #{div1}
                                 </when>
                                 <otherwise>
                                       AND x.slcat = #{div1}
                                 </otherwise>
                              </choose>
                          </if>
                          <if test="listingMode == 'OPT'">
                              AND ISNULL(a.optionp,'N') = 'N'
                          </if>
                  ) x
                 <if test='orderBy == ""'>
                     LEFT JOIN (SELECT gdcd bgdcd
                                     , SUM(gdcnt) bestcnt
                                FROM od_goods
                                 <![CDATA[
                                 WHERE indt >= CONVERT(DATETIME, #{DATE} - 1 , 21)
                                 ]]>
                                GROUP BY gdcd
                               ) b
                            ON x.gdcd = b.bgdcd
                 </if>
                 WHERE 1 = 1
                 <choose>
                    <when test="shltoty == '12'">
                          AND x.reserveyn = 'Y'
                    </when>
                    <when test="shltoty == '11'">
                          AND x.reserveyn = 'N'
                    </when>
                 </choose>
        <choose>
            <when test="rsIsud == 'N'">
                ORDER BY x.slcat
            </when>
            <otherwise>
                ORDER BY x.exdiv1
            </otherwise>
        </choose>
        <choose>
            <when test='orderBy == "PD"'>
                , x.saleprice DESC
            </when>
            <when test='orderBy == "PU"'>
                , x.saleprice
            </when>
            <when test='orderBy == "PP"'>
                , x.saleprice/price1, x.gdcd
            </when>
            <when test='orderBy == "PN"'>
                , x.gdname
            </when>
            <when test='orderBy == ""'>
                , b.bestcnt DESC
            </when>
            <otherwise>
                , x.gdcd
            </otherwise>
        </choose>
    </select>
</mapper>