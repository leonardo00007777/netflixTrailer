<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="immunity">
<!--    'System        : m.62life.com
    'Program       :
    'Title         : 2020년 면역력 증진 기획전
    'File          : immunity_main_m.asp
    'Program Type  : asp
    'Analyst       :
    'Author        : hnjang
    'Date Started  : 20200915
    'Last Modified :
    'Called By     :
    'Parameters    :
    'Purpose       :
    'Version       :
    '
    'Modified   Author  V/M     Reason For Modification
    
    '20200915   hnjang   0.9     초안작성-->
   <select id="specialSellingHeader">
       SELECT * 
       FROM specialsellingh 
        WHERE shidx = #{sidx} 
   </select>

    <select id="specialSellingDefaultCategory">
        /* specialSellingCatgory 상단 카테고리 메뉴(기본카테고리) */
        SELECT c.cat1
        , c.catdesc
        , COUNT(x.slgdcd) CNT
        FROM specialsellingl x
        JOIN gd_master g
        ON x.slgdcd = g.gdcd
        JOIN exmenu c
        ON g.exdiv1 = c.cat1
        LEFT JOIN od_reservegoods r
        ON g.gdcd = r.gdcd
        AND r.useyn = 'Y'
        <![CDATA[
               AND CONVERT(VARCHAR,GETDATE(),23) BETWEEN r.od_from AND r.od_to
               AND DATEDIFF(D,CONVERT(DATETIME,r.od_from,120),GETDATE()) >= 0
               AND DATEDIFF(D,GETDATE(),CONVERT(DATETIME,r.od_to,120)) >= 0
               ]]>
        WHERE x.slidx = #{sidx}
        AND g.useyn = 'Y'
        AND (g.reserveyn = 'N' OR (g.reserveyn = 'Y' AND r.gdcd IS NOT NULL))
        <if test="listingMode == 'OPT'">
            AND ISNULL(g.optionp,'N') = 'N'
        </if>
        GROUP BY c.cat1, c.catdesc
        ORDER BY cat1
    </select>

    <select id="specialSellingUserCategory">
        /*specialSellingUserCategory 사용자 정의 카테고리일 경우*/
        SELECT x.slcat cdcode
        , COUNT(x.slcat) CNT
        FROM specialsellingl x
        JOIN gd_master g
        ON x.slgdcd = g.gdcd
        LEFT JOIN od_reservegoods r
        ON g.gdcd = r.gdcd
        AND r.useyn = 'Y'
        AND CONVERT(VARCHAR,GETDATE(),23) BETWEEN r.od_from AND r.od_to
        <![CDATA[
                AND DATEDIFF(D,CONVERT(DATETIME,r.od_from,120),GETDATE()) >= 0
                AND DATEDIFF(D,GETDATE(),CONVERT(DATETIME,r.od_to,120)) >= 0
        ]]>
        WHERE x.slidx = #{sidx}
        AND g.useyn = 'Y'
        AND (g.reserveyn = 'N' OR (g.reserveyn = 'Y' AND r.gdcd IS NOT NULL))
        <if test="listingMode == 'OPT'">
            AND ISNULL(g.optionp,'N') = 'N'
        </if>
        GROUP BY x.slcat
        ORDER BY x.slcat
        <choose>
            <when test="orderBy == 'PD">
                , x.saleprice DESC
            </when>
            <when test="orderBy == 'PU'">
                , x.saleprice
            </when>
            <when test="orderBy == 'PN'">
                ,  x.indt DESC
            </when>
            <otherwise>
                , b.bestcnt DESC, x.gdcd
            </otherwise>
        </choose>
    </select>
    
    <select id="specialSellingTopCheck">
        SELECT * 
           FROM (
                  SELECT a.gdcd
                       , a.gdname
                       , a.unit
                       , a.price1
                       , a.gdimg
                       , a.mgdimg1
                       , a.divcd
                       , a.div1
                       , a.indt
                       , a.updt
                       , a.shortdesc
                       , ISNULL(z.gdcnt,99999) gdcnt
                       , ISNULL(a.soldoutyn,'N') soldoutyn
                       , ISNULL(a.newyn,'N') newyn, ISNULL(a.qtysaleyn,'N') qtysaleyn
                       , dbo.getMasterPrice(a.gdcd) saleprice
                       , a.thedaysyn
                       , a.priceyn
                       , a.exdiv1
                       , i.origin
                       , i.producer
                       , i.address
                       , ISNULL(t.cdname,'미지정') AS gradedesc
                       , CASE a.dispatchtype WHEN 'I' THEN '11'
                                             WHEN 'O' THEN '15'
                         END odtype
                       , ISNULL(a.deliverydtyn,'N') deliverydtyn
                       , ISNULL(a.reserveyn,'N') reserveyn
                  FROM gd_master a
                    JOIN specialsellingl x
                      ON x.slgdcd = a.gdcd
                    LEFT JOIN gd_cnt z
                           ON z.gdcd = a.gdcd
                    LEFT JOIN gd_item i
                           ON i.gdcd = a.gdcd
                    LEFT JOIN cd_master t
                           ON t.cdtype = '09'
                          AND t.cdcode = i.typecd
                    LEFT JOIN od_reservegoods r
                           ON a.gdcd = r.gdcd
                          AND r.useyn = 'Y'
                          AND CONVERT(VARCHAR,GETDATE(),23) BETWEEN r.od_from AND r.od_to
                   WHERE 1 = 1
                     AND a.useyn = 'Y'
                     AND a.divcd IN ('30','20')
                     AND x.slidx = #{sidx}
                     AND x.sltop = 'Y'
                     AND (a.reserveyn = 'N' OR (a.reserveyn = 'Y' AND r.gdcd IS NOT NULL))
                   <choose>
                      <when test="shltoty == '12'">
                          AND a.reserveyn = 'Y'
                      </when>
                      <when test="shltoty == '11'">
                          AND a.reserveyn = 'N'
                          AND ISNULL(a.thedaysyn,'N') = 'N'
                          AND ISNULL(a.dispatchtype,'I') = 'I'
                      </when>
                      <when test="shltoty == '15'">
                          AND ISNULL(a.dispatchtype,'I') = 'O'
                      </when>
                   </choose>
                   <if test='listingMode == "OPT" '>
                       AND ISNULL(a.optionp,'N') = 'N'
                   </if>
                 ) x
           WHERE 1 = 1
        ORDER BY gdcd
    </select>
    
    <select id="specialSellingPaging">
         /* specialSellingPaging 기획전 포함 상품 총 페이지 수*/
        SELECT CEILING( CAST(COUNT(1) AS FLOAT)/ #{intPagePerItem}) MAXPAGE
             , COUNT(gdcd) CNT
        FROM (
               SELECT '11' odtype
                    , a.gdcd
               FROM gd_master a
                 JOIN specialsellingl x
                   ON x.slgdcd = a.gdcd
                 LEFT JOIN od_reservegoods r
                        ON a.gdcd = r.gdcd
                       AND r.useyn = 'Y'
                       AND CONVERT(VARCHAR,GETDATE(),23) BETWEEN r.od_from AND r.od_to
                WHERE 1 = 1
                  AND a.useyn = 'Y'
                  AND (a.reserveyn = 'N' OR (a.reserveyn = 'Y' AND r.gdcd IS NOT NULL))
                  AND a.divcd IN ('30','20')
                  AND x.slidx = #{sidx}
                <if test="div1 != null and div1 != ''">
                    <choose>
                        <when test="rsIsud == 'N'">
                            AND a.exdiv1 = #{div1}
                        </when>
                        <otherwise>
                            AND x.slcat =  #{div1}
                        </otherwise>
                    </choose>
                </if>
                <choose>
                   <when test="shltoty == '12'">
                       AND a.reserveyn = 'Y'
                   </when>
                   <when test="shltoty == '11'">
                       AND a.reserveyn = 'N'
                   </when>
                </choose>
                <if test='listingMode == "OPT" '>
                       AND ISNULL(a.optionp,'N') = 'N'
                </if>
             ) x
        WHERE 1 = 1
    </select>
    <select id="2019ProdList">
        /* specialSellingProdList 20190813 *임시코드* 2019추석 관련 기획전 별도 처리*/
        SELECT *
        FROM (
               SELECT FLOOR( (ROW_NUMBER() OVER ( #{strListOrderBy}) - 1 ) /  #{intPagePerItem} + 1) AS PAGE
                    , x.*
               FROM (
                      SELECT a.gdcd
                           , a.gdname
                           , a.unit
                           , a.price1
                           , a.gdimg
                           , a.mgdimg1
                           , a.divcd
                           , a.div1
                           , a.indt
                           , a.updt
                           , a.shortdesc
                           , ISNULL(z.gdcnt,99999) gdcnt
                           , ISNULL(a.soldoutyn,'N') soldoutyn
                           , ISNULL(a.newyn,'N') newyn
                           , ISNULL(a.qtysaleyn,'N') qtysaleyn
                           , ISNULL(a.recommendyn,'N') recommendyn
                           , dbo.getMasterPrice(a.gdcd) saleprice
                           , a.priceyn
                           , a.exdiv1
                           , e.catdesc
                           , i.origin
                           , i.producer
                           , i.address
                           , ISNULL(t.cdname,'미지정') AS gradedesc
                           , ISNULL(r.od_from,'') od_from
                           , ISNULL(r.od_to,'') od_to
                           , ISNULL(r.dlv_from,'') dlv_from
                           , ISNULL(r.dlv_to,'') dlv_to
                           , a.thedaysyn
                           , x.slcat
                           , CASE a.dispatchtype WHEN 'I' THEN '11'
                                                 WHEN 'O' THEN '15'
                             END odtype
                           , ISNULL(a.deliverydtyn,'N') deliverydtyn
                           , ISNULL(a.reserveyn,'N') reserveyn
                      FROM gd_master a
                        JOIN specialsellingl x
                          ON x.slgdcd = a.gdcd
                        LEFT JOIN od_reservegoods r
                               ON a.gdcd = r.gdcd
                              AND r.useyn = 'Y'
                              AND CONVERT(VARCHAR,GETDATE(),23) BETWEEN r.od_from AND r.od_to
                        LEFT JOIN gd_cnt z
                               ON z.gdcd = a.gdcd
                        LEFT JOIN gd_item i
                               ON i.gdcd = a.gdcd
                        LEFT JOIN cd_master t
                               ON t.cdtype = '09'
                              AND t.cdcode = i.typecd
                        LEFT JOIN exmenu e
                               ON a.exdiv1 = e.cat1
                       WHERE 1 = 1
                         AND a.useyn = 'Y'
                         AND (a.reserveyn = 'N'
                              OR (a.reserveyn = 'Y' AND r.gdcd IS NOT NULL))
                         AND a.divcd IN ('30','20')
                         AND x.slidx = #{sidx}
                       <if test="div1 != null and div1 != ''">
                           <choose>
                              <when test="rsIsud == 'N'">
                                  AND a.exdiv1 = #{div1}
                              </when>
                              <otherwise>
                                  AND x.slcat =  #{div1}
                              </otherwise>
                           </choose>
                       </if>
                       <if test='listingMode == "OPT" '>
                          AND ISNULL(a.optionp,'N') = 'N'
                       </if>
                    ) AS x
         <if test='orderBy == ""'>
            LEFT JOIN (SELECT gdcd bgdcd
                            , SUM(gdcnt) bestcnt
                       FROM od_goods
                         <![CDATA[
                         WHERE indt >= CONVERT(DATETIME, #{DATE} - 1 , 21)
                         ]]>
                       GROUP BY gdcd
                      ) b
                    ON x.gdcd = b.bgdcd
         </if>
         WHERE 1 = 1
        <choose>
            <when test="shltoty == '12'">
                AND x.reserveyn = 'Y'
            </when>
            <when test="shltoty == '11'">
                AND x.reserveyn = 'N'
            </when>
        </choose>
        ) AS pl
        WHERE PAGE = #{intPage}
    </select>
</mapper>