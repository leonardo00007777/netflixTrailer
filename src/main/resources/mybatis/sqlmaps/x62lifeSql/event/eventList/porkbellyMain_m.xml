<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="porkbelly">
<!--    'System        : m.62life.com
    'Program       :
    'Title         : 4월 특별 할인 이벤트 - 무항상제 냉장 삼겹살
    'File          : porkbelly_main_m.asp
    'Program Type  : asp
    'Analyst       :
    'Author        : chhyeon
    'Date Started  : 20200414
    'Last Modified :
    'Called By     :
    'Parameters    :
    'Purpose       :
    'Version       :
    '
    'Modified   Author  V/M     Reason For Modification

    '20200414   chhyeon   0.9     처음작성-->
    <select id="getGdCnt">
        /* getGdCnt 상품 Cnt*/
        SELECT ISNULL(c.gdcnt, 99999) gdcnt
             , g.useyn
        FROM gd_master g
                 LEFT JOIN gd_cnt c
                           ON g.gdcd = c.gdcd
        WHERE g.gdcd = #{strEventItemCode}
    </select>
    
    <select id="checkAlreadyCart">
        /* checkAlreadyCart 장바구니 검사*/
        SELECT SUM(cnt) cnt 
        FROM ( 
                SELECT COUNT(1) cnt 
                FROM shopping_basket 
                 WHERE 1=1 
                   AND memcd = #{strLoginMemCD} 
                   AND gdcd = #{strEventItemCode} 
                UNION ALL 
                SELECT COUNT(1) cnt 
                FROM od_pay p 
                  JOIN od_goods g 
                    ON p.paynum = g.paynum 
                 WHERE 1=1 
                   AND p.paystcd = '10'
                   <![CDATA[
                   AND P.paydt >= CONVERT(DATETIME, #{strEventStartDt}, 21) 
                   AND p.memcd = #{strLoginMemCD} 
                   AND g.gdcd = #{strEventItemCode}
                   ]]>
           ) a 
    </select>

    <select id="checkStockRemain">
        /* checkStockRemain 재고부족 검사*/
        SELECT ISNULL(c.gdcnt, 99999) gdcnt
        FROM gd_master gm
                 LEFT JOIN gd_cnt c
                           ON gm.gdcd = c.gdcd
        WHERE 1=1
          AND gm.gdcd = #{strEventItemCode}
          AND gm.useyn = 'Y'
    </select>

    <select id="checkBasketEventItem">
        SELECT COUNT(1) cnt
        FROM shopping_basket
        WHERE memcd = #{strLoginMemCD}
          AND gdcd = #{strEventItemCode}
    </select>

    <insert id="addEventItem">
        /* addEventItem 장바구니 담기 처리*/
        INSERT INTO shopping_basket (
                                      memcd
                                    , crtidx
                                    , gdcd
                                    , gdcnt
                                    , indt
                                    , od_gubun
        )
        SELECT #{strLoginMemCD}
             , ISNULL(MAX(CRTIDX),0)+1
             , #{strEventItemCode}
             , '1'
             , GETDATE()
             , '11'
        FROM shopping_basket
        WHERE memcd = #{strLoginMemCD}
    </insert>

    <update id="updateEventItem">
        /*updateEventItem 장바구니 업데이트*/
        UPDATE shopping_basket
        SET gdcnt = gdcnt + 1
        WHERE memcd = #{strLoginMemCD}
          AND gdcd = #{strEventItemCode}
    </update>
</mapper>