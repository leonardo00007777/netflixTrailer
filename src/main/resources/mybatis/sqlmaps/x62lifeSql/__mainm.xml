<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="notusemainm">
<!--    'System        : 62life.com
    'Program       :
    'Title         : 자연이랑 모바일 첫 페이지
    'File          : mainm.asp
    'Program Type  : asp
    'Analyst       :
    'Author        : hwkim
    'Date Started  : 20161107
    'Last Modified :
    'Called By     :
    'Parameters    :
    'Purpose       :
    'Version       :
    '
    'Modified   Author  V/M     Reason For Modification
    
    '20161107   hwkim   0.9     처음 작성
    '20161227   hwkim   0.9.1   처음 표시 방식 개선 - 동시 백그라운드 로딩 처리
    '20161229   hwkim   0.9.2   카테고리 버튼 디자인 변경
    '20170106   hwkim   0.9.3   (자연이랑)소식 정보 탭 추가 - 확대
    '20170202   hwkim   0.9.4   업체 직배송 상품 처리 추가.
    '20170209   hwkim   0.9.5   자동로그인 기능 개선
    '20170303   hwkim   0.9.6   첫 화면 로딩 속도 향상 처리 / 이전, 다음 탭의 정보만 미리 로딩
    '20170331   hwkim   0.9.7   바로 가기 아이콘 디자인 변경 v20170331
    '20170614   hwkim   0.9.8   제한된 시간에 따라 당일발송 배너를 표시
    '20171012   hwkim   0.9.9   품절 및 일시판매중지 상품, 표시 제외
    '20171208   hwkim   -       FCM 토큰, 아이디 매칭을 위한 함수 추가.
    '20180114   hwkim   1.0     상품표시 레이아웃 개선. 모바일용 세로비율 그림 적용
    '20180227   hwkim   1.0.1   첫 화면 그리드 표시 방식으로 변경, swiper 리팩토링
    '20180423   hwkim   -       freewall 첫화면 지연 표시 개선
    '20180524   hwkim   1.0.2   티커 부분 제거, 레시피 배너 제거 및 레시피 고정 아이콘 추가
    '20180621   hyeok   -       세트유형(20)상품 추천,할인상품, 신상품 목록에 표시 조건 추가
    '20180629   sykim   -       7시 > 8시 당일발송 변경.
    '20180723   hwkim   -       상품간략 설명이 없을 경우, 높이를 맞추기 위해 공백으로 표시
    '20180803   hwkim   1.0.3   상품등급 라벨 표시, 할인율 사각형스티커 변경, 장바구니 표시 축소, 흐리게 등
    '20180808   hwkim   -       건강식품 카테고리 추가 (고객센터 제외)
    '20180821   sykim   -       배송휴일의 전날과 당일은 당일발송 배너 제외기능 추가.
    '20180928   hwkim   -       배너 자동표시 임시처리. 후 지울것.
    '20181005   hwkim   1.0.4   할인상품 다양한 상품을 표시하기 위한 조작
    '20190103   hwkim   1.0.5   iOS 대응 webkit 객체 판단 처리 추가.
    '20190104   hwkim   1.0.6   자동로그인 시 fcm 파라미터 유지 처리 강화 적용.
    '20190124   hwkim   1.0.7   첫 화면 속도문제로 '할인중인 상품' 제거 (탭, 할인관에 있음)
    '20190128   hwkim   -       '할인중인 상품' 속도 개선 후 무작위 처리 다시 도입.
    '20190722   hwkim   -       중앙 '레시피' 아이콘, '멤버십안내'로 변경
    '20190828   hwkim   -       전문관을 기획전으로 대체(복원)
    '20200310   -       -       202003 리뉴얼 적용
    '20200713   hwkim   1.1     하단 바 적용, 앱전용 파라미터 추가
    '20200721   hwkim   1.1.1   세션처리 하단바 표시 제어-->
    
    <select id="swiperBannerInfo">
       /* swiperBannerInfo 스와이퍼 배너 정보*/
        SELECT ISNULL(url,'') url 
            , CASE WHEN ISNULL(img_src_m,'')='' THEN ISNULL(img_src,'')
                   ELSE img_src_m
              END img_src
        FROM ad_mainimg
         WHERE use_yn = 'Y'
           <![CDATA[
           AND sdate <= GETDATE()
           AND edate > GETDATE()
           ]]>
        ORDER BY ISNULL(important, 10), update_dt DESC, seq DESC
    </select>
    <select id="swiperBannerRenewal">
        /*swiperBannerRenewal 스와이퍼 배너 리뉴얼*/
        SELECT cbnpath01, cbntarget01, cbnurl01, lbntitle01, reservet01  /*'모바일상단 자연이랑NEW1(슬라이드)*/
             , cbnpath02, cbntarget02, cbnurl02, lbntitle02, reservet02  /*'모바일상단 자연이랑NEW2(슬라이드)*/
             , cbnpath03, cbntarget03, cbnurl03, lbntitle03, reservet03  /*'모바일상단 자연이랑NEW3(슬라이드)*/
             , cbnpath04, cbntarget04, cbnurl04  /*'모바일상단 고정배너1(슬라이드)*/
             , cbnpath05, cbntarget05, cbnurl05  /*'모바일상단 고정배너2(슬라이드)*/
             , cbnpath06, cbntarget06, cbnurl06  /*'모바일상단 고정배너2(슬라이드)*/
             , cbnpath07, cbntarget07, cbnurl07  /*'모바일상단 고정배너2(슬라이드)*/
             , tbnpath02, tbntarget02, tbnurl02  /*'모바일상단 고정배너3(슬라이드)*/
             , tbnpath03, tbntarget03, tbnurl03  /*'모바일상단 고정배너4(슬라이드)*/
        FROM mainpageskin
    </select>
    <select id="oneDaySpecial">
         /*oneDaySpecial 일일 특가*/
        SELECT os.idx
             , ISNULL(os.opt, 'S') opt 
             , os.gdcd 
             , g.gdname
             , g.div1
             , g.divcd 
             , g.mgdimg1 
             , CASE g.dispatchtype WHEN 'I' THEN '11' 
                                   WHEN 'O' THEN '15' 
               END odtype 
             , ISNULL(g.reserveyn,'N') reserveyn 
             , ISNULL(g.deliverydtyn,'N') deliverydtyn 
             , ISNULL(r.type, '01') odtype2 
             , g.price1
             , dbo.getProductPrice(#{strMEMGRPCD}, #{strGroupSalePolicy}, g.gdcd) saleprice 
             , os.gdname1
             , os.gdname2
             , os.gdlimit
        FROM oneday_special os
          JOIN gd_master g
            ON os.gdcd = g.gdcd
          LEFT JOIN od_reservegoods r
                 ON g.gdcd = r.gdcd
                AND r.useyn = 'Y'
                <![CDATA[
                AND DATEDIFF(D,CONVERT(DATETIME,r.od_from,120),GETDATE()) >= 0
                AND DATEDIFF(D,GETDATE(),CONVERT(DATETIME,r.od_to,120)) >= 0
                ]]>
         WHERE 1 = 1 
           AND os.target = 'O'
           <![CDATA[
           AND os.opt <> 'M' 
           AND GETDATE() >= startdt 
           AND GETDATE() <  enddt + 1
           ]]>
           AND g.useyn = 'Y' 
           AND (g.reserveyn = 'N' OR (g.reserveyn = 'Y' AND r.gdcd IS NOT NULL)) 
    </select>
    
    <select id="suggestionProd">
        /* suggestionProd 추천상품 리스트 Top8*/
        SELECT TOP 8 * 
          FROM ( 
                SELECT g.gdcd
                     , g.gdname
                     , g.unit
                     , g.price1
                     , g.gdimg
                     , g.divcd
                     , g.div1
                     , g.indt
                     , g.updt
                     , g.shortdesc 
                     , dbo.getProductPrice(#{strMEMGRPCD},#{strGroupSalePolicy},g.gdcd) saleprice 
                     , ISNULL(g.soldoutyn,'N') soldoutyn 
                     , ISNULL(g.newyn,'N') newyn
                     , ISNULL(g.qtysaleyn,'N') qtysaleyn
                     , ISNULL(s.gdcnt,99999) gdcnt 
                     , i.origin
                     , i.producer
                     , i.address
                     , ISNULL(t.cdname,'미지정') AS gradedesc
                     , g.mgdimg1 
                     , CASE g.dispatchtype WHEN 'I' THEN '11'
                                           WHEN 'O' THEN '15'
                       END odtype
                     , ISNULL(g.deliverydtyn,'N') deliverydtyn 
                     , ISNULL(g.reserveyn,'N') reserveyn 
                     , ISNULL(r.od_from,'') od_from
                     , ISNULL(r.od_to,'') od_to
                     , ISNULL(r.dlv_from,'') dlv_from
                     , ISNULL(r.dlv_to,'') dlv_to
                  FROM gd_master g 
                    LEFT JOIN gd_item i
                           ON i.gdcd = g.gdcd
                    LEFT JOIN cd_master t
                           ON t.cdtype = '09'
                          AND t.cdcode = i.typecd
                    LEFT JOIN gd_cnt s
                           ON g.gdcd = s.gdcd
                    LEFT JOIN od_reservegoods r
                           ON g.gdcd = r.gdcd
                          AND r.useyn = 'Y'
                          <![CDATA[
                          AND DATEDIFF(D,CONVERT(DATETIME,r.od_from,120),GETDATE()) >= 0
                          AND DATEDIFF(D,GETDATE(),CONVERT(DATETIME,r.od_to,120)) >= 0
                          ]]>
                  WHERE 1=1
                    AND g.useyn = 'Y'
                    AND (g.divcd = '30' OR (g.divcd='20'
                                            AND g.deliverydtyn = 'N'
                                            AND g.gdcd NOT IN ('A3','A4','A7','A8','B2','B3','C3','G9','H6','H9','P9','R6','R9','T1','T2','T3','Z02','Z21','Z22','Z25','Z26','Z94')
                                           )
                        )
                    AND g.recommendyn = 'Y'
                    AND ISNULL(s.gdcnt,99999) > 0
                    <![CDATA[
                    AND ISNULL(g.soldoutyn, 'N') <> 'Y'
                    ]]>
                    AND (g.reserveyn = 'N' OR (g.reserveyn = 'Y' AND r.gdcd IS NOT NULL))
               ) a 
         ORDER BY divcd, gdcd, ISNULL(updt,indt) DESC 
    </select>

    <select id="newProdList">
         /* newProdList 신상품 리스트 top8*/
        SELECT TOP 8 * 
        FROM ( 
               SELECT g.gdcd
                    , g.gdname
                    , g.unit
                    , g.price1
                    , g.gdimg
                    , g.mgdimg1
                    , g.divcd
                    , g.div1
                    , g.indt
                    , g.updt
                    , g.shortdesc 
                    , dbo.getProductPrice(#{strMEMGRPCD},#{strGroupSalePolicy},g.gdcd) saleprice 
                    , CASE WHEN ISNULL(g.soldoutyn,'N')='N' THEN 'N'
                           ELSE g.soldoutyn
                      END soldoutyn
                    , ISNULL(s.gdcnt,99999) gdcnt
                    , ISNULL(g.newyn,'N') newyn
                    , ISNULL(g.qtysaleyn,'N') qtysaleyn
                    , g.recommendyn 
                    , i.origin, i.producer, i.address, ISNULL(t.cdname,'미지정') AS gradedesc 
                    , CASE g.dispatchtype WHEN 'I' THEN '11'
                                          WHEN 'O' THEN '15'
                      END odtype
                    , ISNULL(g.deliverydtyn,'N') deliverydtyn 
                    , ISNULL(g.reserveyn,'N') reserveyn 
               FROM gd_master g
                 LEFT JOIN gd_item i
                        ON i.gdcd = g.gdcd
                 LEFT JOIN cd_master t
                        ON t.cdtype = '09'
                       AND t.cdcode = i.typecd
                 LEFT JOIN gd_cnt s
                        ON g.gdcd = s.gdcd
                 LEFT JOIN od_reservegoods r
                        ON g.gdcd = r.gdcd
                       AND r.useyn = 'Y'
                       <![CDATA[
                       AND DATEDIFF(D,CONVERT(DATETIME,r.od_from,120),GETDATE()) >= 0
                       AND DATEDIFF(D,GETDATE(),CONVERT(DATETIME,r.od_to,120)) >= 0
                       ]]>
                WHERE 1=1 
                  AND g.useyn = 'Y' 
                  AND (g.divcd = '30' OR (g.divcd = '20' 
                                          AND g.deliverydtyn = 'N' 
                                          AND g.gdcd NOT IN ('A3','A4','A7','A8','B2','B3','C3','G9','H6','H9','P9','R6','R9','T1','T2','T3','Z02','Z21','Z22','Z25','Z26','Z94') 
                                         ) 
                      ) 
                  AND g.newyn = 'Y'
                  <![CDATA[
                  AND ISNULL(s.gdcnt,99999) > 0 
                  AND ISNULL(g.soldoutyn, 'N') <> 'Y'
                  ]]>
                  AND (g.reserveyn = 'N' OR (g.reserveyn = 'Y' AND r.gdcd IS NOT NULL)) 
              ) a
        ORDER BY ISNULL(updt, indt) DESC
    </select>
    
    <select id="faqStoryTopFive">
        /*  faqStoryTopFive 자주묻는 질문 Top5*/
        SELECT TOP 5 ROW_NUMBER() OVER (ORDER BY ctsidx DESC) pagex 
             , ctsidx
             , title
        FROM bd_contents
         WHERE 1 = 1
           AND useyn = 'Y'
           AND ctscd = '05'
    </select>
    
    <select id="discountProdList">
        /* discountPordList 할인상품 목록*/
        SELECT TOP 8 *  FROM (
                               SELECT TOP 100 *
                               FROM (
                                      SELECT g.gdcd
                                           , g.gdname
                                           , g.unit
                                           , g.price1
                                           , g.gdimg
                                           , g.mgdimg1
                                           , g.divcd
                                           , g.div1
                                           , g.indt
                                           , g.updt
                                           , g.shortdesc
                                           , dbo.getProductPrice(#{strMEMGRPCD},#{strGroupSalePolicy},g.gdcd) saleprice
                                           , CASE WHEN ISNULL(g.soldoutyn,'N')='N' THEN 'N'
                                                  ELSE g.soldoutyn
                                             END soldoutyn
                                           , ISNULL(s.gdcnt,99999) gdcnt
                                           , ISNULL(g.newyn,'N') newyn
                                           , ISNULL(g.qtysaleyn,'N') qtysaleyn
                                           , i.origin
                                           , i.producer
                                           , i.address
                                           , ISNULL(t.cdname,'미지정') AS gradedesc
                                           , g.thedaysyn
                                           , CASE g.dispatchtype WHEN 'I' THEN '11'
                                                                 WHEN 'O' THEN '15'
                                             END odtype
                                           , ISNULLa(g.deliverydtyn,'N') deliverydtyn
                                           , ISNULL(g.reserveyn,'N') reserveyn
                                      FROM gd_master g
                                        LEFT JOIN gd_item i 
                                               ON i.gdcd = g.gdcd
                                        LEFT JOIN cd_master t 
                                               ON t.cdtype = '09' 
                                              AND t.cdcode = i.typecd
                                        LEFT JOIN gd_cnt s 
                                               ON g.gdcd = s.gdcd
                                        LEFT JOIN od_reservegoods r 
                                               ON g.gdcd = r.gdcd
                                              AND r.useyn = 'Y'
                                              <![CDATA[
                                              AND DATEDIFF(D,CONVERT(DATETIME,r.od_from,120),GETDATE()) >= 0
                                              AND DATEDIFF(D,GETDATE(),CONVERT(DATETIME,r.od_to,120)) >= 0
                                              ]]>
                                       WHERE 1=1
                                         AND g.useyn = 'Y'
                                         AND (g.divcd = '30' OR ( g.divcd='20'
                                                                  AND g.deliverydtyn = 'N'
                                                                  AND g.gdcd NOT IN ('A3','A4','A7','A8','B2','B3','C3','G9','H6','H9','P9','R6','R9','T1','T2','T3','Z02','Z21','Z22','Z25','Z26','Z94')
                                                                 )
                                             )
                                         AND (g.reserveyn = 'N' OR (g.reserveyn = 'Y' AND r.gdcd IS NOT NULL))
                                         AND g.saleflag IN ('P','S')
                                         <![CDATA[
                                         AND ISNULL(s.gdcnt,99999) > 0
                                         AND ISNULL(g.soldoutyn, 'N') <> 'Y'
                                         ]]>
                                    ) x
                                WHERE 1 = 1
                                <if test='customFilterProduct != "" '>
                                    AND x.gdcd NOT IN (#{customFilterProduct})
                                </if>
                             ) xx
                       WHERE 1 = 1
        ORDER BY newid()
    </select>
</mapper>