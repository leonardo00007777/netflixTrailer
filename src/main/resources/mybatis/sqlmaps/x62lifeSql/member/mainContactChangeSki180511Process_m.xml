<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="mainContactChangeSki180511Process">
<!--    'System        : 62life.com-->
<!--    'Program       :-->
<!--    'Title         : 실 사용자 연락처 업데이트 처리 ((SKI - 20180511, 모바일)-->
<!--    'File          : main_contact_change_ski180511_process_m.asp-->
<!--    'Program Type  : asp-->
<!--    'Analyst       :-->
<!--    'Author        : hyeok-->
<!--    'Date Started  : 20180514-->
<!--    'Last Modified :-->
<!--    'Called By     :-->
<!--    'Parameters    :-->
<!--    'Purpose       :-->
<!--    'Version       :-->
<!--    '-->
<!--    'Modified   Author  V/M     Reason For Modification-->

<!--    '20180514   hyeok   1.0     처음작성-->
    <select id="getPersonalInfo">
        /* getPersonalInfo 개인정보 불러오기*/
        SELECT CASE WHEN grpcd IN ('59','35','101','150','108','97')
                      THEN 'Y'
                    ELSE 'N'
               END targetgrp
        FROM mb_master
         WHERE memcd = #{strLoginMemCD}
    </select>

    <update id="updatePersonInfo" statementType="CALLABLE">
       /* updatePersonInfo 개인정보 업데이트*/
       {CALL encryptionOpen
        UPDATE mb_master
           SET hpno_enc = ENCRYPTBYKEY(KEY_GUID(#{encKeyName}), #{strHPNO})
           <if test="checkTypeHpNo != strHPNOOrig AND strHPNO != strHPNOOrig">
               , telno_enc = ENCRYPTBYKEY(KEY_GUID(#{encKeyName}), #{strHPNOOrig}) /*기존 HPNO를 TELNO로 업데이트 */
           </if>
             , hpno = #{date}  /*' 실 사용자 연락처 업데이트 이벤트 참여 여부 구분을 위해 hpno필드의 값 SKI/YYYY-MM-DD로 업데이트*/
             , smsyn = #{strSMSYN}
             , emailyn = #{strEmailYN}
             , updt = GETDATE()
             , updid = #{strLoginMemCD}
        <if test="strEmailYnOrig != strEmailYN">
            , emailynupdt = GETDATE()
        </if>
        <if test="strSmsYn_Orig != strSMSYN">
            , smsynupdt = GETDATE()
        </if>
         WHERE memcd = #{strLoginMemCD}
        CALL encryptionClose}
    </update>

    <insert id="personInfoChangeLog">
        INSERT INTO WWW62LIFE_CUSTINFO_LOG (
                                             ubwebsitecode
                                           , accessdatetime
                                           , fullurlpath
                                           , custidx
                                           , accessgubuncode
                                           , accessoripaddr
                                           , accessdesc
                                           )
        VALUES (
                 '62LIFEMN'
                 , GETDATE()
                 , '/member/member_modify.jsp'
                 , #{strLoginMemCD}
                 , 'U'
                 , #{ipx}
                 , '2018_SKI계열_정보업데이트이벤트'
               )
    </insert>
</mapper>