<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="searchIdResult">
<!--    '프로젝트: 자연이랑 모바일 웹-->
<!--    '프로그램: 아이디 찾기-->

<!--    '20170306   sykim   처음작성-->
    <select id="getDiValue">
        /* getDiValue 1차 본인인증 유일값(DI) 으로 회원찾기 */
        SELECT COUNT(memcd) memcnt
        FROM mb_master
         WHERE pcert_di = #{strPidNo}
    </select>

    <select id="getMemberId">
        /*
           getMemberId
           intMemCnt = 1
           1차 본인인증 유일값(DI) 으로 회원이 있다면 나타내고 종료
           */
        SELECT memid
             , CONVERT(CHAR(7),indt,120) indt
        FROM mb_master
         WHERE pcert_di = #{strPidNo}
    </select>

    <select id="searchMemberByName" statementType="CALLABLE">
       /*
          searchMemberByName
          1차 본인인증값으로 회원이 없을 경우,
          2차 성명, 생년월일, 성별로 검색.
       */
       {CALL encryptionOpen
        SELECT memcd
             , memid
             , CONVERT(CHAR(7),indt,120) indt
        FROM mb_master
        WHERE memname = #{strMemName}
          AND CONVERT(VARCHAR(24),DECRYPTBYKEY(residentno1_enc)) = #{strResidentNo1}
          AND gender = #{strGender}
        CALL encryptionClose}
    </select>

    <update id="diValueUpdate">
       /*
        diValueUpdate
        2차 성명, 생년월일, 성별로 검색으로 아이디가 하나 나왔다면
        본인인증 유일값(DI)을 업데이트
       */
        UPDATE mb_master
        SET pcert_reqno = #{strReqNo}
          , pcert_di = #{strPidNo}
         WHERE memcd = #{strMemCd}
    </update>
</mapper>