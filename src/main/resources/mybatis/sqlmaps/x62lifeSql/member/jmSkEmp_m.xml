<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="jmSkEmp">
<!--    'System        : m.62life.com-->
<!--    'Program       :-->
<!--    'Title         : 자연이랑모바일 - SK구성원 가입 - 이름, 사번, 이메일 확인.-->
<!--    'File          : jm_skauth_m.asp-->
<!--    'Program Type  : asp-->
<!--    'Analyst       :-->
<!--    'Author        : sykim-->
<!--    'Date Started  : 20190222-->
<!--    'Last Modified :-->
<!--    'Called By     :-->
<!--    'Parameters    :-->
<!--    'Purpose       :-->
<!--    'Version       :-->
<!--    '-->
<!--    'Modified   Author  V/M     Reason For Modification-->

<!--    '20190222   sykim   0.9     처음 작성-->
<!--    '20200514   sykim   0.9.1   SK고객사는 신규 입사자의 사번으로 된 이메일로 정보르 주는데 당사자가 한 번 변경할 수 있음, 변경된 이메일은 알 수 없음.-->
<!--    '                           텔레콤에서 이슈제기를 해 입사시 등록된 휴대전화로 이름, 사번, 휴대전화로 구성원인증을 할 수 있도록 추가함.-->
<!--    '20200611   sykim   0.9.2   인증정보가 부정확할 경우 경고내용을 jm_sk_emp_m.asp 에서 나타나도록 수정.-->

    <select id="getSkEmployee" statementType="CALLABLE">
       {CALL encryptionOpen
        SELECT m.memcd
             , e.grpcd
             , e.gradecd
        FROM mb_grpemp e
          LEFT JOIN mb_master m ON e.grpcd = m.grpcd
                               AND e.empnum = m.empnum
         WHERE e.empnum = #{strEmpNum}
           AND e.empname = #{strEmpName}
           AND CONVERT(VARCHAR(40),DECRYPTBYKEY(e.email_enc)) = #{strEmail}
        CALL encryptionClose}
    </select>

    <select id="getSkEmployeeByNameAndPhone" statementType="CALLABLE">
       {CALL encryptionOpen
        SELECT CONVERT(VARCHAR(14)
             , DECRYPTBYKEY(hpno_enc)) hpno
        FROM mb_grpemp
         WHERE empnum = #{strEmpNum}
           AND empname = #{strEmpName}
        CALL encryptionClose}
    </select>
    <update id="skEmpConfirmLog" statementType="CALLABLE">
        /*
        strJoinType = "SK"
         rCount = 0
         confirmLog '인증 후 소속사사원 정보도 승인된 자료를 남김.
        */
       {CALL encryptionOpen
        UPDATE mb_grpemp
        SET joinyn = 'Y'
        WHERE grpcd =  #{insertGroupCode}
          AND gradecd = #{insertGradeCode}
          AND empnum = #{strEmpNum}
          AND (CONVERT(VARCHAR(40),DECRYPTBYKEY(email_enc)) = #[strEmail}
            OR CONVERT(VARCHAR(14),DECRYPTBYKEY(hpno_enc)) = #{strHpNo})
          AND (CASE WHEN ISNULL(joinyn,'')='' THEN 'N' ELSE joinyn END) = 'N'
            CALL encryptionClose}
    </update>

    <select id="getFirstAuthPoint">
        /*
          '개인별 부여 포인트가 존재하면 개인별 포인트를 처음 부여함.
            If lngInitPoint > 0
         getFirstAuthPoint '초기인증 포인트적립은 해당연도에 1번만 부여받도록 재검증처리 후 포인트 부여(20101228
        */
        SELECT COUNT(1) xCount
        FROM mb_point
        WHERE YEAR(indt) = YEAR(GETDATE())
          AND rscd = '01'
          AND memcd = #{strMemCd}
    </select>
    <update id="skEmpUpdateRecommenderPoint">
        /* updateRecommenderPoint 재 가입 등 처리 시 기존 정보를 지우지 않을 것을 고려하여 UPDATE 과정을 넣음*/
        UPDATE recommender_table
        SET rmemid = #{strRmemid}
          , rmemcd = #{strRmemcd}
        WHERE memcd = #{strMemCd}
    </update>
    <insert id="addRecommender">
        /* addRecommender 최초 가입 승인일 경우, 추천인정보 추가*/
        INSERT INTO recommender_table (
                                        memcd
                                      , rmemid
                                      , rmemcd
                                      , grpcd
                                      , indt
                                      , rreward
                                      )
                VALUES (
                         #{strMemCd}
                       , #{strRmemid}
                       , #{strRmemcd}
                       , #{groupNormal}
                       , GETDATE()
                       , 'N'
                      )
    </insert>
</mapper>