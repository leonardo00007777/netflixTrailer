<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="memberPwdModify">
<!--    '프로젝트: 자연이랑 모바일 웹-->
<!--    '프로그램: 비밀번호 변경 프로세스-->

<!--    '20170302   sykim   처음작성-->
<!--    '20170314   hwkim   레이아웃 변경 및 로그 아웃 후 이전 페이지 지정-->
<!--    '20190708   sykim   비밀번호 설정제한을 Server-Side에서 다시 검사하는 과정을 추가.-->
<!--    '20190916   sykim   비밀번호 SHA함수 변경(dbo.UBHASHFunc 대신 HASHBYTES('SHA2_256'.. 함수 사용).-->
    <select id="getOldPassword">
        /*getOldPassword 이전 비밀전호 가져오기*/
        SELECT CASE WHEN mempw_hash = CONVERT(VARCHAR(1000),HASHBYTES('SHA2_256',#{strMemOldPW}),2)
                      Then 'Y'
                    ELSE 'N'
               END passyn
        FROM mb_master
        WHERE memcd = #{strLoginMemCD}
    </select>
    
    <update id="changePassword">
        /* changePassword 새 비밀번호 update*/
        UPDATE mb_master
        SET mempw_hash = CONVERT(VARCHAR(1000),HASHBYTES('SHA2_256',#{strMemNewPW}),2)
          , updt = GETDATE()
          , updid = #{strLoginMemID}
        WHERE memcd = #{strLoginMemCD}
    </update>

    <update id="changePasswordTimeHistoryUpdate">
        /* changePasswordTimeHistoryUpdate 비밀번호 변경이력 업데이트*/
        UPDATE changefieldhistory
           SET date_mempw = GETDATE()
         WHERE memcd = #{strLoginMemCD}
    </update>

    <insert id="changePasswordTimeHistoryInsert">
         /*changePasswordTimeHistoryInsert 비밀번호 변경 이력이 없을 경우 Insert*/
        INSERT INTO changefieldhistory(
                                        memcd
                                      , memid
                                      , date_mempw
                                      )
               VALUES (
                        #{strLoginMemCD}
                      , #{strLoginMemID}
                      , GETDATE()
                      )
    </insert>

    <update id="loginHistoryUpdate">
        /*loginHistoryUpdate 로그인 히스토리 업데이트 */
        UPDATE logininfo
           SET last_logout = GETDATE()
             , islogin = 0
         WHERE memcd = #{memcd}
    </update>

    <insert id="loginHistoryInsert">
        /* loginHistoryInsert 로그인 히스토리가 없을 경우 새로 Insert*/
        INSERT INTO logininfo(
                               memcd
                             , last_login
                             , last_logout
                             , islogin
                             , login_count
                             )
               VALUES (
                        #{memcd}
                      , ''
                      , GETDATE()
                      , 0
                      , 1
                      )
    </insert>
</mapper>