<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="memberModifyProc">
<!--    '프로젝트: 자연이랑 모바일 웹-->
<!--    '프로그램: 회원정보 수정 프로세스-->

<!--    '20170302   sykim   처음작성-->
<!--    '20170314   hwkim   레이아웃 변경 및 로그 아웃 후 이전 페이지 지정-->
<!--    '20180213   hyeok   SMS > 알림톡 변경 적용 (lib.database.asp 필수)-->
    <update id="updateMemberInfo" statementType="CALLABLE">
        /* updateMemberInfo 회원정보 업데이트*/
        {CALL encryptionOpen
        UPDATE mb_master
        SET email_enc = ENCRYPTBYKEY(KEY_GUID(#{encKeyName}),#{strEmail})
          , emailyn = #{strEmailYN}
          , zipcd = #{strZipCD}
          , addr1_enc = ENCRYPTBYKEY(KEY_GUID(#{encKeyName}),N#{strAddr1})
          , addr2_enc = ENCRYPTBYKEY(KEY_GUID(#{encKeyName}),N#{strAddr2})
          , telno_enc = ENCRYPTBYKEY(KEY_GUID(#{encKeyName}),#{strTelNO})
          , hpno_enc = ENCRYPTBYKEY(KEY_GUID(#{encKeyName}),#{strHPNO})
          , smsyn = #{strSMSYN}
          , telyn = #{strTelYn}
          , updt = GETDATE()
          , updid = #{strLoginMemCD}
          <if test="strEmailYnOrig != strEmailYN">
              , emailynupdt = GETDATE()
          </if>
          <if test="strEmailYnOrig != strSMSYN">
              , smsynupdt = GETDATE()
          </if>
         WHERE memcd = #{strLoginMemCD}
        CALL encryptionClose}
    </update>
    <insert id="changeMemberInfoLog">
         /*changeMemberInfoLog 변경이력 기록*/
        INSERT INTO WWW62LIFE_CUSTINFO_LOG (
                                             ubwebsitecode
                                           , accessdatetime
                                           , fullurlpath
                                           , custidx
                                           , accessgubuncode
                                           , accessoripaddr
                                           , accessdesc
                                           )
               VALUES (
                        '62LIFEMN'
                       , GETDATE()
                       , '/member/member_modify.jsp'
                       , #{strLoginMemCD}
                       , 'U'
                       , #{ipx}
                       , '회원정보수정'
                       )
    </insert>

    <update id="updateLoginLog">
        /*updateLoginLog 로그아웃 처리 시각 업데이트*/
        UPDATE logininfo
        SET last_logout = GETDATE()
          , islogin = 0
        WHERE memcd = #{memcd}
    </update>

    <insert id="firstLoginLogInsert">
        /*firstLoginLogInsert 첫 로그인 유저 정보 Insert*/
        INSERT INTO logininfo(
                               memcd
                             , last_login
                             , last_logout
                             , islogin
                             , login_count
                             )
               VALUES (
                        #{memcd}
                      , ''
                      , GETDATE()
                      , 0
                      , 1
                      )
    </insert>
</mapper>