<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="searchPwdEmailSend">
<!--    '프로젝트: 자연이랑 모바일 웹-->
<!--    '프로그램: 비밀번호 찾기 - 이메일 보내기-->

<!--    '20170306   sykim   처음작성-->
<!--    '20190916   sykim   비밀번호 SHA함수 변경(dbo.UBHASHFunc 대신 HASHBYTES('SHA2_256'.. 함수 사용).-->
    <select id="getMemberEmail" statementType="CALLABLE">
       {CALL encryptionOpen
        SELECT memid
             , memname
             , CONVERT(VARCHAR(40),DECRYPTBYKEY(email_enc)) email
        FROM mb_master
         WHERE memcd = #{strMemCd}
          <![CDATA[
           AND memstcd <= #{memstUp}
          ]]>
        CALL encryptionClose}
    </select>

    <select id="getNewId">
        /*getNewId 8자리 숫자,영문 조합 가져오기*/
        SELECT TOP 1 LEFT(NEWID(),8) ranval
    </select>
    <update id="updateNewPassword">
        /* updateNewPassword 새로운 비밀번호로 설정*/
        UPDATE mb_master
           SET mempw_hash = CONVERT(VARCHAR(1000),HASHBYTES('SHA2_256',#{strMemPw}),2)
        WHERE memcd = #{strMemCd}
    </update>

    <update id="unlockAccount">
        /* unlockAccount 계정잠김 해제*/
        UPDATE logininfo
        SET islocked = 0
          , login_failed_count = 0
        WHERE memcd = #{strMemCd}
    </update>
</mapper>