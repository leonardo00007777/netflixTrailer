<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.x62life.mo.dao.main.MainDao">
<!--    'System        : m.62life.com-->
<!--    'Program       :-->
<!--    'Title         : 자연이랑모바일 - 추천 상품 페이지 단위로 가져오기-->
<!--    'File          : get_new_list_m.asp-->
<!--    'Program Type  : asp-->
<!--    'Analyst       :-->
<!--    'Author        : hwkim-->
<!--    'Date Started  : 20161118-->
<!--    'Last Modified :-->
<!--    'Called By     :-->
<!--    'Parameters    :-->
<!--    'Purpose       :-->
<!--    'Version       :-->
<!--    '-->
<!--    'Modified   Author  V/M     Reason For Modification-->
<!--    '20161118   hwkim   0.9     처음 작성-->
<!--    '20170202   hwkim   0.9.1   업체 직배송 상품 담기 적용-->
<!--    '20170213   hwkim   0.9.2   옵션 상품 표시 제외 처리-->
<!--    '20170329   hwkim   0.9.3   할인 가격 표시 변경-->
<!--    '20170420   hwkim   0.9.4   당일발송 주문 담기 처리 추가. / thedaysyn-->
<!--    '20170613   hwkim   0.9.5   당일발송 주문 담기 처리 제외 (1차범위)-->
<!--    '20180112   hwkim   0.9.6   화면크기에 따른 2열 디자인 적용-->
<!--    '20180621   hyeok   -&#45;&#45;     표시대상 상품 조건에 세트유형(20) 추가-->
<!--    '20180803   hwkim   0.9.7   상품등급 라벨 표시, 할인율 사각형스티커 변경 등-->

<!--추천상품-->
    <sql id="getRecommendListCommon">
        SELECT '' odtype
             , g.gdcd
             , g.gdname
             , g.unit
             , g.price1
             , g.gdimg
             , g.divcd
             , g.div1
             , g.indt
             , g.updt
             , g.shortdesc
             , dbo.getProductPrice(#{strMEMGRPCD}, #{strGroupSalePolicy}, g.gdcd) saleprice
             , CASE WHEN ISNULL(g.soldoutyn,'N')='N' THEN 'N' ELSE g.soldoutyn END soldoutyn
             , ISNULL(g.newyn,'N') newyn
             , ISNULL(g.qtysaleyn,'N') qtysaleyn
             , CASE WHEN ISNULL(g.deliverydtyn,'')='' THEN 'N' ELSE g.deliverydtyn END deliverydtyn
             , ISNULL(s.gdcnt,99999) gdcnt
             , '01' odtype2
             , i.origin
             , i.producer
             , i.address
             , ISNULL(t.cdname,'미지정') AS gradedesc
             , g.mgdimg1
             , g.thedaysyn
        FROM gd_master g
          LEFT JOIN gd_item i ON i.gdcd = g.gdcd
          LEFT JOIN cd_master t ON t.cdtype = '09'
                               AND t.cdcode = i.typecd
          LEFT JOIN gd_cnt s ON g.gdcd = s.gdcd
         WHERE 1=1
           AND g.useyn = 'Y'
           AND g.divcd = '30'
           AND (g.divcd = '30' OR ( g.divcd='20'
                                    AND g.deliverydtyn = 'N'
                                    AND g.gdcd NOT IN ('A3','A4','A7','A8','B2','B3','C3','G9','H6','H9','P9','R6','R9','T1','T2','T3','Z02','Z21','Z22','Z25','Z26','Z94')
                                  )
               )
           AND g.recommendyn = 'Y'
        UNION ALL
        SELECT '12' odtype
             , r.gdcd
             , r.gdnm gdname
             , r.unit
             , r.apply_price price1
             , m.gdimg
             , r.divcd
             , r.divcd1 div1
             , r.indt
             , r.updt
             , m.shortdesc
             , dbo.getProductPrice(#{strMEMGRPCD}, #{strGroupSalePolicy}, r.gdcd) saleprice
             , CASE WHEN ISNULL(soldoutyn,'N')='N' THEN 'N' ELSE soldoutyn END soldoutyn
             , ISNULL(m.newyn,'N') newyn
             , 'N' qtysaleyn
             , CASE WHEN ISNULL(m.deliverydtyn,'')='' THEN 'N' ELSE m.deliverydtyn END deliverydtyn
             , ISNULL(s.gdcnt,99999) gdcnt
             , r.type odtype2
             , i.origin
             , i.producer
             , i.address
             , ISNULL(t.cdname,'미지정') AS gradedesc
             , m.mgdimg1
        FROM od_reservegoods r
          LEFT JOIN gd_master m ON r.gdcd = m.gdcd
          LEFT JOIN gd_item i ON i.gdcd = m.gdcd
          LEFT JOIN cd_master t ON t.cdtype = '09'
                               AND t.cdcode = i.typecd
          LEFT JOIN gd_cnt s ON r.gdcd = s.gdcd
         WHERE r.useyn = 'Y'
         <![CDATA[
           AND r.od_from <= CONVERT(VARCHAR,GETDATE(),23)
           AND r.od_to >= CONVERT(VARCHAR,GETDATE(),23)
         ]]>
           AND r.recommandyn = 'Y'
    </sql>

    <select id="getRecommendListPaging" resultType="java.util.Map">
        SELECT CEILING( CAST(COUNT(1) AS FLOAT)/#{intPagePerItem} ) maxPage
             , COUNT(gdcd) CNT
        FROM (
                 SELECT * FROM (
                                <include refid="getRecommendListCommon"/>
                               ) a
             ) x
    </select>

    <select id="getRecommendProdList" parameterType="java.util.Map" resultType="com.x62life.mo.model.product.GdMasterEx">
        SELECT *
        FROM (
               SELECT FLOOR((ROW_NUMBER() OVER ( ORDER BY indt DESC ) - 1 ) / #{intPagePerItem} + 1) AS page
                    , x.*
               FROM (
                      <include refid="getRecommendListCommon"/>
                    ) x
             ) AS pl
         WHERE page = #{intPage}
        ORDER BY divcd, gdcd, ISNULL(updt, indt) DESC
    </select>
</mapper>