<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.x62life.mo.dao.category.CategoryDao">
<!--    'System        : m.62life.com-->
<!--    'Program       :-->
<!--    'Title         : 자연이랑모바일 - 상품 페이지 단위로 가져오기-->
<!--    'File          : get_item_list_m.asp-->
<!--    'Program Type  : asp-->
<!--    'Analyst       :-->
<!--    'Author        : hwkim-->
<!--    'Date Started  : 20170124-->
<!--    'Last Modified :-->
<!--    'Called By     :-->
<!--    'Parameters    :-->
<!--    'Purpose       :-->
<!--    'Version       :-->
<!--    '-->
<!--    'Modified   Author  V/M     Reason For Modification-->
<!--    '20170124   hwkim   0.9     처음 작성 - 옵션 상품 목록 제외 처리-->
<!--    '20170314   hwkim   0.9.1   정렬기능 추가-->
<!--    '20170329   hwkim   0.9.3   할인 가격 표시 변경-->
<!--    '20170420   hwkim   0.9.3   당일발송 주문 담기 처리 추가. / thedaysyn-->
<!--    '20170613   hwkim   0.9.5   당일발송 주문 담기 처리 제외 (1차범위)-->
<!--    '20180114   hwkim   0.9.6   상품표시 레이아웃 개선-->
<!--    '20180706   hyeok   -       직거래 상품 표시 버그 수정-->
<!--    '20180803   hwkim   0.9.7   상품등급 라벨 표시, 할인율 사각형스티커 변경 등-->
<!--    '20180808   hwkim   0.9.8   신속, 업체직송 표시 통합-->
<!--    '20180905   hwkim   0.9.9   카테고리 두개 통합 지정 기능 추가 - ','로 구분-->
<!--    '20181023   hwkim   1.0.0   상품명 표시 특수문자에 의한 분리규칙 추가-->
<!--    '20190927   hwkim   1.1     상품 정렬조건에 '판매량 순' 추가-->
<!--    '20200224   chhyeon -       정확도 순에서 판매량 순으로 기본값 변경, 파라미터 변경-->
<!--    '20200324   sykim   1.1.1   상품정보 단일화(gd_master & od_reservegoods > gd_master) 적용.-->
<!--    '고객그룹별 특정상품 제한 처리-->
<!--    SP_CUSTOMER_GROUP = SK_CHEMICALS-->
<!--    SP_PRODUCT = "'Y31','Y32','Y33','Y34','Y35'"-->

<!--    '2018추석 특정고객사대상상품 필터링-->
<!--    EXCEPT_PRODUCT = "'Y51','Y52','Y53','Y54'"-->

<!--    '하나은행VIP(아이센스) 대상상품 필터링-->
<!--    ISENS_EXCEPT_PRODUCT = "'B11','B12','B13','B14'"-->

<!--    '사용자 정의 필터링 상품 - 첫구매(2019)이벤트 상품, 5월휴면고객특가-->
<!--    CUSTOM_FILTER_PRODUCT = "'43042719','91073305','05020034','99701120','1010000011','1010000031'"-->

<!--    '리스팅 모드가 OPT 일 경우, 옵션 상품은 목록에 표시하지 않는다.-->
<!--    LISTING_MODE = "OPT"-->
    <sql id="prodSearchCommon">
     /*prodSearchCommon 상품조회 공통*/
        SELECT a.*
        FROM (
               SELECT g.gdcd
                    , gdname
                    , g.gdimg
                    , g.gdimg2
                    , g.gdimg3
                    , g.gdimg4
                    , g.mgdimg1
                    , g.dispatchtype
                    , g.priceyn
                    , ISNULL(g.qtysaleyn,'N') qtysaleyn
                    , g.price1
                    , dbo.getMasterPrice(g.gdcd) saleprice
                    , dbo.getProductPrice(#{strMEMGRPCD}, #{strGroupSalePolicy}, g.gdcd) groupsaleprice
                    , dbo.getIsGroupSaleGoods(#{strMEMGRPCD}, #{strGroupSalePolicy}, g.gdcd) isgroupsale
                    , g.div1
                    , g.div2
                    , g.divcd
                    , ISNULL(s.gdcnt,99999) gdcnt
                    , g.minqty
                    , g.maxqty
                    , g.shortdesc
                    , ISNULL(t.cdname,'미정') AS typename
                    , ISNULL(g.recommendyn,'N') recommendyn
                    , ISNULL(g.newyn,'N') newyn
                    , ISNULL(g.deliverydtyn,'N') deliverydtyn
                    , ISNULL(g.thedaysyn,'N') thedaysyn
                    , ISNULL(g.soldoutyn,'N') soldoutyn
                    , CONVERT(CHAR(10),g.plandate,120) plandate
                    , ISNULL(g.reserveyn,'N') reserveyn
                    , c.cdcode
                    , c.cdname
                    , m.smenucd
                    , m.smenudesc
                    , g.explain
                    , g.unit
                    , i.address
                    , i.origin
                    , i.producer
                    , ISNULL(r.od_from,'') odFrom
                    , ISNULL(r.od_to,'') odTo
                    , ISNULL(r.dlv_from,'') dlvFrom
                    , ISNULL(r.dlv_to,'') dlvTo
                    , CASE WHEN ISNULL(r.packunit,'') = '' THEN '' ELSE r.packunit END packunit
                    , g.expdt
                    , g.vat
                    , g.limitdelivery
                    , g.bestbeforedate
                    , g.packaging
                    , g.handling
                    , g.precaution1
                    , g.precaution2
                    , g.importnote
                    , g.addinformation
                    , g.testidx
                    , g.optionp
                    , g.updt
                    , g.subgdcd1
                    , g.subgdcd2
                    , g.subgdcd3
                    , g.subgdcd4
                    , g.subgdcd5
                    , CASE g.dispatchtype WHEN 'I' THEN '11' WHEN 'O' THEN '15' END odtype
                    , CASE WHEN r.type IS NOT NULL THEN r.type ELSE '01' END odtype2
                    , g.scode
                    , g.suprice
                    , g.exdiv1
                    , g.exdiv2
               FROM gd_master g
                 LEFT JOIN cd_master c
                        ON c.cdtype = '20'
                       AND c.cdcode = g.div1
                       AND c.useyn = 'Y'
                 LEFT JOIN gd_item i
                        ON i.gdcd = g.gdcd
                 LEFT JOIN cd_master t
                        ON t.cdtype = '09'
                       AND t.cdcode = i.typecd
                 LEFT JOIN gd_cnt s
                        ON g.gdcd = s.gdcd
                 LEFT JOIN od_reservegoods r
                        ON g.gdcd = r.gdcd
                       AND r.useyn = 'Y'
                       <![CDATA[
                       AND DATEDIFF(D,CONVERT(DATETIME,r.od_from,120),GETDATE()) >= 0
                       AND DATEDIFF(D,GETDATE(),CONVERT(DATETIME,r.od_to,120)) >= 0
                       ]]>
                 LEFT JOIN submenu m
                        ON m.category = g.div1
                       AND sub_category LIKE '%'+ g.div2 + '%'
                WHERE 1=1
                  AND g.useyn = 'Y'
                  AND (g.divcd = '30' OR (g.divcd = '20'
                                          AND g.deliverydtyn = 'N'
                                          AND g.gdcd NOT IN ('A3','A4','A7','A8','B2','B3','C3','G9','H6','H9','P9','R6','R9','T1','T2','T3','Z02','Z21','Z22','Z25','Z26','Z94')
                                         )
                      )
                  AND (g.reserveyn = 'N' OR (g.reserveyn = 'Y' AND r.gdcd IS NOT NULL))
                <if test="strExDiv1 != ''">
                  AND g.gdcd IN (SELECT gdcd FROM gd_master
                                              WHERE useyn = 'Y'
                                                AND exdiv1 = #{strExDiv1}
                                              <if test="strExDiv2 != ''">
                                                AND exdiv2 = #{strExDiv2}
                                              </if>
                                 UNION
                                 SELECT gdcd FROM gd_another_category
                                              WHERE div1 = #{strExDiv1}
                                              <if test="strExDiv2 != ''">
                                                AND exdiv2 = #{strExDiv2}
                                              </if>
                </if>
                                )
                <if test="listingMode == 'OPT'">
                  AND ISNULL(g.optionp,'N') = 'N'
                </if>
                <if test='strMEMGRPCD == "" or strMEMGRPCD.indexOf("219") lte 0'>
                    AND g.gdcd NOT IN
                    <foreach collection="isensExceptProduct" item="isensExceptProduct"  open="(" separator="," close=")">
                        #{isensExceptProduct}
                    </foreach>
                </if>
             ) a
    </sql>
    
    <select id="itemListtargetDate" >
        /*targetDate 특정 날짜
            targetDate1 2020-06-18
          , targetDate2 2020-06-27
          , targetDate3 2020-06-26
          , targetDate4 2020-07-06
          */
        SELECT DateDiff("D", #{targetDate}, SYSDATETIME())
    </select>

    <select id="getItemListSubmenu" parameterType="java.util.Map" resultType="java.lang.String">
        /* getItemListSubmenu 서브메뉴*/
        SELECT subcatdesc
        FROM exsubmenu
         WHERE cat1 = #{strExDiv1}
           AND cat2 = #{strExDiv2}
    </select>

    <select id="itemListPaging">
        /* getItemListPaging 상품 페이징*/
        SELECT COUNT(gdcd) CNT
        FROM (
                 SELECT g.gdcd
                      , CASE g.dispatchtype
                            WHEN 'I'
                                THEN '11'
                            WHEN 'O'
                                THEN '15'
                     END odtype
                 FROM gd_master g
                   LEFT JOIN od_reservegoods r
                          ON g.gdcd = r.gdcd
                         AND r.useyn = 'Y'
                         <![CDATA[
                         AND DATEDIFF(D, CONVERT(DATETIME, r.od_from, 120), GETDATE()) >= 0
                         AND DATEDIFF(D, GETDATE(), CONVERT(DATETIME, r.od_to, 120)) >= 0
                        ]]>
                  WHERE 1 = 1
                   AND g.useyn = 'Y'
                   AND (g.divcd = '30' OR (g.divcd = '20'
                                           AND g.deliverydtyn = 'N'
                                           AND g.gdcd NOT IN ('A3', 'A4', 'A7', 'A8', 'B2', 'B3', 'C3', 'G9', 'H6', 'H9', 'P9', 'R6', 'R9', 'T1', 'T2','T3', 'Z02', 'Z21', 'Z22', 'Z25', 'Z26', 'Z94')
                                          )
                       )
                   AND (g.reserveyn = 'N' OR (g.reserveyn = 'Y' AND r.gdcd IS NOT NULL))
                   <if test="strExDiv1 != ''">
                       AND g.gdcd IN (SELECT gdcd FROM gd_master
                                                   WHERE useyn = 'Y'
                                                     AND exdiv1 =  #{strExDiv1}
                                                   <if test="strExDiv2 != ''">
                                                       AND exdiv2 = #{strExDiv2}
                                                   </if>
                                      UNION
                                      SELECT gdcd FROM gd_another_category
                                                   WHERE div1 = #{strExDiv1}
                                                   <if test="strExDiv2 != ''">
                                                     AND exdiv2 = #{strExDiv2}
                                                   </if>
                                     )
                   </if>
                   <if test="listingMode == 'OPT'">
                       AND ISNULL(g.optionp,'N') = 'N'
                   </if>
                   <if test='strMEMGRPCD == "" or strMEMGRPCD.indexOf("219") lte 0'>
                       AND g.gdcd NOT IN
                       <foreach collection="isensExceptProduct" item="isensExceptProduct"  open="(" separator="," close=")">
                           #{isensExceptProduct}
                       </foreach>
                   </if>
            ) a
         WHERE 1=1
         <if test="strMEMGRPCD == '' or userDefinedTarget.indexOf(strMEMGRPCD) lte 0">
             AND a.gdcd NOT IN (SELECT slgdcd FROM specialsellingl where slidx=468)
         </if>
         <if test="strMEMGRPCD == '' or userDefinedTarget2.indexOf(strMEMGRPCD) lte 0">
             AND a.gdcd NOT IN (SELECT slgdcd FROM specialsellingl WHERE slidx = 641)
         </if>
        <if test=" 0 lte targetDate1 and targetDete2 lte 0">
            <if test="strMEMGRPCD == '' or strMEMGRPCD.indexOf(userDefinedTarget) lte 0">
                AND g.gdcd NOT IN (SELECT slgdcd FROM specialsellingl WHERE slidx = 784)
            </if>
        </if>
        <if test="0 lte targetDate3 and targetDate4 lte 0">
            <if test="strMEMGRPCD == '' or userDefinedTarget.indexOf(strMEMGRPCD) lte 0">
                AND g.gdcd NOT IN (SELECT slgdcd FROM specialsellingl WHERE slidx = 792)
            </if>
        </if>
        <if test="strMEMGRPCD == '' or userDefinedTarget.indexOf(strMEMGRPCD) lte 0 ">
            AND g.gdcd NOT IN (SELECT slgdcd FROM specialsellingl WHERE slidx = 836)
        </if>
        <if test="customFilterProduct != null and customFilterProduct != '' ">
            AND a.gdcd NOT IN
            <foreach collection="customFilterProduct" item="customFilterProduct" open="(" separator="," close=")" >
                 (#{customFilterProduct})
            </foreach>
        </if>
        <if test="strOdtype != '' ">
            AND a.odtype = #{strOdtype}
        </if>
    </select>

    <select id="searchProdAll" parameterType="java.util.Map" resultType="com.x62life.mo.model.product.GdMasterEx">
       /*searchProdAll 상품 전체*/
       <include refid="prodSearchCommon"/>
       <if test="orderBy == ''">
           LEFT JOIN ( SELECT k.gdcd
                            , RANK() OVER (ORDER BY k.gdprice DESC) yrank
                            , RANK() OVER (ORDER BY k.gdsum DESC) xrank
                        FROM (
                              SELECT gdcd
                                   , SUM(price*gdcnt) gdprice
                                   , SUM(gdcnt) gdsum
                                FROM od_goods
                               WHERE indt >= DATEADD(d, -7 ,getdate())
                                 <![CDATA[
                                 AND indt <= GETDATE()
                                 ]]>
                               GROUP BY gdcd
                              ) k
                     ) z ON z.gdcd = a.gdcd
       </if>
        WHERE 1=1
        <if test="strMEMGRPCD == '' or userDefinedTarget.indexOf(strMEMGRPCD) lte 0">
            AND a.gdcd NOT IN (SELECT slgdcd FROM specialsellingl where slidx=468)
        </if>
        <if test="strMEMGRPCD == '' or userDefinedTarget2.indexOf(strMEMGRPCD) lte 0">
            AND a.gdcd NOT IN (SELECT slgdcd FROM specialsellingl WHERE slidx = 641)
        </if>
        <if test=" 0 lte targetDate1 and targetDete2 lte 0">
            <if test="strMEMGRPCD == '' or strMEMGRPCD.indexOf(userDefinedTarget) lte 0">
                AND g.gdcd NOT IN (SELECT slgdcd FROM specialsellingl WHERE slidx = 784)
            </if>
        </if>
        <if test="0 lte targetDate3 and targetDate4 lte 0">
            <if test="strMEMGRPCD == '' or strMEMGRPCD.indexOf(userDefinedTarget) lte 0">
                AND g.gdcd NOT IN (SELECT slgdcd FROM specialsellingl WHERE slidx = 792)
            </if>
        </if>
        <if test="strMEMGRPCD == '' or strMEMGRPCD.indexOf(userDefinedTarget) lte 0 ">
            AND g.gdcd NOT IN (SELECT slgdcd FROM specialsellingl WHERE slidx = 836)
        </if>
        <if test="customFilterProduct != '' ">
            AND a.gdcd NOT IN
            <foreach collection="customFilterProduct" item="customFilterProduct" open="(" separator="," close=")" >
                (#{customFilterProduct})
            </foreach>
        </if>
        <choose>
            <when test="orderBy == 'PD'">
                ORDER BY groupsaleprice DESC
            </when>
            <when test="orderBy == 'PU'">
                ORDER BY groupsaleprice
            </when>
            <when test="orderBy == 'PP' ">
                ORDER BY (dbo.getProductPrice(#{strMEMGRPCD}, #{strGroupSalePolicy}, gdcd)/price1), gdcd
            </when>
            <when test="orderBy == 'PN' ">
                ORDER BY gdname
            </when>
            <when test="orderBy == 'PA' ">
                ORDER BY exdiv1, exdiv2, gdcd
            </when>
            <otherwise>
                ORDER BY ISNULL(xrank,99999), exdiv1, exdiv2, gdcd
            </otherwise>
        </choose>
        OFFSET #{intPageOffset} ROWS
        FETCH NEXT #{intPagePerItem} ROWS ONLY
    </select>
</mapper>